<!doctype html public "-//W30//DTD W3 HTML 2.0//EN">

<HTML>

<!-- This file was generated using SDF 2.001 by
     Ian Clatworthy (ianc@mincom.com). SDF is freely
     available from http://www.mincom.com/mtr/sdf. -->

<HEAD>
<TITLE>Life with qmail</TITLE>
</HEAD>
<BODY BGCOLOR="ffffff" LINK="ff0000" VLINK="0000ff">

<DIV CLASS="header">
<DIV CLASS="navigate">
</DIV>
</DIV>
<DIV CLASS="title">
<P><IMG SRC="logo-small.png" ALIGN="Right"></P>
<H1 CLASS="doc-title">Life with qmail</H1>
<ADDRESS CLASS="doc-author">Dave Sill</ADDRESS>
<ADDRESS CLASS="doc-modified">30 November 2007</ADDRESS>
<BR CLEAR="All">
</DIV>
<DIV CLASS="contents">
<HR>
<H2>Table of Contents</H2>
<UL>
<A HREF="#introduction">1. Introduction</A><UL>
<A HREF="#audience">1.1. Audience</A>
<BR>
<A HREF="#whatitis">1.2. What is <I>qmail</I>?</A>
<BR>
<A HREF="#whyuseit">1.3. Why use <I>qmail</I>?</A>
<BR>
<A HREF="#history">1.4. History</A>
<BR>
<A HREF="#features">1.5. Features</A>
<BR>
<A HREF="#related-packages">1.6. Related packages</A>
<BR>
<A HREF="#architecture">1.7. Architecture</A>
<BR>
<A HREF="#license">1.8. License</A>
<BR>
<A HREF="#comparison">1.9. Comparison with other MTA's</A>
<BR>
<A HREF="#documentation">1.10. Documentation</A>
<BR>
<A HREF="#support">1.11. Support</A></UL>
<BR>
<A HREF="#installation">2. Installation</A><UL>
<A HREF="#installation-issues">2.1. Installation Issues</A>
<BR>
<A HREF="#preparation">2.2. Preparation</A>
<BR>
<A HREF="#system-requirements">2.3. System requirements</A>
<BR>
<A HREF="#download">2.4. Download the source</A>
<BR>
<A HREF="#build">2.5. Build the source</A>
<BR>
<A HREF="#install-ucspi">2.6. Install ucspi-tcp</A>
<BR>
<A HREF="#install-daemontools">2.7. Install daemontools</A>
<BR>
<A HREF="#start-qmail">2.8. Start <I>qmail</I></A>
<BR>
<A HREF="#test">2.9. Test the Installation</A></UL>
<BR>
<A HREF="#configuration">3. Configuration</A><UL>
<A HREF="#config-files">3.1. Configuration Files</A>
<BR>
<A HREF="#relaying">3.2. Relaying</A>
<BR>
<A HREF="#multiple-hostnames">3.3. Multiple host names</A>
<BR>
<A HREF="#virtual-domains">3.4. Virtual domains</A>
<BR>
<A HREF="#aliases">3.5. Aliases</A>
<BR>
<A HREF="#qmail-users">3.6. qmail-users</A>
<BR>
<A HREF="#spam">3.7. Spam Control</A>
<BR>
<A HREF="#viruses">3.8. Virus Scanning</A></UL>
<BR>
<A HREF="#usage">4. Usage</A><UL>
<A HREF="#dot-qmail-files">4.1. <TT>.qmail</TT> files</A>
<BR>
<A HREF="#sending-messages">4.2. Sending messages</A>
<BR>
<A HREF="#environment-variables">4.3. Environment Variables</A></UL>
<BR>
<A HREF="#advanced-topics">5. Advanced Topics</A><UL>
<A HREF="#procmail">5.1. <I>procmail</I></A>
<BR>
<A HREF="#pop-imap-servers">5.2. POP and IMAP servers</A>
<BR>
<A HREF="#pop-imap-clients">5.3. POP and IMAP clients</A>
<BR>
<A HREF="#multi-rcpt">5.4. Multi-RCPT vs. Single RCPT delivery</A>
<BR>
<A HREF="#verp">5.5. VERP</A>
<BR>
<A HREF="#troubleshooting">5.6. Troubleshooting</A>
<BR>
<A HREF="#big-servers">5.7. Big Servers</A>
<BR>
<A HREF="#migrating-to-qmail">5.8. Migrating from <I>Sendmail</I> to <I>qmail</I></A>
<BR>
<A HREF="#mailing-list-managers">5.9. Mailing List Managers</A>
<BR>
<A HREF="#patches">5.10. Patches</A>
<BR>
<A HREF="#qmtp">5.11. QMTP</A>
<BR>
<A HREF="#smtp-reject">5.12. Rejecting Invalid Recipients During SMTP Dialogue</A>
<BR>
<A HREF="#TLS">5.13. TLS and STARTTLS</A></UL>
<BR>
<A HREF="#acknowledgments">A. Acknowledgments</A>
<BR>
<A HREF="#related-packages">B. Related Packages</A><UL>
<A HREF="#dot-forward">B.1. <I>dot-forward</I></A>
<BR>
<A HREF="#fastforward">B.2. <I>fastforward</I></A>
<BR>
<A HREF="#ucspi-tcp">B.3. <I>ucspi-tcp</I></A>
<BR>
<A HREF="#daemontools">B.4. <I>daemontools</I></A>
<BR>
<A HREF="#qmailanalog">B.5. <I>qmailanalog</I></A>
<BR>
<A HREF="#rblsmtpd">B.6. <I>rblsmtpd</I></A>
<BR>
<A HREF="#serialmail">B.7. <I>serialmail</I></A>
<BR>
<A HREF="#mess822">B.8. <I>mess822</I></A>
<BR>
<A HREF="#ezmlm">B.9. <I>ezmlm</I></A>
<BR>
<A HREF="#safecat">B.10. <I>safecat</I></A>
<BR>
<A HREF="#djbdns">B.11. <I>djbdns</I></A>
<BR>
<A HREF="#maildrop">B.12. <I>maildrop</I></A>
<BR>
<A HREF="#syncdir">B.13. <I>syncdir</I></A></UL>
<BR>
<A HREF="#how-mail-works">C. How Internet Mail Works</A><UL>
<A HREF="#from-a-to-b">C.1. How a message gets from point A to point B</A>
<BR>
<A HREF="#more-information">C.2. More information</A></UL>
<BR>
<A HREF="#architecture-apdx">D. Architecture</A><UL>
<A HREF="#modular">D.1. Modular system architecture</A>
<BR>
<A HREF="#file-structure">D.2. File structure</A>
<BR>
<A HREF="#queue-structure">D.3. Queue structure</A>
<BR>
<A HREF="#pictures">D.4. Pictures</A></UL>
<BR>
<A HREF="#IAQ">E. Infrequently Asked Questions</A><UL>
<A HREF="#retry-schedule">E.1. How frequently does qmail try to send deferred messages?</A>
<BR>
<A HREF="#dns-problem">E.2. Why can't I send mail to a large site with lots of MX's?</A>
<BR>
<A HREF="#queue_extra">E.3. What is <TT>QUEUE_EXTRA</TT>?</A></UL>
<BR>
<A HREF="#error-messages">F. Error Messages</A>
<BR>
<A HREF="#gotchas">G. Gotchas</A><UL>
<A HREF="#root-delivery">G.1. <I>qmail</I> doesn't deliver mail to superusers.</A>
<BR>
<A HREF="#home-dir-ownership">G.2. <I>qmail</I> doesn't deliver mail to users who don't own their home directory.</A>
<BR>
<A HREF="#uppercase-usernames">G.3. <I>qmail</I> doesn't deliver mail to users whose usernames contain uppercase letters.</A>
<BR>
<A HREF="#dots-in-extensions">G.4. <I>qmail</I> replaces dots (.) in extension addresses with colons (:).</A>
<BR>
<A HREF="#uppercase-in-extensions">G.5. <I>qmail</I> converts uppercase characters in extension addresses to lowercase.</A>
<BR>
<A HREF="#etc-hosts">G.6. <I>qmail</I> doesn't use <TT>/etc/hosts</TT>.</A>
<BR>
<A HREF="#no-smtp-logging">G.7. <I>qmail</I> doesn't log SMTP activity.</A>
<BR>
<A HREF="#deferral-notices">G.8. <I>qmail</I> doesn't generate deferral notices.</A>
<BR>
<A HREF="#trigger">G.9. <I>qmail</I> is slow if <TT>/var/qmail/queue/lock/trigger</TT> is gone/has the wrong permissions/is a regular file.</A>
<BR>
<A HREF="#smtp-slow">G.10. DNS or IDENT lookups can make SMTP slow.</A>
<BR>
<A HREF="#cr">G.11. Carriage Return/Linefeed (CRLF) line breaks don't work.</A>
<BR>
<A HREF="#log-block">G.12. <TT>qmail-send</TT> or <TT>tcpserver</TT> stop working if logs back up.</A>
<BR>
<A HREF="#smtp-rejection">G.13. <TT>qmail-smtpd</TT> doesn't validate the local part of an address.</A>
<BR>
<A HREF="#firewalls">G.14. Firewalls can block remote access to your SMTP/POP3/IMAP server.</A>
<BR>
<A HREF="#anonymous">G.15. <TT>qmail-inject</TT> sets <TT>From</TT> field to <TT>anonymous</TT> if <TT>USER</TT> and <TT>LOGNAME</TT> aren't set.</A>
<BR>
<A HREF="#killing-qmail-send">G.16. <TT>qmail-send</TT> doesn't always exit immediately when killed.</A>
<BR>
<A HREF="#throwing-messages-away">G.17. Delivering to <TT>/dev/null</TT> doesn't throw messages away.</A>
<BR>
<A HREF="#modifying-queue">G.18. Modifying the queue while <TT>qmail-send</TT> is running is <I>dangerous</I>.</A></UL>
<BR>
<A HREF="#lwq-faq">H. Frequently Asked Questions about <U>Life with qmail</U></A><UL>
<A HREF="#lwq-version">H.1. What version is <U>Life with qmail</U>?</A>
<BR>
<A HREF="#lwq-copyright">H.2. Who owns <U>Life with qmail</U>?</A>
<BR>
<A HREF="#lwq-license">H.3. How is <U>Life with qmail</U> licensed?</A>
<BR>
<A HREF="#lwq-announce-list">H.4. How can I be notified when new releases of LWQ are made available?</A>
<BR>
<A HREF="#lwq-list">H.5. Where can LWQ contributors and fans talk about it?</A>
<BR>
<A HREF="#lwq-translations">H.6. Has <U>Life with qmail</U> been translated to <I>language</I>?</A>
<BR>
<A HREF="#lwq-formats">H.7. Is <U>Life with qmail</U> available in PostScript, PDF, plain text, or any other format beside HTML?</A>
<BR>
<A HREF="#lwq-warranty">H.8. I used <U>Life with qmail</U> and it crashed my system/erased my hard disk/ruined my love life/killed my dog/etc.</A>
<BR>
<A HREF="#contributions">H.9. How can I contribute to LWQ?</A>
<BR>
<A HREF="#changes">H.10. What's changed in this version of LWQ?</A></UL></UL>
</DIV>
<DIV CLASS="main">
<HR>
<H1><A NAME="introduction">1. Introduction</A></H1>
<H2><A NAME="audience">1.1. Audience</A></H2>
<P><U>Life with qmail</U> is aimed at everyone interested in running <I>qmail</I>, from the rank amateur (<I>newbie</I>) who just installed Linux on a spare PC all the way up to the experienced system administrator or mail administrator. If you find it lacking or unclear, please let me know. Send comments to <A HREF="mailto:lwq@sill.org">lwq@sill.org</A>.</P>
<P>There's a wealth of information available on <I>qmail</I> from a variety of sources. Some is targeted to newbies, some assumes that the reader is more experienced. <U>Life with qmail</U> is an attempt to &quot;glue&quot; this information into a single source, filling in some of the cracks and assuming only that the reader has basic skills such as:</P>
<UL>
<LI>Manipulating files/directories under UNIX
<LI>Operating a web browser or FTP client
<LI>Following directions</UL>
<H2><A NAME="whatitis">1.2. What is <I>qmail</I>?</A></H2>
<P><I>qmail</I> is an Internet Mail Transfer Agent (MTA) for UNIX-like operating systems. It's a drop-in replacement for the <I>Sendmail</I> system provided with UNIX operating systems. <I>qmail</I> uses the Simple Mail Transfer Protocol (SMTP) to exchange messages with MTA's on other systems.</P>
<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG>The name is &quot;qmail&quot;, not &quot;Qmail&quot;.
<HR WIDTH="80%" ALIGN="Left"></P>
<H2><A NAME="whyuseit">1.3. Why use <I>qmail</I>?</A></H2>
<P>Your operating system included an MTA, probably <I>Postfix</I> or <I>Sendmail</I>, so if you're reading this document you're probably looking for something different. Some of the advantages of <I>qmail</I> over vendor-provided MTA's include:</P>
<H3><A NAME="security">1.3.1. Security</A></H3>
<P><I>qmail</I> was designed for high security. <I>Sendmail</I> has a long history of serious security problems. When <I>Sendmail</I> was written, the Net was a much friendlier place. Everyone knew everyone else, and there was little need to design and code for high security. Today's Internet is a much more hostile environment for network servers. <I>Sendmail</I>'s author, Eric Allman, and the current maintainer, Claus Assman, have done a good job of tightening up the program, but nothing short of a redesign can achieve <I>true</I> security.</P>
<H3><A NAME="performance">1.3.2. Performance</A></H3>
<P><I>qmail</I> parallelizes mail delivery, performing up to 20 deliveries simultaneously, by default.</P>
<H3><A NAME="reliability">1.3.3. Reliability</A></H3>
<P>Once <I>qmail</I> accepts a message, it guarantees that it won't be lost. <I>qmail</I> also supports a new mailbox format that works reliably <I>even over NFS</I> without locking.</P>
<H3><A NAME="simplicity">1.3.4. Simplicity</A></H3>
<P><I>qmail</I> is smaller than any other equivalently-featured MTA.</P>
<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG>The official <I>qmail</I> web page, <A HREF="http://cr.yp.to/qmail.html">http://cr.yp.to/qmail.html</A> covers the advantages of <I>qmail</I> more extensively.
<HR WIDTH="80%" ALIGN="Left"></P>
<H2><A NAME="history">1.4. History</A></H2>
<P><I>qmail</I> was written by Dan Bernstein (DJB), <A HREF="http://en.wikipedia.org/wiki/Daniel_J._Bernstein">http://en.wikipedia.org/wiki/Daniel_J._Bernstein</A>, a math professor now at the University of Illinois in Chicago. Dr. Bernstein is also well known for his work in the field of cryptography and for his lawsuit against the U.S. government regarding the publishing of encryption source code. See <A HREF="http://en.wikipedia.org/wiki/Bernstein_v._United_States">http://en.wikipedia.org/wiki/Bernstein_v._United_States</A> or <A HREF="http://cr.yp.to/export.html">http://cr.yp.to/export.html</A> for information regarding the lawsuit.</P>
<P>The first public release of <I>qmail</I>, beta version 0.70, occurred on January, 24, 1996. The first gamma release, 0.90, was on August, 1, 1996.</P>
<P>Version 1.0, the first general release, was announced on February, 20, 1997. The current version, 1.03, was released on June, 15, 1998.</P>
<P>The next release is expected to be an evaluation version of 2.0. Some of things that might appear in version 2 are covered at <A HREF="http://cr.yp.to/qmail/future.html">http://cr.yp.to/qmail/future.html</A>.</P>
<H2><A NAME="features">1.5. Features</A></H2>
<P>The <I>qmail</I> web page, <A HREF="http://cr.yp.to/qmail.html">http://cr.yp.to/qmail.html</A>, has a comprehensive list of <I>qmail</I>'s features. This section is based heavily on that list.</P>
<H3><A NAME="feature-setup">1.5.1. Setup</A></H3>
<UL>
<LI>Automatic adaptation to your UNIX variant--no porting needed
<LI>Automatic per-host configuration
<LI>Quick installation--no big list of decisions to make</UL>
<H3><A NAME="feature-security">1.5.2. Security</A></H3>
<UL>
<LI>Clear separation between addresses, files, and programs
<LI>Minimization of setuid code
<LI>Minimization of root code
<LI>Five-way trust partitioning--security in depth
<LI>Optional logging of one-way message hashes, entire message contents, etc. (See <A HREF="#queue_extra">What is QUEUE_EXTRA?</A> in Appendix E.)</UL>
<H3><A NAME="feature-messcon">1.5.3. Message construction</A></H3>
<UL>
<LI><A HREF="#rfcs">RFC 822</A> and <A HREF="#rfcs">RFC 1123</A> compliant
<LI>Full support for address groups
<LI>Automatic conversion of old-style address lists to RFC 822 format
<LI><TT>sendmail</TT> command for compatibility with current user agents
<LI>Header line length limited only by memory
<LI>Host masquerading (See <A HREF="#defaulthost">defaulthost)</A>
<LI>User masquerading (See <A HREF="#MAILUSER">MAILUSER</A> and <A HREF="#MAILHOST">MAILHOST</A>)
<LI>Automatic Mail-Followup-To creation (See <A HREF="#QMAILMFTFILE">QMAILMFTFILE</A>)</UL>
<H3><A NAME="feature-smtpserv">1.5.4. SMTP service</A></H3>
<UL>
<LI><A HREF="#rfcs">RFC 821, RFC 1123, RFC 1651, RFC 1652, and RFC 1854</A> compliant
<LI>8-bit clean
<LI><A HREF="#rfcs">RFC 931/1413</A>/ident/TAP callback--can help track spammers/forgers
<LI>Relay control--stops unauthorized relaying by outsiders
<LI>No interference between relay control and aliases
<LI>Automatic recognition of local IP addresses
<LI>Per-buffer timeouts
<LI>Hop counting
<LI>Parallelism limit (via <A HREF="#ucspi-tcp">ucspi-tcp</A>)
<LI>Refusal of connections from known abusers (via <A HREF="#ucspi-tcp">ucspi-tcp</A>)
<LI>Relaying and message rewriting for authorized clients
<LI>Optional RBL/ORBS support (via <A HREF="#rblsmtpd">rblsmtpd</A>)</UL>
<H3><A NAME="feature-queueman">1.5.5. Queue management</A></H3>
<UL>
<LI>Instant handling of messages added to queue
<LI>Parallelism limits
<LI>Split queue directory--no slowdown when queue gets big
<LI>Quadratic retry schedule--old messages tried less often (see <A HREF="#retry-schedule">Appendix E</A>)
<LI>Independent message retry schedules
<LI>Automatic safe queueing--no loss of mail if system crashes
<LI>Automatic per-recipient checkpointing
<LI>Automatic queue cleanups
<LI>Queue viewing (See <TT>qmail-qread</TT>)
<LI>Detailed delivery statistics (via <A HREF="#qmailanalog">qmailanalog</A>)</UL>
<H3><A NAME="feature-bounces">1.5.6. Bounces</A></H3>
<UL>
<LI>QSBMF bounce messages--both machine-readable and human-readable
<LI>HCMSSC support--language-independent <A HREF="#rfcs">RFC 1893</A> error codes
<LI>Double bounces sent to postmaster</UL>
<H3><A NAME="feature-routing">1.5.7. Routing by domain</A></H3>
<UL>
<LI>Any number of names for local host (See <A HREF="#locals">locals</A>)
<LI>Any number of virtual domains (See <A HREF="#virtualdomains">virtualdomains</A>)
<LI>Domain wildcards (See <A HREF="#virtualdomains">virtualdomains</A>)
<LI>Configurable &quot;percent hack&quot; support (See <A HREF="#percenthack">percenthack</A>)
<LI>UUCP hook</UL>
<H3><A NAME="feature-smtpdeliv">1.5.8. SMTP delivery</A></H3>
<UL>
<LI><A HREF="#rfcs">RFC 821, RFC 974, and RFC 1123</A> compliant
<LI>8-bit clean
<LI>Automatic downed host backoffs
<LI>Artificial routing--smarthost, localnet, mailertable (See <A HREF="#smtproutes">smtproutes</A>)
<LI>per-buffer timeouts
<LI>Passive SMTP queue--perfect for SLIP/PPP (via <A HREF="#serialmail">serialmail</A>)
<LI>AutoTURN support (via <A HREF="#serialmail">serialmail</A>)</UL>
<H3><A NAME="feature-forwardlists">1.5.9. Forwarding and mailing lists</A></H3>
<UL>
<LI><I>Sendmail</I> <TT>.forward</TT> compatibility (via <A HREF="#dot-forward">dot-forward</A>)
<LI>Hashed forwarding databases (via <A HREF="#fastforward">fastforward)</A>
<LI><I>Sendmail</I> <TT>/etc/aliases</TT> compatibility (via <A HREF="#fastforward">fastforward</A>)
<LI>Address wildcards (See <A HREF="#extension-addresses">.qmail-default</A>)
<LI>Mailing list owners--automatically divert bounces and vacation messages
<LI>VERPs--automatic recipient identification for mailing list bounces
<LI>Delivered-To--automatic loop prevention, even across hosts</UL>
<H3><A NAME="feature-localdeliv">1.5.10. Local delivery</A></H3>
<UL>
<LI>User-controlled address hierarchy--fred controls fred-anything mbox delivery
<LI>Reliable NFS delivery (See <A HREF="#maildir-delivery">maildir</A>)
<LI>User-controlled program delivery: procmail etc. (See <A HREF="#program-delivery">qmail-command</A>)
<LI>Optional new-mail notification (See qbiff)
<LI>Optional NRUDT return receipts (See qreceipt)
<LI>Conditional filtering (See condredirect and bouncesaying)</UL>
<H3><A NAME="feature-pop3">1.5.11. POP3 service</A></H3>
<UL>
<LI><A HREF="#rfcs">RFC 1939</A> compliant
<LI>UIDL support
<LI>TOP support
<LI>APOP hook
<LI>modular password checking (via <A HREF="http://www.qmail.org/top.html#checkpassword">checkpassword</A>)</UL>
<H2><A NAME="related-packages">1.6. Related packages</A></H2>
<P><I>qmail</I> follows the classic UNIX philosophy that each tool should perform a single, well-defined function, and complex functions should be built by connecting a series of simple tools into a &quot;pipeline&quot;. The alternative is to build more and more complex tools that re-invent much of the functionality of the simpler tools.</P>
<P>It's not surprising, then, that <I>qmail</I> itself doesn't do everything everyone might want it to do. Here, then, are some of the most popular add-ons written for <I>qmail</I>. Of course, many standard UNIX utilities can also be plugged into <I>qmail</I>.</P>
<UL>
<LI><A HREF="#dot-forward">dot-forward</A>--a <I>Sendmail</I> <TT>.forward</TT> file compatibility add-on
<LI><A HREF="#fastforward">fastforward</A>--a <I>Sendmail</I> alias database compatibility add-on
<LI><A HREF="#ucspi-tcp">ucspi-tcp</A>--an <I>inetd</I> replacement
<LI><A HREF="#daemontools">daemontools</A>--a set of tools for managing daemons and their logs
<LI><A HREF="#qmailanalog">qmailanalog</A>--a set of qmail log file analysis tools
<LI><A HREF="#serialmail">serialmail</A>--tools for mailing over slow networks
<LI><A HREF="#mess822">mess822</A>--tools for parsing Internet mail messages
<LI><A HREF="#ezmlm">ezmlm</A>--a mailing list manager for <I>qmail</I></UL>
<H2><A NAME="architecture">1.7. Architecture</A></H2>
<P><A HREF="#architecture-apdx">Appendix D</A> covers <I>qmail</I>'s functional and physical structure. In a nutshell, <I>qmail</I> consists of a series of programs (modules) that perform different tasks.</P>
<H2><A NAME="license">1.8. License</A></H2>
<P>As of 2007-11-30, <I>qmail</I> 1.03 is in the public domain. See <A HREF="http://cr.yp.to/qmail/dist.html">http://cr.yp.to/qmail/dist.html</A>. This means that there are no legal limits to what you can do with it: you can copy it, give it away, sell it, modify it, rename it, or use pieces of it in copy-protected works, without any restrictions.</P>
<P>Other packages by Dan Bernstein, such as <I>daemontools</I> and <I>ucspi-tcp</I>, are copyrighted by the author, and are not distributed with a statement of user's rights. In <A HREF="http://cr.yp.to/softwarelaw.html">http://cr.yp.to/softwarelaw.html</A>, he outlines what he thinks your rights are under U.S. copyright law. See also <A HREF="http://en.wikipedia.org/wiki/License-free_software">http://en.wikipedia.org/wiki/License-free_software</A>.</P>
<H2><A NAME="comparison">1.9. Comparison with other MTA's</A></H2>
<P>A book could be written about this topic, but it would be tedious reading. Here's a quick comparison of <I>qmail</I> with some of the most common UNIX MTA's.</P>
<TABLE CLASS="columns" BORDER>
<TR CLASS="heading">
<TD>
<STRONG>MTA</STRONG>
</TD>
<TD>
<STRONG>Maturity</STRONG>
</TD>
<TD>
<STRONG>Security</STRONG>
</TD>
<TD>
<STRONG>Features</STRONG>
</TD>
<TD>
<STRONG>Performance</STRONG>
</TD>
<TD>
<STRONG>Sendmailish</STRONG>
</TD>
<TD>
<STRONG>Modular</STRONG>
</TD>
</TR>
<TR>
<TD>
<I>qmail</I>
</TD>
<TD>
medium
</TD>
<TD>
high
</TD>
<TD>
high
</TD>
<TD>
high
</TD>
<TD>
addons
</TD>
<TD>
yes
</TD>
</TR>
<TR>
<TD>
<I>Sendmail</I>
</TD>
<TD>
high
</TD>
<TD>
low
</TD>
<TD>
high
</TD>
<TD>
low
</TD>
<TD>
x
</TD>
<TD>
no
</TD>
</TR>
<TR>
<TD>
<I>Postfix</I>
</TD>
<TD>
medium
</TD>
<TD>
high
</TD>
<TD>
high
</TD>
<TD>
high
</TD>
<TD>
yes
</TD>
<TD>
yes
</TD>
</TR>
<TR>
<TD>
<I>exim</I>
</TD>
<TD>
medium
</TD>
<TD>
low
</TD>
<TD>
high
</TD>
<TD>
medium
</TD>
<TD>
yes
</TD>
<TD>
no
</TD>
</TR>
<TR>
<TD>
<I>Courier</I>
</TD>
<TD>
low
</TD>
<TD>
medium
</TD>
<TD>
high
</TD>
<TD>
medium
</TD>
<TD>
optional
</TD>
<TD>
yes
</TD>
</TR>
</TABLE>

<P><I>Sendmailish</I> means the MTA behaves like <I>Sendmail</I> in some ways that would make a switch from <I>Sendmail</I> to the alternative MTA more user-transparent, such as the use of <TT>.forward</TT> files, <TT>/etc/aliases</TT>, and delivery to <TT>/var/spool/mail</TT>.</P>
<P>Jonathan de Boyne Pollard has reviews of many Unix MTAs at <A HREF="http://homepages.tesco.net/~J.deBoynePollard/Reviews/UnixMTSes/">http://homepages.tesco.net/~J.deBoynePollard/Reviews/UnixMTSes/</A>. Another detailed comparison is available at <A HREF="http://www.geocities.com/mailsoftware42/">http://www.geocities.com/mailsoftware42/</A>.</P>
<H2><A NAME="documentation">1.10. Documentation</A></H2>
<H3><A NAME="man-pages">1.10.1. man pages</A></H3>
<P>The <I>qmail</I> distribution comes with a complete set of <TT>man</TT> pages. After installation, they're in <TT>/var/qmail/man</TT>. You'll probably need to add that directory to your <TT>MANPATH</TT> environment variable.</P>
<TABLE CLASS="columns" BORDER>
<TR CLASS="heading">
<TD>
<STRONG>Shell</STRONG>
</TD>
<TD>
<STRONG>Command</STRONG>
</TD>
</TR>
<TR>
<TD>
Bourne (/bin/sh)
</TD>
<TD>
<TT>MANPATH=$MANPATH:/var/qmail/man; export MANPATH</TT>
</TD>
</TR>
<TR>
<TD>
bash, Korn
</TD>
<TD>
<TT>export MANPATH=$MANPATH:/var/qmail/man</TT>
</TD>
</TR>
<TR>
<TD>
C Shell
</TD>
<TD>
<TT>setenv MANPATH $MANPATH:/var/qmail/man</TT>
</TD>
</TR>
</TABLE>

<P>At this point, commands in the format &quot;<TT>man <I>name-of-qmail-man-page</I></TT>&quot; should display the appropriate man page.</P>
<P>The <TT>man</TT> pages are also available on-line in HTML format from:</P>
<UL>
<LI><A HREF="http://www.qmail.org/man/index.html">http://www.qmail.org/man/index.html</A></UL>
<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG>The <I>qmail</I> man pages are loaded with information, but they require careful reading because they're written in a very dense, technical style. You might want to print off a set and read them through once to familiarize yourself with what's there and where it is. Very little information is repeated on multiple pages, so if you don't know where something is covered, it can be hard to find it.
<HR WIDTH="80%" ALIGN="Left"></P>
<H3><A NAME="docs">1.10.2. Docs</A></H3>
<P>The <I>qmail</I> distribution includes a series of documents that are installed under <TT>/var/qmail/doc</TT>. They include:</P>
<UL>
<LI><TT>FAQ</TT>: Frequently Asked Questions, with answers
<LI><TT>INSTALL*</TT>: Installation documentation
<LI><TT>PIC.*</TT>: Descriptions of how <I>qmail</I> performs key tasks. See the <A HREF="#pictures">Architecture</A> appendix for more information.
<LI>Various other installation-related documentation</UL>
<P>These docs are also available on-line from:</P>
<UL>
<LI><A HREF="http://www.qmail.org/man/index.html">http://www.qmail.org/man/index.html</A></UL>
<H3><A NAME="faqs">1.10.3. FAQs</A></H3>
<P>There are two official FAQ (Frequently Asked Questions, with answers) documents:</P>
<UL>
<LI><TT>/var/qmail/doc/FAQ</TT>, the plain text version, and
<LI>The web FAQ at <A HREF="http://cr.yp.to/qmail/faq.html">http://cr.yp.to/qmail/faq.html</A>.</UL>
<P>The web FAQ is more complete.</P>
<H3><A NAME="book">1.10.4. Books</A></H3>
<H4><A NAME="qmail-handbook">1.10.4.1. <U>The qmail Handbook</U></A></H4>
<P>Dave Sill, the author of <U>Life with qmail</U>, has written a <I>qmail</I> book for Apress (<A HREF="http://www.apress.com/">http://www.apress.com/</A>). This book, <U>The qmail Handbook</U>, covers everything in this guide, but goes into much more detail and also covers a lot of new ground.</P>
<P>For more information, see <A HREF="http://www.apress.com/catalog/book/1893115402/">http://www.apress.com/catalog/book/1893115402/</A>. To order this book from my bookstore, in association with Amazon.com, see <A HREF="http://www.amazon.com/exec/obidos/ASIN/1893115402/davesill">http://www.amazon.com/exec/obidos/ASIN/1893115402/davesill</A>.</P>
<H4><A NAME="quickstarter">1.10.4.2. <U>Qmail Quickstarter: Install, Set Up and Run your own Email Server</U></A></H4>
<P>Kyle Wheeler has written a <I>qmail</I> book for Packt (<A HREF="http://www.packtpub.com/">http://www.packtpub.com/</A>). As the title suggests, this book is designed to help people new to <I>qmail</I> to set up a mail server.</P>
<P>To order this book from my bookstore, in association with Amazon.com, see <A HREF="http://www.amazon.com/exec/obidos/ASIN/1847191150/davesill">http://www.amazon.com/exec/obidos/ASIN/1847191150/davesill</A>.</P>
<H4><A NAME="oreilly-book">1.10.4.3. <U>qmail</U></A></H4>
<P>John Levine has written a <I>qmail</I> book for O'Reilly &amp; Associates (<A HREF="http://www.oreilly.com/">http://www.oreilly.com/</A>). See <A HREF="http://qmail.gurus.com/">http://qmail.gurus.com/</A> for more info including the Table of Contents and a sample chapter.</P>
<P>To order this book from my bookstore, in association with Amazon.com, see <A HREF="http://www.amazon.com/exec/obidos/ASIN/1565926285/davesill">http://www.amazon.com/exec/obidos/ASIN/1565926285/davesill</A>.</P>
<H4><A NAME="sams-book">1.10.4.4. <U>Running qmail</U></A></H4>
<P>Richard Blum has written <U>Running qmail</U>, which is published by Sams. This book has received mixed reviews on the <I>qmail</I> mailing list.</P>
<P>For more information or to order this book, see <A HREF="http://www.amazon.com/exec/obidos/ASIN/0672319454/davesill">http://www.amazon.com/exec/obidos/ASIN/0672319454/davesill</A>.</P>
<H4><A NAME="U&lt;qmail: Yuksek Performansli E-Posta Sunucu&gt;">1.10.4.5. <U>qmail: Yuksek Performansli E-Posta Sunucu</U></A></H4>
<P>Ismail Yenigul, et al, have written a Turkish-language <I>qmail</I> book. See <A HREF="http://www.acikakademi.com/catalog/qmail/">http://www.acikakademi.com/catalog/qmail/</A>.</P>
<H3><A NAME="list-archives">1.10.5. List archives</A></H3>
<P>The <I>qmail</I> e-mail mailing list, maintained by Dan Bernstein, is a valuable source of information. Web archives of the lists messages are kept at:</P>
<UL>
<LI><A HREF="http://www.ornl.gov/lists/mailing-lists/qmail/">http://www.ornl.gov/lists/mailing-lists/qmail/</A>.
<LI><A HREF="http://tech.groups.yahoo.com/group/djb-qmail/?refstop=1">http://tech.groups.yahoo.com/group/djb-qmail/?refstop=1</A> and
<LI><A HREF="http://securepoint.com/lists/html/Qmail/">http://securepoint.com/lists/html/Qmail/</A>.</UL>
<P>Most questions about <I>qmail</I> can be answered by searching the list archives first.</P>
<H3><A NAME="other-web-sites">1.10.6. Other Web Sites</A></H3>
<UL>
<LI><A HREF="http://cr.yp.to/qmail.html">http://cr.yp.to/qmail.html</A>: the official <I>qmail</I> home page.
<LI><A HREF="http://www.qmail.org">http://www.qmail.org</A>: the unofficial <I>qmail</I> home page. Contains lots of information about add-ons and patches, and links to many good <I>qmail</I> web pages on other sites.
<LI><A HREF="http://www.flounder.net/qmail/qmail-howto.html">http://www.flounder.net/qmail/qmail-howto.html</A>: Adam McKenna's HOWTO.</UL>
<H2><A NAME="support">1.11. Support</A></H2>
<H3><A NAME="mailing-lists">1.11.1. Mailing lists</A></H3>
<P>The following lists reside on list.cr.yp.to. In order to prevent harvesting of e-mail addresses by spammers, I'm avoiding the use of complete, valid addresses and &quot;mailto&quot; URL's.</P>
<P>The lists are managed by <I>ezmlm</I>, which uses different addresses to perform different functions:</P>
<UL>
<LI><TT><I>listname</I>@list.cr.yp.to</TT>: the submission address. Messages sent here go out to all members of the list. Do <B>not</B> send subscribe/unsubscribe requests here: they won't work, and they'll annoy the subscribers.
<LI><TT><I>listname</I>-help@list.cr.yp.to</TT>: the &quot;help&quot; address. Returns a list of command addresses and general usage information.
<LI><TT><I>listname</I>-subscribe</TT>: send a blank message here to subscribe.
<LI><TT><I>listname</I>-unsubscribe</TT>: send a blank message here to unsubscribe.</UL>
<P>To specify a subscription/unsubscription address, say <TT>joe@example.com</TT>, send the message to:</P>
<UL>
<LI><TT><I>listname</I>-subscribe-joe=example.com@list.cr.yp.to</TT>.</UL>
<H4><A NAME="qmail-list">1.11.1.1. <U>qmail</U></A></H4>
<P>The main <I>qmail</I> mailing list. For discussion and questions/answers on most things related to <I>qmail</I>, except those with their own lists. Read Charles Cazabon's &quot;12 Steps to qmail List Bliss&quot; at <A HREF="http://pyropus.ca/personal/writings/12-steps-to-qmail-list-bliss.html">http://pyropus.ca/personal/writings/12-steps-to-qmail-list-bliss.html</A> before posting. Also read the FAQs and search the <A HREF="#list-archives">list archives</A> before posting a question. When you ask questions, please try to include sufficient details to make it possible for people to respond:</P>
<UL>
<LI><B><I>What did you do?</I></B> What's your configuration? Include <TT>qmail-showctl</TT> output if you're not sure what's important. What action did you take? If this is a new installation, tell how you installed <I>qmail</I>.
<LI><B><I>What did you expect to happen?</I></B> What was the outcome you were trying to achieve? Don't assume the reader can guess.
<LI><B><I>What <U>did</U> happen?</I></B> Describe the actual result. Include log file clippings and copies of messages, with headers.</UL>
<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG>The <I>qmail</I> list uses a utility called <TT>qsecretary</TT> to verify that messages posted to the list are not spam. Each message posted to the list will result in an e-mail confirmation request from <TT>qsecretary</TT>. Read the message and follow the directions to confirm your message--usually just replying to the <TT>qsecretary</TT> message will do the trick. Regular list posters often automate this process using autoresponders like Charles Cazabon's <I>pymsgauth</I>, available from <A HREF="http://pyropus.ca/software/pymsgauth/">http://pyropus.ca/software/pymsgauth/</A>. <I>pymsgauth</I> verifies that message sent to the <I>qmail</I> list really came from you, so it won't automatically confirm forged messages sent to the list in your name.</P>
<P><HR WIDTH="80%" ALIGN="Left"></P>
<H4><A NAME="qmailannounce-list">1.11.1.2. <U>qmailannounce</U></A></H4>
<P>The <I>qmail</I> announcement mailing list. New releases are announced here. There's no submission address: it's a read-only list.</P>
<H4><A NAME="serialmail-list">1.11.1.3. <U>serialmail</U></A></H4>
<P>For discussion of the <I>serialmail</I> package.</P>
<H4><A NAME="ezmlm-list">1.11.1.4. <U>ezmlm</U></A></H4>
<P>For discussion of the <I>ezmlm</I> mailing list manager.</P>
<H3><A NAME="consultants">1.11.2. Consultants</A></H3>
<P>See <A HREF="http://www.qmail.org/top.html#paidsup">http://www.qmail.org/top.html#paidsup</A> for a list of commercial support providers.</P>
<H3><A NAME="faqts">1.11.3. FAQTS Knowledgebase</A></H3>
<P>A database of <I>qmail</I>-related questions and answers is available at <A HREF="http://qmail.faqts.com/">http://qmail.faqts.com/</A>. If you have a question that the FAQ doesn't answer, try searching this knowledgebase. It's especially good at answering &quot;how to&quot; questions.</P>
<HR>
<H1><A NAME="installation">2. Installation</A></H1>
<P>This section covers installing <I>qmail</I>. If you're an experienced system administrator, you can install <I>qmail</I> following the directions in <TT>INSTALL</TT> in the source distribution. The <TT>INSTALL</TT> directions are the <B>official</B> installation directions. They're more complex than the <U>Life with qmail</U> directions, and they assume that the reader is an experienced system and mail administrator. They're also outdated and don't reflect Bernstein's current recommended practices.</P>
<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG>If you choose to install using the following directions, you should read through the entire section to familiarize yourself with the overall process.
<HR WIDTH="80%" ALIGN="Left"></P>
<H2><A NAME="installation-issues">2.1. Installation Issues</A></H2>
<H3><A NAME="binary-vs-source">2.1.1. Binary vs. source code</A></H3>
<P>Before 2007-11-30, <I>qmail</I>'s restrictive licensing regarding the distribution of prebuilt packages meant that it was usually installed from a source code distribution. This may change in the future, expecially if <I>daemontools</I> and <I>ucspi-tcp</I> are placed in the public domain. For now, though, source code is still the preferred distribution method for <I>qmail</I>.</P>
<P>If you're not familiar with the distinction between source code and binaries, imagine ordering a pizza delivered to your house. The &quot;binary&quot; version of the pizza arrives ready-to-eat. The &quot;source code&quot; pizza comes as a kit containing flour, yeast, cheese, sauce, toppings, and directions for cooking the pizza yourself. Source code installations are a little more work for you, but if you follow the directions carefully, the result is the same--or even better. The self-baked pizza will be fresher, you can adjust the toppings to your preferences, and you'll know a lot more about your pizza and how it &quot;works&quot;.</P>
<P>Safely running an Internet-accesible network service is not easy. An improperly configured service can put the host system at risk of attack or can be used to attack other sites--potentially exposing the administrator to legal liability. The more you know about how your network services work, the more likely they are to be properly configured and secure.</P>
<H3><A NAME="tar-vs-package">2.1.2. Tarball vs. OS-specific package</A></H3>
<P>Some operating systems provide a mechanism for automating source code installations. Returning to the pizza analogy, they make it possible to package the ingredients and directions in such a way that you can just push a button and have the pizza bake itself.</P>
<P>Sounds great, doesn't it?</P>
<P>In practice, it might not be such a good idea. Assembling these packages is pretty difficult, and they might not do things the way they're supposed to. They're software, and like any software, they can have bugs. But even if they're bug free, the convenience they provide comes at a cost. You lose most of the advantages of the self-baked pizza: the ability to adjust the toppings to your personal preferences, and the knowledge of how the pizza was made and how it works.</P>
<P>If <I>qmail</I> was a pizza, the self-building approach might still be the way to go. But it's not: it's a fairly complicated system that the installer/maintainer needs to understand pretty well in order to be able to keep it working smoothly. The self-installing <I>qmail</I> is easier to install than the user-installed version, but the user-installed version is easier to configure and troubleshoot. You install <I>qmail</I> once on a system, but you will probably have several opportunities to reconfigure it or try to figure out why mail isn't flowing the way you think it should.</P>
<P>For this reason, I suggest installing <I>qmail</I> from scratch using the source code tarball, not a Red Hat RPM or other self-installing bundle.</P>
<H2><A NAME="preparation">2.2. Preparation</A></H2>
<P>Before installing <I>qmail</I> on a system, especially if this is your first <I>qmail</I> installation, there are a few things you need to think about.</P>
<UL>
<LI>If possible, install <I>qmail</I> on a &quot;practice&quot; system. This will give you a chance to make mistakes without losing important mail or interrupting mail service to your users.
<LI>If you don't have a spare, and your system is already handling mail using <I>sendmail</I>, <I>smail</I>, or some other MTA, you can install and test most pieces of <I>qmail</I> without interfering with the existing service.
<LI>When migrating a system from some other MTA to <I>qmail</I>--even if you've got some <I>qmail</I> experience under your belt--it's a good idea to formulate a plan.</UL>
<H2><A NAME="system-requirements">2.3. System requirements</A></H2>
<P><I>qmail</I> will install and run on most UNIX and UNIX-like systems, but there are few requirements:</P>
<UL>
<LI>About 10 megabytes of free space in the build area during the build. After the build, you can free all but 4 megabytes by removing the object files.
<LI>A complete, functioning C development system including a compiler, system header files, and libraries. The build directions will show you how to tell if you've got the necessary parts.
<LI>A few megabytes for the binaries, documentation, and configuration files.
<LI>A safe filesystem for the queue. <I>qmail</I>'s reliability guarantee requires that the queue reside on a filesystem with traditional BSD FFS semantics. Most modern local filesystems meet these requirements with one important exception: the <TT>link()</TT> system call is often <I>asynchronous</I>--meaning that the results of the <TT>link()</TT> operation might not have been written to disk when the <TT>link()</TT> call returns. Bruce Guenter's <I>syncdir</I> library can be used to work around this problem. See <A HREF="#syncdir">syncdir</A> in the Related Packages appendix for more information.
<LI>Sufficient disk space for the queue. Small single-user systems only need a couple megabytes. Large servers may need a couple gigabytes.
<LI>A compatible operating system. Most flavors of UNIX are acceptable. See <TT>README</TT> in the source tree for a list of known compatible releases.
<LI>Access to a domain name server (DNS) is highly recommended. Without one, <I>qmail</I> can only send to remote systems configured in its <TT>smtproutes</TT> config file.
<LI>Adequate network connectivity. <I>qmail</I> was designed for well-connected systems, so you probably don't want to try to use it for a mailing list server on a 28.8k dial-up. The <I>serialmail</I> package was designed to make <I>qmail</I> more compatible with poorly-connected systems. See the <A HREF="#serialmail">serialmail</A> section in the Related Packages appendix for more information.</UL>
<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG>The <I>qmail</I> <TT>bin</TT> directory must reside on a filesystem that allows the use of executable and <TT>setuid()</TT> files. Some OS distributions automatically mount <TT>/var</TT> with the <TT>nosuid</TT> or <TT>noexec</TT> options enabled. On such systems, either these options should be disabled or <TT>/var/qmail/bin</TT> should reside on another filesystem without these options enabled. The <A HREF="#create-dirs">Create directories</A> section describes how to use symbolic links to accomplish the latter. If <TT>/var</TT> is mounted <TT>nosuid</TT>, you'll probably see the following error message in the <TT>qmail-send</TT> logs:</P>
<PRE>
delivery : deferral: Sorry,_message_has_wrong_owner._(#4.3.5)
</PRE>
<P><HR WIDTH="80%" ALIGN="Left"></P>
<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG><I>qmail</I> won't install properly under Apple's OS X following these directions or the ones in the <TT>INSTALL</TT> file. Eben Pratt has documented procedures for installing under OS X, available from <A HREF="http://netdevice.com/qmail/#osx">http://netdevice.com/qmail/#osx</A>.</P>
<P><HR WIDTH="80%" ALIGN="Left"></P>
<H2><A NAME="download">2.4. Download the source</A></H2>
<P>OK, so you've got a system meeting the requirements ready for installing <I>qmail</I>. The first step is to download the source code for <I>qmail</I> and any other add-ons. You'll need <I>qmail</I>, of course, and you should probably also get <I>ucspi-tcp</I> and <I>daemontools</I>:</P>
<UL>
<LI><I>qmail</I>, <A HREF="http://www.qmail.org/netqmail-1.06.tar.gz">http://www.qmail.org/netqmail-1.06.tar.gz</A>
<LI><I>ucspi-tcp</I>, <A HREF="http://cr.yp.to/ucspi-tcp/ucspi-tcp-0.88.tar.gz">http://cr.yp.to/ucspi-tcp/ucspi-tcp-0.88.tar.gz</A>
<LI><I>daemontools</I>, <A HREF="http://cr.yp.to/daemontools/daemontools-0.76.tar.gz">http://cr.yp.to/daemontools/daemontools-0.76.tar.gz</A></UL>
<P>Retrieve these files using your web browser, web client (e.g., <TT>wget</TT>), or FTP client.</P>
<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG>If any of the links fail, it's probably because the package has been updated. In that case, you should go to <A HREF="http://cr.yp.to/software.html">http://cr.yp.to/software.html</A> and follow the links to download the current version. It's possible that upgraded versions aren't compatible with the following instructions, so be sure to read the release notes in the &quot;Upgrading from previous versions...&quot; sections.
<HR WIDTH="80%" ALIGN="Left"></P>
<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG>This installation uses the <I>netqmail</I> distribution of <I>qmail</I>, which consists of the official <I>qmail</I> 1.03 tarball to which patches that fix a handful of bugs, deficiencies, and incompatibilities have been applied. See <A HREF="http://www.qmail.org/netqmail/">http://www.qmail.org/netqmail/</A> and the <I>netqmail</I> <TT>CHANGES</TT> file for more information.
<HR WIDTH="80%" ALIGN="Left"></P>
<H2><A NAME="build">2.5. Build the source</A></H2>
<H3><A NAME="verify-compiler">2.5.1. Verify build environment</A></H3>
<P>The first thing you need to do is make sure that you have the necessary tools to compile a program. How you determine this depends on what flavor of UNIX you're using. The easiest way to tell, although it's not guaranteed, is to <I>try</I> it.</P>
<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG>If any one of these tests passes, you can stop and go on to the next section.
<HR WIDTH="80%" ALIGN="Left"></P>
<UL>
<LI>At a command line prompt, type <TT>cc</TT> and press Enter:</UL>
<PRE>
    $ cc
    cc: No input files specified
    $
</PRE>
<UL>
<LI>If you get a similar response, you have a C compiler in your path. If not, it doesn't necessarily mean you don't have one installed. You might, but maybe it isn't in your path. Of course it could also mean that you <I>don't</I> have one. Try these:<UL>
<LI><TT>/usr/bin/cc</TT>
<LI><TT>/usr/bin/gcc</TT>
<LI><TT>/usr/local/bin/cc</TT>
<LI><TT>/usr/local/bin/gcc</TT>
<LI><TT>/usr/ccs/bin/cc</TT></UL>
<LI>If none of these works, you'll have to try something little more platform specific. At the prompt try one of these, depending on which OS you're using:<UL>
<LI>Red Hat Linux: <TT>rpm -qa | grep gcc</TT> or <TT>rpm -qa | grep egcs</TT>
<LI>FreeBSD: includes GCC by default</UL>
<LI>If you can't find a compiler installed, you'll have to locate one and install it. Contact your OS vendor or other OS support channel.</UL>
<P>In this section we'll go through the actual steps of compiling <I>qmail</I>. A way to cut-n-paste will come in handy here, but isn't really necessary.</P>
<H3><A NAME="unpack">2.5.2. Unpack the distribution</A></H3>
<P>If you made it this far, you have a working C compiler and copies of the tarballs. Next, copy or move the tarballs to the directory you want to do the work in. <TT>/usr/local/src</TT> is a good choice for <I>qmail</I> and <I>ucspi-tcp</I>. <I>daemontools</I> should be built under <TT>/package</TT>.</P>
<P>At this time you probably want to become root, if you're not already.</P>
<PRE>
    su
    umask 022
    mkdir -p /usr/local/src
    mv netqmail-1.06.tar.gz ucspi-tcp-0.88.tar.gz /usr/local/src
    mkdir -p /package
    mv daemontools-0.76.tar.gz /package
    chmod 1755 /package
</PRE>
<P>Now you can unpack the packages.</P>
<PRE>
    cd /usr/local/src
    gunzip netqmail-1.06.tar.gz
    tar xpf netqmail-1.06.tar
    gunzip ucspi-tcp-0.88.tar.gz
    tar xpf ucspi-tcp-0.88.tar
    rm *.tar      <I># optional, unless space is very tight</I>
    cd /package
    gunzip daemontools-0.76.tar.gz
    tar xpf daemontools-0.76.tar
    rm *.tar      <I># optional, again</I>
</PRE>
<P>There should now be directories called <TT>/usr/local/src/netqmail-1.06</TT>, <TT>/usr/local/src/ucspi-tcp-0.88</TT>, and <TT>/package/admin/daemontools-0.76</TT>.</P>
<H3><A NAME="create-dirs">2.5.3. Create directories</A></H3>
<P>Since <I>qmail</I>'s installation program creates the subdirectories as they're needed, you only need to create the <I>qmail</I> &quot;home&quot; directory:</P>
<PRE>
    mkdir /var/qmail
</PRE>
<P>And on to the next section.</P>
<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG>If you want some or all of the <I>qmail</I> files to reside elsewhere than <TT>/var</TT>, this can be accomplished by creating symbolic links under <TT>/var/qmail</TT> pointing to the other locations.</P>
<P>For <I><B>example</B></I>, the <I>qmail</I> configuration files can be stored in <TT>/etc/qmail</TT> by doing:</P>
<PRE>
    mkdir /etc/qmail
    ln -s /etc/qmail /var/qmail/control
</PRE>
<P><HR WIDTH="80%" ALIGN="Left"></P>
<H3><A NAME="create-users">2.5.4. Create users and groups</A></H3>
<P>The easiest way to create the necessary users and groups is to create a little script file to do it for you.  In the source directory you'll find a file called  <TT>INSTALL.ids</TT>.  It contains the command lines for many platforms, so copying the file to another name and editing that is quick and easy.</P>
<PRE>
    cd /usr/local/src/netqmail-1.06
    cp INSTALL.ids IDS
</PRE>
<P>Then, using your favorite editor, remove all of the file <B>except</B> the lines you want.  For example, here's what <TT>IDS</TT> would look like for FreeBSD after editing:</P>
<PRE>
    pw groupadd nofiles
    pw useradd qmaild -g nofiles -d /var/qmail -s /nonexistent
    pw useradd alias -g nofiles -d /var/qmail/alias -s /nonexistent
    pw useradd qmaill -g nofiles -d /var/qmail -s /nonexistent
    pw useradd qmailp -g nofiles -d /var/qmail -s /nonexistent
    pw groupadd qmail
    pw useradd qmailq -g qmail -d /var/qmail -s /nonexistent
    pw useradd qmailr -g qmail -d /var/qmail -s /nonexistent
    pw useradd qmails -g qmail -d /var/qmail -s /nonexistent
</PRE>
<P>Then to run it, either use <TT>chmod</TT> to make it executable or run it with <TT>sh</TT>:</P>
<P>First method:</P>
<PRE>
    chmod 700 IDS
    ./IDS
</PRE>
<P>Second method:</P>
<PRE>
    /bin/sh IDS
</PRE>
<P>When the script finishes, all of your users and groups will be created and you can go on to the next section.</P>
<P>But what do you do if your system isn't listed in <TT>INSTALL.ids</TT>? You'll have to create them manually.  Start by using your favorite editor and editing <TT>/etc/group</TT>.  You need to add the following two lines to the end of the file:</P>
<PRE>
    qmail:*:2107:
    nofiles:*:2108:
</PRE>
<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG>Make sure that 2107 and 2108 aren't already used. If they are used, select two numbers that aren't already in use.
<HR WIDTH="80%" ALIGN="Left"></P>
<P>Next, using <TT>vipw</TT> (most systems have it, if not you'll need to use your editor again but this time on <TT>/etc/passwd</TT>) add these lines to the end of the file:</P>
<PRE>
    alias:*:7790:2108::/var/qmail/alias:/bin/true
    qmaild:*:7791:2108::/var/qmail:/bin/true
    qmaill:*:7792:2108::/var/qmail:/bin/true
    qmailp:*:7793:2108::/var/qmail:/bin/true
    qmailq:*:7794:2107::/var/qmail:/bin/true
    qmailr:*:7795:2107::/var/qmail:/bin/true
    qmails:*:7796:2107::/var/qmail:/bin/true
</PRE>
<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG>Make sure 7790-7796 aren't already in use and that 2107 and 2108 are the same group ids you used above. If any of these UID's are already being used, select numbers that aren't already in use.
<HR WIDTH="80%" ALIGN="Left"></P>
<P>You don't specifically need to add any of these lines to the <I>end</I> of the file, that's just the easiest way to explain it here.</P>
<P>You're now ready to continue on to the next section.</P>
<H3><A NAME="do-build">2.5.5. Do the build</A></H3>
<P>Now you can start building <I>qmail</I>. Change to the <TT>/usr/local/src/netqmail-1.05/netqmail-1.05</TT> directory and let's get started:</P>
<PRE>
    cd /usr/local/src/netqmail-1.06
</PRE>
<P>In the <A HREF="#verify-compiler">Verify Build Environment</A> section, you located your C compiler. If it's not called <TT>cc</TT> or the directory it resides in isn't in your <TT>PATH</TT> environment variable, you'll need to edit <TT>conf-cc</TT> and <TT>conf-ld</TT>. Say your compiler is <TT>gcc</TT>, and it's in your <TT>PATH</TT>. Simply edit <TT>conf-cc</TT> and <TT>conf-ld</TT> and replace &quot;cc&quot; with &quot;gcc&quot;.</P>
<P>Now type the following:</P>
<PRE>
    make setup check
</PRE>
<P>After the build is complete, you'll need to do your post installation configuration. A couple of scripts are provided to make this job a lot easier.</P>
<P>If your DNS is configured properly, this script should be all you need at this point:</P>
<PRE>
    ./config
</PRE>
<P>If, for some reason, <TT>config</TT> can't find your hostname in DNS, you'll have to run the <TT>config-fast</TT> script:</P>
<PRE>
    ./config-fast <I>the.full.hostname</I>
</PRE>
<P>For example, if your domain is example.com and the hostname of your computer is dolphin, your config-fast line would look like this:</P>
<PRE>
    ./config-fast dolphin.example.com
</PRE>
<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG>On a small local LAN you might want to use a pseudo domain such as &quot;.local&quot;. E.g., if your hostname is &quot;mash&quot;, you could do <TT>./config-fast mash.local</TT>. If you do this, be sure to configure <I>qmail</I> to use a valid Internet domain name in return addresses. (See section 3, <A HREF="#configuration">Configuration</A>.)
<HR WIDTH="80%" ALIGN="Left"></P>
<P><I>qmail</I> is now installed on your system and is ready to be run! The next section will guide you through the steps of starting and testing qmail.</P>
<H2><A NAME="install-ucspi">2.6. Install ucspi-tcp</A></H2>
<P>Earlier, you unpacked the <I>qmail</I>, <I>ucspi-tcp</I>, and <I>daemontools</I> tarballs. Now change to the <I>ucspi-tcp</I> directory:</P>
<PRE>
    cd /usr/local/src/ucspi-tcp-0.88
</PRE>
<P>In the <A HREF="#do-build">Do the build</A> section, if you modified <TT>conf-cc</TT> and <TT>conf-ld</TT>, you'll need to make the same changes in this directory.</P>
<P>Then do:</P>
<PRE>
    patch &lt; /usr/local/src/netqmail-1.06/other-patches/ucspi-tcp-0.88.errno.patch
    make
    make setup check
</PRE>
<P>That's it. <I>ucspi-tcp</I> is installed.</P>
<H2><A NAME="install-daemontools">2.7. Install daemontools</A></H2>
<P>Change to the <I>daemontools</I> build directory:</P>
<PRE>
    cd /package/admin/daemontools-0.76
</PRE>
<P>Once again, if you modified &lt;conf-cc&gt; and <TT>conf-ld</TT> during the <I>qmail</I> and <I>ucspi-tcp</I> builds, you'll need to make the same changes in the <TT>src</TT> directory.</P>
<P>Then do:</P>
<PRE>
    cd src
    patch &lt; /usr/local/src/netqmail-1.06/other-patches/daemontools-0.76.errno.patch
    cd ..
    package/install
</PRE>
<P>On BSD systems (no <TT>/etc/inittab</TT>), you'll need to reboot at this point to start <TT>svscan</TT>, the master service control daemon.</P>
<P>Use &quot;<TT>ps -ef | grep svscan</TT>&quot; or &quot;<TT>ps waux | grep svscan</TT>&quot; to verify that <TT>svscan</TT> is running.</P>
<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG>Under Solaris, you'll have to modify the <TT>/etc/inittab</TT> entry that starts <TT>svscan</TT> from:</P>
<PRE>
  SV:123456:respawn:/command/svscanboot
</PRE>
<P>to:</P>
<PRE>
  SV:123456:respawn:/command/svscanboot &lt;/dev/null &gt;/var/log/svscan 2&gt;&amp;1
</PRE>
<P>or:</P>
<PRE>
  SV:123456:respawn:/command/svscanboot &lt;/dev/null &gt;/dev/msglog 2&gt;&amp;1
</PRE>
<P>Depending upon whether you want error messages resutling from starting <TT>svscan</TT> to be sent to a log file or the system console. For an explanation of why this is necessary, see:</P>
<P><A HREF="http://marc.theaimsgroup.com/?l=log&amp;m=100327801309834&amp;w=2">http://marc.theaimsgroup.com/?l=log&amp;m=100327801309834&amp;w=2</A></P>
<P><HR WIDTH="80%" ALIGN="Left"></P>
<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG>A Slackware user reports that the <TT>SV</TT> <TT>/etc/inittab</TT> entry has to be moved before the <TT>x1</TT> entry or <TT>svscan</TT> won't be started at boot-up.
<HR WIDTH="80%" ALIGN="Left"></P>
<H2><A NAME="start-qmail">2.8. Start <I>qmail</I></A></H2>
<H3><A NAME="rc">2.8.1. <TT>/var/qmail/rc</TT></A></H3>
<P>The <TT>/var/qmail/boot</TT> directory contains example <I>qmail</I> boot scripts for different configurations: <TT>/var/spool/mail</TT> vs. <TT>$HOME/Mailbox</TT>, using <I>procmail</I> or <I>dot-forward</I>, and various combinations of these. Feel free to examine these, but for our installation, we'll use the following script:</P>
<PRE>
#!/bin/sh

# Using stdout for logging
# Using control/defaultdelivery from qmail-local to deliver messages by default

exec env - PATH=&quot;/var/qmail/bin:$PATH&quot; \
qmail-start &quot;`cat /var/qmail/control/defaultdelivery`&quot;
</PRE>
<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG>This script uses backquotes (<TT>`</TT>), not single quotes (<TT>'</TT>). For best results, copy and paste the scripts in this guide instead of retyping them.
<HR WIDTH="80%" ALIGN="Left"></P>
<P>Use your editor to create the above <TT>/var/qmail/rc</TT>, then execute these commands:</P>
<PRE>
    chmod 755 /var/qmail/rc
    mkdir /var/log/qmail
</PRE>
<P>At this point you need to decide the default delivery mode for messages that aren't delivered by a .qmail file. The following table outlines some common choices.</P>
<TABLE CLASS="columns" BORDER>
<TR CLASS="heading">
<TD>
<STRONG>Mailbox format</STRONG>
</TD>
<TD>
<STRONG>Name</STRONG>
</TD>
<TD>
<STRONG>Location</STRONG>
</TD>
<TD>
<STRONG>defaultdelivery</STRONG>
</TD>
<TD>
<STRONG>Comments</STRONG>
</TD>
</TR>
<TR>
<TD>
mbox
</TD>
<TD>
<TT>Mailbox</TT>
</TD>
<TD>
<TT>$HOME</TT>
</TD>
<TD>
<TT>./Mailbox</TT>
</TD>
<TD>
most common, works with most MUA's
</TD>
</TR>
<TR>
<TD>
maildir
</TD>
<TD>
<TT>Maildir</TT>
</TD>
<TD>
<TT>$HOME</TT>
</TD>
<TD>
<TT>./Maildir/</TT>
</TD>
<TD>
more reliable, less MUA support
</TD>
</TR>
<TR>
<TD>
mbox
</TD>
<TD>
<TT>&nbsp;<I>username</I></TT>
</TD>
<TD>
<TT>/var/spool/mail</TT>
</TD>
<TD>
See <TT>INSTALL.vsm</TT>
</TD>
<TD>
traditional UNIX mailbox
</TD>
</TR>
</TABLE>

<P>See <TT>INSTALL.mbox</TT>, <TT>INSTALL.maildir</TT>, and <TT>INSTALL.vsm</TT> for more information.</P>
<P>To select your default mailbox type, just enter the <I>defaultdelivery</I> value from the table into <TT>/var/qmail/control/defaultdelivery</TT>. E.g., to select the standard <I>qmail</I> <TT>Mailbox</TT> delivery, do:</P>
<PRE>
    echo ./Mailbox &gt;/var/qmail/control/defaultdelivery
</PRE>
<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG><TT>defaultdelivery</TT> isn't a standard <I>qmail</I> control file. It's a feature of the above <TT>/var/qmail/rc</TT> file. The <I>defaultdelivery</I> argument to <TT>qmail-start</TT> is the <I>contents</I> of a <TT>.qmail</TT> file that specifies delivery instructions to be followed when no actual <TT>.qmail</TT> is found. Putting these instructions in a separate control file eliminates the need to quote shell metacharacters in the delivery instructions and avoids messy multi-line command arguments.
<HR WIDTH="80%" ALIGN="Left"></P>
<H3><A NAME="system-startup">2.8.2. System start-up files</A></H3>
<H4><A NAME="qmailctl-script">2.8.2.1. The <TT>qmailctl</TT> script</A></H4>
<P>If you were to manually execute the <TT>/var/qmail/rc</TT> script, <I>qmail</I> would be <I>partially</I> started. But we want <I>qmail</I> started up automatically every time the system is booted and we want it shut down cleanly when the system is halted.</P>
<P>This is accomplished by creating a startup/shutdown script like the following in <TT>/var/qmail/bin/qmailctl</TT>:</P>
<PRE>
#!/bin/sh

# description: the qmail MTA

PATH=/var/qmail/bin:/bin:/usr/bin:/usr/local/bin:/usr/local/sbin
export PATH

QMAILDUID=`id -u qmaild`
NOFILESGID=`id -g qmaild`

case &quot;$1&quot; in
  start)
    echo &quot;Starting qmail&quot;
    if svok /service/qmail-send ; then
      svc -u /service/qmail-send /service/qmail-send/log
    else
      echo &quot;qmail-send supervise not running&quot;
    fi
    if svok /service/qmail-smtpd ; then
      svc -u /service/qmail-smtpd /service/qmail-smtpd/log
    else
      echo &quot;qmail-smtpd supervise not running&quot;
    fi
    if [ -d /var/lock/subsys ]; then
      touch /var/lock/subsys/qmail
    fi
    ;;
  stop)
    echo &quot;Stopping qmail...&quot;
    echo &quot;  qmail-smtpd&quot;
    svc -d /service/qmail-smtpd /service/qmail-smtpd/log
    echo &quot;  qmail-send&quot;
    svc -d /service/qmail-send /service/qmail-send/log
    if [ -f /var/lock/subsys/qmail ]; then
      rm /var/lock/subsys/qmail
    fi
    ;;
  stat)
    svstat /service/qmail-send
    svstat /service/qmail-send/log
    svstat /service/qmail-smtpd
    svstat /service/qmail-smtpd/log
    qmail-qstat
    ;;
  doqueue|alrm|flush)
    echo &quot;Flushing timeout table and sending ALRM signal to qmail-send.&quot;
    /var/qmail/bin/qmail-tcpok
    svc -a /service/qmail-send
    ;;
  queue)
    qmail-qstat
    qmail-qread
    ;;
  reload|hup)
    echo &quot;Sending HUP signal to qmail-send.&quot;
    svc -h /service/qmail-send
    ;;
  pause)
    echo &quot;Pausing qmail-send&quot;
    svc -p /service/qmail-send
    echo &quot;Pausing qmail-smtpd&quot;
    svc -p /service/qmail-smtpd
    ;;
  cont)
    echo &quot;Continuing qmail-send&quot;
    svc -c /service/qmail-send
    echo &quot;Continuing qmail-smtpd&quot;
    svc -c /service/qmail-smtpd
    ;;
  restart)
    echo &quot;Restarting qmail:&quot;
    echo &quot;* Stopping qmail-smtpd.&quot;
    svc -d /service/qmail-smtpd /service/qmail-smtpd/log
    echo &quot;* Sending qmail-send SIGTERM and restarting.&quot;
    svc -t /service/qmail-send /service/qmail-send/log
    echo &quot;* Restarting qmail-smtpd.&quot;
    svc -u /service/qmail-smtpd /service/qmail-smtpd/log
    ;;
  cdb)
    tcprules /etc/tcp.smtp.cdb /etc/tcp.smtp.tmp &lt; /etc/tcp.smtp
    chmod 644 /etc/tcp.smtp.cdb
    echo &quot;Reloaded /etc/tcp.smtp.&quot;
    ;;
  help)
    cat &lt;&lt;HELP
   stop -- stops mail service (smtp connections refused, nothing goes out)
  start -- starts mail service (smtp connection accepted, mail can go out)
  pause -- temporarily stops mail service (connections accepted, nothing leaves)
   cont -- continues paused mail service
   stat -- displays status of mail service
    cdb -- rebuild the tcpserver cdb file for smtp
restart -- stops and restarts smtp, sends qmail-send a TERM &amp; restarts it
doqueue -- schedules queued messages for immediate delivery
 reload -- sends qmail-send HUP, rereading locals and virtualdomains
  queue -- shows status of queue
   alrm -- same as doqueue
  flush -- same as doqueue
    hup -- same as reload
HELP
    ;;
  *)
    echo &quot;Usage: $0 {start|stop|restart|doqueue|flush|reload|stat|pause|cont|cdb|queue|help}&quot;
    exit 1
    ;;
esac

exit 0

</PRE>
<P>This script is available via <A HREF="http://lifewithqmail.org/qmailctl-script-dt70">http://lifewithqmail.org/qmailctl-script-dt70</A>.</P>
<P>Create the script using your editor or by downloading it with your web browser (recommended).</P>
<P>Make the <TT>qmailctl</TT> script executable and link it to a directory in your path:</P>
<PRE>
    chmod 755 /var/qmail/bin/qmailctl
    ln -s /var/qmail/bin/qmailctl /usr/bin
</PRE>
<H4><A NAME="supervise-tree">2.8.2.2. The <TT>supervise</TT> scripts</A></H4>
<P>Now create the <TT>supervise</TT> directories for the <I>qmail</I> services:</P>
<PRE>
    mkdir -p /var/qmail/supervise/qmail-send/log
    mkdir -p /var/qmail/supervise/qmail-smtpd/log
</PRE>
<P>Create the <TT>/var/qmail/supervise/qmail-send/run</TT> file:</P>
<PRE>
#!/bin/sh
exec /var/qmail/rc
</PRE>
<P>Create the <TT>/var/qmail/supervise/qmail-send/log/run</TT> file:</P>
<PRE>
#!/bin/sh
exec /usr/local/bin/setuidgid qmaill /usr/local/bin/multilog t /var/log/qmail
</PRE>
<P>Create the <TT>/var/qmail/supervise/qmail-smtpd/run</TT> file:</P>
<PRE>
#!/bin/sh

QMAILDUID=`id -u qmaild`
NOFILESGID=`id -g qmaild`
MAXSMTPD=`cat /var/qmail/control/concurrencyincoming`
LOCAL=`head -1 /var/qmail/control/me`

if [ -z &quot;$QMAILDUID&quot; -o -z &quot;$NOFILESGID&quot; -o -z &quot;$MAXSMTPD&quot; -o -z &quot;$LOCAL&quot; ]; then
    echo QMAILDUID, NOFILESGID, MAXSMTPD, or LOCAL is unset in
    echo /var/qmail/supervise/qmail-smtpd/run
    exit 1
fi

if [ ! -f /var/qmail/control/rcpthosts ]; then
    echo &quot;No /var/qmail/control/rcpthosts!&quot;
    echo &quot;Refusing to start SMTP listener because it'll create an open relay&quot;
    exit 1
fi

exec /usr/local/bin/softlimit -m 2000000 \
    /usr/local/bin/tcpserver -v -R -l &quot;$LOCAL&quot; -x /etc/tcp.smtp.cdb -c &quot;$MAXSMTPD&quot; \
        -u &quot;$QMAILDUID&quot; -g &quot;$NOFILESGID&quot; 0 smtp /var/qmail/bin/qmail-smtpd 2&gt;&amp;1
</PRE>
<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG><TT>concurrencyincoming</TT> isn't a standard qmail control file. It's a feature of the above script. Also, that's <TT>-1</TT> (dash one) on the <TT>LOCAL</TT> line and <TT>-l</TT> (dash ell) on the <TT>tcpserver</TT> line.
<HR WIDTH="80%" ALIGN="Left"></P>
<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG>Under Solaris, the normal <TT>id</TT> program won't work right in this script. Instead of <TT>id</TT>, use <TT>/usr/xpg4/bin/id</TT>, e.g.:</P>
<PRE>
    QMAILDUID=`/usr/xpg4/bin/id -u qmaild`
    NOFILESGID=`/usr/xpg4/bin/id -g qmaild`
</PRE>
<P><HR WIDTH="80%" ALIGN="Left"></P>
<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG>The memory limit specified in the <TT>softlimit</TT> command may need to be raised depending upon your operating system and hardware platform. If attempts to connect to port 25 fail or remote systems are unable to send you mail, or you see a message like:</P>
<PRE>
  /usr/local/bin/tcpserver: error while loading shared libraries:
  libc.so.6: failed to map segment from shared object: Cannot
  allocate memory
</PRE>
<P>try raising it to 3000000 or 4000000.</P>
<P><HR WIDTH="80%" ALIGN="Left"></P>
<P>Create the <TT>concurrencyincoming</TT> control file:</P>
<PRE>
    echo 20 &gt; /var/qmail/control/concurrencyincoming
    chmod 644 /var/qmail/control/concurrencyincoming
</PRE>
<P>Create the <TT>/var/qmail/supervise/qmail-smtpd/log/run</TT> file:</P>
<PRE>
#!/bin/sh
exec /usr/local/bin/setuidgid qmaill /usr/local/bin/multilog t /var/log/qmail/smtpd
</PRE>
<P>Make the run files executable:</P>
<PRE>
    chmod 755 /var/qmail/supervise/qmail-send/run
    chmod 755 /var/qmail/supervise/qmail-send/log/run
    chmod 755 /var/qmail/supervise/qmail-smtpd/run
    chmod 755 /var/qmail/supervise/qmail-smtpd/log/run
</PRE>
<P>Then set up the log directories:</P>
<PRE>
    mkdir -p /var/log/qmail/smtpd
    chown qmaill /var/log/qmail /var/log/qmail/smtpd
</PRE>
<P>Finally, link the <TT>supervise</TT> directories into <TT>/service</TT>:</P>
<PRE>
    ln -s /var/qmail/supervise/qmail-send /var/qmail/supervise/qmail-smtpd /service
</PRE>
<P>The <TT>/service</TT> directory is created when <I>daemontools</I> is installed.</P>
<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG>The <I>qmail</I> system will start automatically shortly after these links are created. If you don't want it running yet, do:</P>
<PRE>
    qmailctl stop
</PRE>
<P><HR WIDTH="80%" ALIGN="Left"></P>
<H4><A NAME="smtp-access-control">2.8.2.3. SMTP Access Control</A></H4>
<P>Allow the local host to inject mail via SMTP:</P>
<PRE>
    echo '127.:allow,RELAYCLIENT=&quot;&quot;' &gt;&gt;/etc/tcp.smtp
    qmailctl cdb
</PRE>
<H3><A NAME="stop-sendmail">2.8.3. Stop and disable the installed MTA</A></H3>
<P>Although it's possible to run both <I>qmail</I> and your existing MTA, which is probably <I>Sendmail</I>, simultaneously, I don't recommend it unless you know what you're doing. And, frankly, if you're reading this, you probably don't know what you're doing. :-)</P>
<P>If your existing MTA is <I>Sendmail</I>, you should be able to stop it by running the <TT>init.d</TT> script with the &quot;stop&quot; argument. E.g., one of these should work:</P>
<PRE>
    /etc/init.d/sendmail stop
    /sbin/init.d/sendmail stop
    /etc/rc.d/init.d/sendmail stop
</PRE>
<P>If you can't find an <TT>init.d/sendmail</TT> script, you can locate <TT>sendmail</TT>'s PID using &quot;<TT>ps -ef|grep sendmail</TT>&quot; or &quot;<TT>ps waux|grep sendmail</TT>&quot; and stop it using:</P>
<PRE>
    kill <I>PID-of-sendmail</I>
</PRE>
<P>If your MTA isn't <I>Sendmail</I>, check its documentation for the correct shutdown procedure.</P>
<P>You should also consider removing the old MTA completely from the system. At least disable the <TT>init.d</TT> script so it doesn't try to start up again when the system is rebooted.</P>
<P>For Red Hat Linux, removing <I>Sendmail</I> can be accomplished by:</P>
<PRE>
    rpm -e --nodeps sendmail
</PRE>
<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG>If you're using an RPM-based Linux distribution like Red Hat, removing the MTA package might cause problems down the road. Utilities that update the system might try to reinstall Sendmail, or MUA packages might not install because they can't tell an MTA is installed. Mate Wierdl provides a stub package called &quot;fake_mta&quot; that can be installed to prevent these problems. Simply install the RPM available from <A HREF="ftp://ftp.csi.hu/mw/fake_mta-1-10memphis.noarch.rpm ">ftp://ftp.csi.hu/mw/fake_mta-1-10memphis.noarch.rpm </A>.</P>
<P><HR WIDTH="80%" ALIGN="Left"></P>
<P>Verify that nothing is listening to the SMTP port (25). Culprits could be the old MTA, <TT>inetd</TT>, or <TT>xinetd</TT>. The following command should produce no output (unless the qmail-smtpd service is running):</P>
<PRE>
    netstat -a | grep smtp
</PRE>
<P>If something is running, make sure it's not <I>qmail</I> by doing:</P>
<PRE>
    qmailctl stop
</PRE>
<P>The repeat the <TT>netstat</TT> check:</P>
<PRE>
    netstat -a | grep smtp
</PRE>
<P>If you still get output from that command you'll have to locate the culprit and fix it before <I>qmail</I>'s SMTP service will run.</P>
<P>Lastly, replace any existing <TT>/usr/lib/sendmail</TT> with the <I>qmail</I> version:</P>
<PRE>
    mv /usr/lib/sendmail /usr/lib/sendmail.old                  <I># ignore errors</I>
    mv /usr/sbin/sendmail /usr/sbin/sendmail.old                <I># ignore errors</I>
    chmod 0 /usr/lib/sendmail.old /usr/sbin/sendmail.old        <I># ignore errors</I>
    ln -s /var/qmail/bin/sendmail /usr/lib
    ln -s /var/qmail/bin/sendmail /usr/sbin
</PRE>
<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG>It's important to create the <TT>sendmail</TT> links, regardless of the previous MTA, if any. The <TT>sendmail</TT> command is invoked by many applications for sending mail.
<HR WIDTH="80%" ALIGN="Left"></P>
<P>The last step is to create a couple of system aliases.</P>
<H3><A NAME="system-aliases">2.8.4. Create System Aliases</A></H3>
<P>There are three system aliases that should be created on all <I>qmail</I> installations:</P>
<TABLE CLASS="columns" BORDER>
<TR CLASS="heading">
<TD>
<STRONG>Alias</STRONG>
</TD>
<TD>
<STRONG>Purpose</STRONG>
</TD>
</TR>
<TR>
<TD>
<TT>postmaster</TT>
</TD>
<TD>
RFC 2821 required, points to the mail adminstrator (you)
</TD>
</TR>
<TR>
<TD>
<TT>mailer-daemon</TT>
</TD>
<TD>
de facto standard recipient for some bounces
</TD>
</TR>
<TR>
<TD>
<TT>root</TT>
</TD>
<TD>
redirects mail from privileged account to the system administrator
</TD>
</TR>
<TR>
<TD>
<TT>abuse</TT>
</TD>
<TD>
de facto standard recipient for abuse complaints
</TD>
</TR>
</TABLE>

<P>To create these aliases, decide where you want each of them to go (a local user or a remote address) and create and populate the appropriate <TT>.qmail</TT> files. For example, say local user <TT>dave</TT> is both the system and mail administrator:</P>
<PRE>
    echo dave &gt; /var/qmail/alias/.qmail-root
    echo dave &gt; /var/qmail/alias/.qmail-postmaster
    ln -s .qmail-postmaster /var/qmail/alias/.qmail-mailer-daemon
    ln -s .qmail-postmaster /var/qmail/alias/.qmail-abuse
    chmod 644 /var/qmail/alias/.qmail-root /var/qmail/alias/.qmail-postmaster
</PRE>
<P>See <TT>INSTALL.alias</TT> for more details.</P>
<H3><A NAME="start-it">2.8.5. Start <I>qmail</I></A></H3>
<P>If you stopped <I>qmail</I> above after creating the links in <TT>/service</TT>, you should restart it now:</P>
<PRE>
    qmailctl start
</PRE>
<H2><A NAME="test">2.9. Test the Installation</A></H2>
<P><I>qmail</I> should now be running. First run <TT>qmailctl stat</TT> to verify that the services are up and running:</P>
<PRE>
    # qmailctl stat
    /service/qmail-send: up (pid 30303) 187 seconds
    /service/qmail-send/log: up (pid 30304) 187 seconds
    /service/qmail-smtpd: up (pid 30305) 187 seconds
    /service/qmail-smtpd/log: up (pid 30308) 187 seconds
    messages in queue: 0
    messages in queue but not yet preprocessed: 0
</PRE>
<P>All four services should be &quot;up&quot; for more than a second. If they're not, you've probably got a typo in the associated run script or you skipped one or more steps in creating the necessary files, directories, or links. Go back through the installation step-by-step and double check your work. You can also download and run the <TT>inst_check</TT> script, available from <A HREF="http://lifewithqmail.org/inst_check">http://lifewithqmail.org/inst_check</A>. For example:</P>
<PRE>
    # sh inst_check
    ! /var/log/qmail has wrong owner, should be qmaill
    ...try: chown qmaill /var/log/qmail
    #
</PRE>
<P>If <TT>inst_check</TT> finds problems, fix them and re-run it. When everything looks right, <TT>inst_check</TT> will report:</P>
<PRE>
    Congratulations, your LWQ installation looks good!
</PRE>
<P>The <TT>readproctitle</TT> program keeps a log of error messages generated by services managed by svscan. To see these messages, use <TT>ps</TT> or some other process listing command. For example, you might see something like:</P>
<PRE>
    # ps -efl | grep &quot;service errors&quot; | grep -v grep
    000 S root      1006  1001  0  76   0    -   334 pipe_w Mar31 ?        00:00:00
    readproctitle service errors: ...unable to start qmail-smtpd/run: exec format error
    #
</PRE>
<P>In this case, the problem is that there is an error in the first line of the <TT>/service/qmail-smtpd/run</TT> script--most likely caused by the file being is DOS format (CR-LF line endings instead of Unix's LF-only).</P>
<P>It sometimes helps to run a service manually in order to find configuration problems. For example, if your <TT>qmail-smtpd/log</TT> service isn't running, do:</P>
<PRE>
    cd /service/qmail-smtpd/log
    svc -d .
    ./run
    <I>if no errors, enter a line of text and press ENTER</I>
    <I>if still no errors, enter CTRL-D (end of file)</I>
</PRE>
<P>At this point, you should be able to identify the problem and fix it. Once that's done, return to the service's directory, if necessary, and do:</P>
<PRE>
    svc -u .
</PRE>
<P>Once the services are all up with &gt;1 second uptime, follow the instructions in <TT>TEST.deliver</TT> and <TT>TEST.receive</TT> to verify that they're working correctly. Note that using these instructions, logging will be accomplished by <TT>multilog</TT> to <TT>/var/log/qmail</TT>, not <TT>splogger</TT> to something like <TT>/var/log/maillog</TT>.</P>
<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG>If you chose maildir mailbox format as the default delivery method, you will need to create a <TT>Maildir</TT> directory in your home directory and <TT>alias</TT>'s home directory before trying these instructions. See the <A HREF="#maildir-delivery">maildir</A> section to see how to properly create this directory.</P>
<P><HR WIDTH="80%" ALIGN="Left"></P>
<HR>
<H1><A NAME="configuration">3. Configuration</A></H1>
<P>You've got <I>qmail</I> installed, from the recommended source tarball method, one of the self-compiling packages, or a var-qmail package. This section contains information you will need to configure <I>qmail</I> to make it work the way you want it to.</P>
<H2><A NAME="config-files">3.1. Configuration Files</A></H2>
<P>All of <I>qmail</I>'s system configuration files, with the exception of the <TT>.qmail</TT> files in <TT>~alias</TT>, reside in <TT>/var/qmail/control</TT>. The <TT>qmail-control</TT> man page contains a table like the following:</P>
<TABLE CLASS="columns" BORDER>
<TR CLASS="heading">
<TD>
<STRONG>Control</STRONG>
</TD>
<TD>
<STRONG>Default</STRONG>
</TD>
<TD>
<STRONG>Used by</STRONG>
</TD>
<TD>
<STRONG>Purpose</STRONG>
</TD>
</TR>
<TR>
<TD>
<A NAME="badmailfrom">badmailfrom</A>
</TD>
<TD>
<I>none</I>
</TD>
<TD>
qmail-smtpd
</TD>
<TD>
blacklisted From addresses
</TD>
</TR>
<TR>
<TD>
<A NAME="bouncefrom">bouncefrom</A>
</TD>
<TD>
MAILER-DAEMON
</TD>
<TD>
qmail-send
</TD>
<TD>
username of bounce sender
</TD>
</TR>
<TR>
<TD>
<A NAME="bouncehost">bouncehost</A>
</TD>
<TD>
me
</TD>
<TD>
qmail-send
</TD>
<TD>
hostname of bounce sender
</TD>
</TR>
<TR>
<TD>
<A NAME="concurrencyincoming">concurrencyincoming</A>
</TD>
<TD>
<I>none</I>
</TD>
<TD>
/service/qmail-smtpd/run
</TD>
<TD>
max simultaneous incoming SMTP connections
</TD>
</TR>
<TR>
<TD>
<A NAME="concurrencylocal">concurrencylocal</A>
</TD>
<TD>
10
</TD>
<TD>
qmail-send
</TD>
<TD>
max simultaneous local deliveries
</TD>
</TR>
<TR>
<TD>
<A NAME="concurrencyremote">concurrencyremote</A>
</TD>
<TD>
20
</TD>
<TD>
qmail-send
</TD>
<TD>
max simultaneous remote deliveries
</TD>
</TR>
<TR>
<TD>
<A NAME="defaultdelivery">defaultdelivery</A>
</TD>
<TD>
<I>none</I>
</TD>
<TD>
/var/qmail/rc
</TD>
<TD>
default .qmail file
</TD>
</TR>
<TR>
<TD>
<A NAME="defaultdomain">defaultdomain</A>
</TD>
<TD>
me
</TD>
<TD>
qmail-inject
</TD>
<TD>
default domain name
</TD>
</TR>
<TR>
<TD>
<A NAME="defaulthost">defaulthost</A>
</TD>
<TD>
me
</TD>
<TD>
qmail-inject
</TD>
<TD>
default host name
</TD>
</TR>
<TR>
<TD>
<A NAME="databytes">databytes</A>
</TD>
<TD>
0
</TD>
<TD>
qmail-smtpd
</TD>
<TD>
max number of bytes in message (0=no limit)
</TD>
</TR>
<TR>
<TD>
<A NAME="doublebouncehost">doublebouncehost</A>
</TD>
<TD>
me
</TD>
<TD>
qmail-send
</TD>
<TD>
host name of double bounce sender
</TD>
</TR>
<TR>
<TD>
<A NAME="doublebounceto">doublebounceto</A>
</TD>
<TD>
postmaster
</TD>
<TD>
qmail-send
</TD>
<TD>
user to receive double bounces
</TD>
</TR>
<TR>
<TD>
<A NAME="envnoathost">envnoathost</A>
</TD>
<TD>
me
</TD>
<TD>
qmail-send
</TD>
<TD>
default domain for addresses without &quot;@&quot;
</TD>
</TR>
<TR>
<TD>
<A NAME="helohost">helohost</A>
</TD>
<TD>
me
</TD>
<TD>
qmail-remote
</TD>
<TD>
host name used in SMTP HELO command
</TD>
</TR>
<TR>
<TD>
<A NAME="idhost">idhost</A>
</TD>
<TD>
me
</TD>
<TD>
qmail-inject
</TD>
<TD>
host name for Message-ID's
</TD>
</TR>
<TR>
<TD>
<A NAME="localiphost">localiphost</A>
</TD>
<TD>
me
</TD>
<TD>
qmail-smtpd
</TD>
<TD>
name substituted for local IP address
</TD>
</TR>
<TR>
<TD>
<A NAME="locals">locals</A>
</TD>
<TD>
me
</TD>
<TD>
qmail-send
</TD>
<TD>
domains that we deliver locally
</TD>
</TR>
<TR>
<TD>
<A NAME="me">me</A>
</TD>
<TD>
<I>FQDN of system</I>
</TD>
<TD>
various
</TD>
<TD>
default for many control files
</TD>
</TR>
<TR>
<TD>
<A NAME="morercpthosts">morercpthosts</A>
</TD>
<TD>
<I>none</I>
</TD>
<TD>
qmail-smtpd
</TD>
<TD>
secondary rcpthosts database
</TD>
</TR>
<TR>
<TD>
<A NAME="percenthack">percenthack</A>
</TD>
<TD>
<I>none</I>
</TD>
<TD>
qmail-send
</TD>
<TD>
domains that can use &quot;%&quot;-style relaying
</TD>
</TR>
<TR>
<TD>
<A NAME="plusdomain">plusdomain</A>
</TD>
<TD>
me
</TD>
<TD>
qmail-inject
</TD>
<TD>
domain substituted for trailing &quot;+&quot;
</TD>
</TR>
<TR>
<TD>
<A NAME="qmqpservers">qmqpservers</A>
</TD>
<TD>
<I>none</I>
</TD>
<TD>
qmail-qmqpc
</TD>
<TD>
IP addresses of QMQP servers
</TD>
</TR>
<TR>
<TD>
<A NAME="queuelifetime">queuelifetime</A>
</TD>
<TD>
604800
</TD>
<TD>
qmail-send
</TD>
<TD>
seconds a message can remain in queue
</TD>
</TR>
<TR>
<TD>
<A NAME="rcpthosts">rcpthosts</A>
</TD>
<TD>
<I>none</I>
</TD>
<TD>
qmail-smtpd
</TD>
<TD>
domains that we accept mail for
</TD>
</TR>
<TR>
<TD>
<A NAME="smtpgreeting">smtpgreeting</A>
</TD>
<TD>
me
</TD>
<TD>
qmail-smtpd
</TD>
<TD>
SMTP greeting message
</TD>
</TR>
<TR>
<TD>
<A NAME="smtproutes">smtproutes</A>
</TD>
<TD>
<I>none</I>
</TD>
<TD>
qmail-remote
</TD>
<TD>
artificial SMTP routes
</TD>
</TR>
<TR>
<TD>
<A NAME="timeoutconnect">timeoutconnect</A>
</TD>
<TD>
60
</TD>
<TD>
qmail-remote
</TD>
<TD>
how long, in seconds, to wait for SMTP connection
</TD>
</TR>
<TR>
<TD>
<A NAME="timeoutremote">timeoutremote</A>
</TD>
<TD>
1200
</TD>
<TD>
qmail-remote
</TD>
<TD>
how long, in seconds, to wait for remote server
</TD>
</TR>
<TR>
<TD>
<A NAME="timeoutsmtpd">timeoutsmtpd</A>
</TD>
<TD>
1200
</TD>
<TD>
qmail-smtpd
</TD>
<TD>
how long, in seconds, to wait for SMTP client
</TD>
</TR>
<TR>
<TD>
<A NAME="virtualdomains">virtualdomains</A>
</TD>
<TD>
<I>none</I>
</TD>
<TD>
qmail-send
</TD>
<TD>
virtual domains and users
</TD>
</TR>
</TABLE>

<P>For more information about a particular control file, see the man page for the module listed under &quot;Used by&quot;.</P>
<H2><A NAME="relaying">3.2. Relaying</A></H2>
<H3><A NAME="relaying-intro">3.2.1. Introduction</A></H3>
<P>What is <I>relaying</I>? It's when an MTA accepts a message via SMTP that doesn't <I>appear</I> to be either <B>for</B> a local address or <B>from</B> a local sender.</P>
<P>In the pre-spam days, it was common for MTA's to be configured as <I>open</I> relays: promiscuous servers that would accept mail from anyone, for anyone.</P>
<P>Most MTA's now are configured to either completely disable relaying, or to only a allow certain trusted users or systems to use them as a relay.</P>
<P>Chris Johnson has written a very nice document on the topic for <I>qmail</I> users. I encourage you to visit <A HREF="http://www.palomine.net/qmail/relaying.html">http://www.palomine.net/qmail/relaying.html</A>.</P>
<H3><A NAME="relaying-disabling">3.2.2. Disabling relaying</A></H3>
<P>If you follow the official directions for installing <I>qmail</I>, relaying will be turned off by default. This is accomplished by populating the file <TT>/var/qmail/control/rcpthosts</TT> with the fully-qualified domain names listed in <TT>locals</TT> and <TT>virtualdomains</TT> (the local hosts). The name of the control file, <TT>rcpthosts</TT>, comes from the SMTP <TT>RCPT</TT> (recipient) command. In an SMTP session, RCPT is used to specify the addresses of the recipients of a message. <TT>rcpthosts</TT>, then, lists the valid hostnames that can appear in a RCPT address.</P>
<H3><A NAME="relaying-selective">3.2.3. Allowing selective relaying</A></H3>
<P>Most single-user and small workgroup servers can disable relaying completely, but if you have to support a distributed user community, you'll need a way to allow your users, and <I>only</I> your users, to use your system as a relay. This is accomplished by using <I>tcpserver</I> to set the <TT>RELAYCLIENT</TT> environment variable, which tells <TT>qmail-smtpd</TT> to override the <TT>rcpthosts</TT> file.</P>
<P>If you follow the installation instructions in this document, selective relaying will be enabled by default. To give a client relay access, add an entry to <TT>/etc/tcp.smtp</TT> like:</P>
<PRE>
    <I>IP address of client</I>:allow,RELAYCLIENT=&quot;&quot;
</PRE>
<P>Then rebuild the SMTP access database by doing:</P>
<PRE>
    qmailctl cdb
</PRE>
<P>or:</P>
<PRE>
    tcprules /etc/tcp.smtp.cdb /etc/tcp.smtp.tmp &lt; /etc/tcp.smtp
    chmod 644 /etc/tcp.smtp*
</PRE>
<P>If you followed the official installation instructions, Chris Johnson has written another very nice document on how to configure <I>qmail</I> to allow selected hosts to relay. See <A HREF="http://www.palomine.net/qmail/selectiverelay.html">http://www.palomine.net/qmail/selectiverelay.html</A>.</P>
<H3><A NAME="smarthost-relay">3.2.4. Relaying to a smart host</A></H3>
<P>For anyone setting up a mail server on a typical home broadband service, there is a good chance that your IP address will get blacklisted by organizations like SORBS (<A HREF="http://www.dnsbl.sorbs.net/lookup.shtml">http://www.dnsbl.sorbs.net/lookup.shtml</A>) in an effort to block spam. Most ISPs provide an SMTP server that will relay all mail from their customers, and such servers are usually not blacklisted. For example, the Road Runner service in Cincinnati, Ohio, has <TT>smtp-server.cinci.rr.com</TT> available to their customers. You can tell qmail to route all outgoing SMTP traffic through that server by doing:</P>
<PRE>
  echo &quot;:smtp-server.cinci.rr.com&quot; &gt; /var/qmail/control/smtproutes
</PRE>
<P>The <TT>smtproutes</TT> file can perform more routing functions than this; see the <TT>qmail-remote</TT> man page for more details.</P>
<H2><A NAME="multiple-hostnames">3.3. Multiple host names</A></H2>
<P>If your system is known by more than one name, e.g., all addresses of the form <TT><I>user</I>@host1.example.com</TT> can also be written as <TT><I>user</I>@example.com</TT> or <TT><I>user</I>@mail.example.com</TT>, then you need to tell <I>qmail</I> this so it'll know which addresses it should deliver locally and which messages it should accept from remote systems.</P>
<P>To do this, just add all of the names to two control files:</P>
<UL>
<LI><TT>rcpthosts</TT>, which tells <TT>qmail-smtpd</TT> to accept mail addressed to these hosts, and
<LI><TT>locals</TT>, which tells <TT>qmail-send</TT> that addresses on these hosts are to be delivered locally.</UL>
<P>Send <TT>qmail-send</TT> a <TT>HUP</TT> (hangup) signal to tell it to reread <TT>locals</TT>. If you have <TT>qmailctl</TT>, you can do:</P>
<PRE>
    qmailctl reload
</PRE>
<H2><A NAME="virtual-domains">3.4. Virtual domains</A></H2>
<P>Virtual domains are similar to the multiple host names discussed in the previous section, but there are some important differences. First, if <TT>example.net</TT> hosts the virtual domain <TT>virtual.example.com</TT>, it's generally <B>not</B> true that messages sent to <TT>joe@example.net</TT> should end up in the same mailbox as messages sent to <TT>joe@virtual.example.com</TT>. The namespace for each virtual domain is distinct.</P>
<P>With <I>qmail</I>, virtual domains are configured in the <TT>virtualdomains</TT> file, which consists of one or more entries of the form:</P>
<PRE>
    <I>user</I>@<I>domain</I>:<I>prepend</I>
</PRE>
<P><I>qmail</I> converts <TT><I>user</I>@<I>domain</I></TT> to <TT><I>prepend</I>-<I>user</I>@<I>domain</I></TT> and treats the result as if <TT><I>domain</I></TT> was local. The <TT><I>user</I>@</TT> part is optional. If it's omitted, the entry matches <I>all</I> <TT>@<I>domain</I></TT> addresses.</P>
<P>Returning to the example scenario above, if the example.net mail administrator wanted to create a virtual domain, <TT>virtual.example.com</TT>, under the administrative control of user <TT>john</TT>, the following entry in <TT>virtualdomains</TT> would accomplish that:</P>
<PRE>
    virtual.example.com:john
</PRE>
<P>An incoming message to <TT>joe@virtual.example.com</TT> would be rewritten as <TT>john-joe@virtual.example.com</TT> and delivered locally. See the <A HREF="#dot-qmail-files">.qmail</A> section, and the <A HREF="#extension-addresses">extension addresses</A> subsection for more information about how john can manage his virtual domain.</P>
<P>As with multiple host names, all virtual domains must be listed in <TT>rcpthosts</TT> so <TT>qmail-smtpd</TT> will know to accept messages addressed to them. However, unlike multiple host names, virtual domains <B>must</B> <B>not</B> be added to <TT>locals</TT>.</P>
<P>After modifying <TT>virtualdomains</TT>, send <TT>qmail-send</TT> a <TT>HUP</TT> (hangup) signal to tell it to reread the file. If you have <TT>qmailctl</TT>, you can do:</P>
<PRE>
    qmailctl reload
</PRE>
<P>Don't forget to add virtual domains to <TT>rcpthosts</TT>, too.</P>
<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG>Domain name server (DNS) mail exchanger (MX) records must be set up to direct messages for virtual domains to the appropriate mail server. This is a job for the name server administrator and is beyond the scope of this guide.
<HR WIDTH="80%" ALIGN="Left"></P>
<H2><A NAME="aliases">3.5. Aliases</A></H2>
<P><I>qmail</I>'s standard aliasing mechanism is a natural outgrowth of <I>qmail</I>'s local delivery mechanism. <TT>qmail-local</TT> attempts to deliver a message addressed to <TT><I>localpart</I>@host</TT> to a local user named <TT><I>localpart</I></TT>. If no matching user is found, the message is delivered to the <TT>alias</TT> user, a pseudo-user on all <I>qmail</I> systems whose home directory is usually <TT>/var/qmail/alias</TT>.</P>
<P>For example, say you want to create an <TT>info@example.com</TT> alias that forwards messages to user <TT>tom</TT>. On <TT>example.com</TT>, do, as user <TT>root</TT>:</P>
<PRE>
    echo \&amp;tom &gt; /var/qmail/alias/.qmail-info
</PRE>
<P>The <TT><A HREF="#dot-qmail-files">.qmail</A></TT> section and <A HREF="#extension-addresses">extension addresses</A> subsection describe how to create <TT>.qmail</TT> files that specify which aliases exist, and what to do with messages sent to them.</P>
<P>The <A HREF="#gotchas">Gotchas</A> appendix covers a couple of tricky cases regarding the usage of alias--aliases containing uppercase characters and dots ('.')--and <TT>man dot-qmail</TT> contains complete documentation of the usage of <TT>.qmail</TT> files.</P>
<P>Note that because of the way aliases are implemented in <I>qmail</I>, an alias can <B>never</B> override a valid user's deliveries. E.g., if <TT>rachel</TT> is a normal user, <TT>~alias/.qmail-rachel</TT> will not be used.</P>
<P>The <I><A HREF="#fastforward">fastforward</A></I> package provides an alternative aliasing mechanism that puts multiple aliases in a single file compatible with <I>Sendmail</I>'s alias database.</P>
<P>The next section, qmail-users, describes another mechanism that can be used to implement aliases.</P>
<H2><A NAME="qmail-users">3.6. qmail-users</A></H2>
<P><I>qmail-users</I> is a system for assigning addresses to users. A series of configuration files resides under <TT>/var/qmail/users</TT>. The <TT>assign</TT> file is a table of assignments. There are two kinds of assignments: simple and wildcard.</P>
<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG><TT>assign</TT> contains a series of assignments, one per line, followed by a line containing a single dot (.). If you create <TT>assign</TT> manually, don't forget the dot line.
<HR WIDTH="80%" ALIGN="Left"></P>
<H3><A NAME="simple-assignment">3.6.1. Simple assignment</A></H3>
<P>A simple assignment looks like:</P>
<PRE>
=<I>address</I>:<I>user</I>:<I>uid</I>:<I>gid</I>:<I>directory</I>:<I>dash</I>:<I>extension</I>:
</PRE>
<P>What this means is that messages received for <I>address</I> will be delivered as user <I>user</I>, with the specified <I>uid</I> and <I>gid</I>, and the file <TT><I>directory</I>/.qmail<I>dash</I><I>extension</I></TT> will specify how the messages are to be delivered.</P>
<H3><A NAME="wildcard-assignment">3.6.2. Wildcard assignment</A></H3>
<P>A wildcard assignment looks like:</P>
<PRE>
+<I>prefix</I>:<I>user</I>:<I>uid</I>:<I>gid</I>:<I>directory</I>:<I>dash</I>:<I>prepend</I>:
</PRE>
<P>What this means is that messages received for addresses of the form <I>prefix</I><I>rest</I> will be delivered as user <I>user</I>, with the specified <I>uid</I> and <I>gid</I>, and the file <TT><I>directory</I>/.qmail<I>dash</I><I>prepend</I><I>rest</I></TT> will specify how the messages are to be delivered.</P>
<H3><A NAME="qmail-user-programs">3.6.3. qmail-user programs</A></H3>
<P>qmail-user has two helper programs: <TT>qmail-newu</TT> and <TT>qmail-pw2u</TT>.</P>
<P><TT>qmail-newu</TT> processes the <TT>assign</TT> file and generates a constant database (CDB) file called <TT>cdb</TT> in <TT>/var/qmail/users</TT>. CDB is a binary format that can be accessed quickly by <TT>qmail-lspawn</TT>, even when there are thousands of assignments.</P>
<P><TT>qmail-pw2u</TT> converts the system user database, <TT>/etc/passwd</TT>, into a series of assignments suitable for <TT>assign</TT>. <TT>qmail-pw2u</TT> uses a set of files to modify the translation rules.</P>
<UL>
<LI><TT>include</TT>: users to include
<LI><TT>exclude</TT>: users to exclude
<LI><TT>mailnames</TT>: alternative &quot;mailnames&quot; for users
<LI><TT>subusers</TT>: extra addresses handled by a user, with an optional <TT>.qmail</TT> extension
<LI><TT>append</TT>: miscellaneous assignments</UL>
<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG>If you use <TT>qmail-pw2u</TT>, don't forget to re-run <TT>qmail-pw2u</TT> and <TT>qmail-newu</TT> whenever you add users, remove users, or change UID's or GID's. A typical sequence would be:</P>
<PRE>
    qmail-pw2u &lt;/etc/passwd &gt;/var/qmail/users/assign
    qmail-newu
</PRE>
<P><HR WIDTH="80%" ALIGN="Left"></P>
<H2><A NAME="spam">3.7. Spam Control</A></H2>
<P>Chris Hardie has written an excellent <I>qmail</I> Anti-Spam HOWTO. It's available from <A HREF="http://www.summersault.com/chris/techno/qmail/qmail-antispam.html">http://www.summersault.com/chris/techno/qmail/qmail-antispam.html</A>.</P>
<H2><A NAME="viruses">3.8. Virus Scanning</A></H2>
<P>Jason Haar has written Qmail-Scanner, a content scanning harness for <I>qmail</I>. See <A HREF="http://qmail-scanner.sourceforge.net/">http://qmail-scanner.sourceforge.net/</A> for more information.</P>
<P>Qmail-Scanner includes a simple &quot;policy-blocking&quot; component (e.g. block *.scr, or block &quot;Subject: Yellow!&quot;) as well as directly supporting many different antivirus &quot;plugins&quot; including the ClamAV Antivirus scanner available from <A HREF="http://www.ClamAV.net">http://www.ClamAV.net</A>.</P>
<HR>
<H1><A NAME="usage">4. Usage</A></H1>
<P>This section covers the usage of <I>qmail</I> by normal users. If you read or send mail on a <I>qmail</I> system, this is where you'll find information about how to do that with <I>qmail</I>.</P>
<H2><A NAME="dot-qmail-files">4.1. <TT>.qmail</TT> files</A></H2>
<P>Delivery of a user's mail is usually controlled by one or more &quot;.qmail&quot; (pronounced <I>dot kyoo mail</I>) files--files in the user's home directory with names beginning with <TT>.qmail</TT>. The <TT>dot-qmail</TT> man page describes <TT>.qmail</TT> file usage.</P>
<P><TT>.qmail</TT> files contain a list of delivery instructions, one instruction per line. The first character of the line determines what kind of delivery is involved:</P>
<TABLE CLASS="columns" BORDER>
<TR CLASS="heading">
<TD>
<STRONG>Character</STRONG>
</TD>
<TD>
<STRONG>Delivery Type</STRONG>
</TD>
<TD>
<STRONG>Value</STRONG>
</TD>
</TR>
<TR>
<TD>
#
</TD>
<TD>
none <I>(comment)</I>
</TD>
<TD>
ignored
</TD>
</TR>
<TR>
<TD>
|
</TD>
<TD>
program
</TD>
<TD>
command to be run by shell
</TD>
</TR>
<TR>
<TD>
/ or .
</TD>
<TD>
mbox <I>(if last char isn't a /)</I>
</TD>
<TD>
pathname of mbox <I>(including the / or .)</I>
</TD>
</TR>
<TR>
<TD>
/ or .
</TD>
<TD>
maildir <I>(if last char is a /)</I>
</TD>
<TD>
pathname of maildir <I>(including the / or .)</I>
</TD>
</TR>
<TR>
<TD>
&amp;
</TD>
<TD>
forward
</TD>
<TD>
address to forward message
</TD>
</TR>
<TR>
<TD>
letter or number
</TD>
<TD>
forward
</TD>
<TD>
address to forward message <I>(including the first char)</I>
</TD>
</TR>
</TABLE>

<H3><A NAME="program-delivery">4.1.1. program delivery</A></H3>
<P>When a program delivery instruction is encountered, <I>qmail</I> starts a shell (<TT>/bin/sh</TT>) to execute the command and feeds the command a copy of the incoming message on standard input. The <TT>qmail-command</TT> man page documents the details of this process.</P>
<P>Program delivery is very powerful, and can be used to implement a wide range of functionality such as message filtering, automatically responding to messages, and delivery via third-party delivery agents such as <I>procmail</I>.</P>
<P>E.g.:</P>
<PRE>
    |preline /usr/ucb/vacation djb
</PRE>
<P>This causes <I>qmail</I> to start <TT>preline</TT>, pass it <TT>/usr/ucb/vacation</TT> and <TT>djb</TT> as arguments, and provide a copy of the message on standard input.</P>
<H3><A NAME="mbox-delivery">4.1.2. mbox delivery</A></H3>
<P>Mbox is the standard UNIX mailbox format in which multiple messages are stored in a single file and messages are headed with a &quot;<TT>From </TT>&quot; line. This line looks like a header field, but it isn't one: it's just something the delivery agent adds so mail readers can tell where each message begins.</P>
<P>E.g.:</P>
<PRE>
    ./Mailbox
</PRE>
<P>This causes messages to be appended to <TT>$HOME/Mailbox</TT>, with a &quot;<TT>From </TT>&quot; line prepended. A simple mbox mailbox with a single message looks like:</P>
<PRE>
    From user1@example.net Thu May 13 18:34:50 1999
    Received: (qmail 1287205 invoked from network); 13 May 1999 18:34:49 -0000
    From: user1@example.net
    To: user2@example.com
    Subject: hey

    What's up?
</PRE>
<P>The first line was added at delivery by <I>qmail</I>.</P>
<H3><A NAME="maildir-delivery">4.1.3. maildir delivery</A></H3>
<P>Maildir is a mailbox format created by Dan Bernstein to address the shortcomings of the mbox format. A maildir mailbox is a directory containing three subdirectories, <TT>new</TT>, <TT>cur</TT>, and <TT>tmp</TT>. Each message in a maildir mailbox is in a separate file in one of the subdirectories, depending upon its status: <TT>new</TT> is for unread messages, <TT>cur</TT> is for messages that have been seen, and <TT>tmp</TT> is for messages in the process of being delivered. The <TT>maildir</TT> man page describes the format of a maildir in detail.</P>
<P>One of the benefits of the maildir format is that, even though it doesn't use locking to prevent simultaneous updates from different delivery agents, it's reliable. This means maildir mailboxes can safely reside on NFS-mounted filesystems.</P>
<P>E.g.:</P>
<PRE>
    ./Maildir/
</PRE>
<P>This causes messages to be saved in <TT>$HOME/Maildir</TT>, a maildir-format mailbox.</P>
<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG><TT>qmail-local</TT> can deliver mail to maildir mailboxes, but it can't create them. Maildir mailboxes should be created with the <TT>maildirmake</TT> program that comes with <I>qmail</I>. E.g., &quot;<TT>maildirmake ~/Maildir</TT>&quot;. Be sure to run <TT>maildirmake</TT> as the owner of the maildir, <B>not</B> as root. Your <TT>useradd</TT> or <TT>adduser</TT> command might support a &quot;skeleton&quot; directory, e.g. <TT>/etc/skel</TT>, where you can create a maildir that will be copied for all new users.
<HR WIDTH="80%" ALIGN="Left"></P>
<H3><A NAME="forward-delivery">4.1.4. forward delivery</A></H3>
<P>Forward deliveries causes the message to be resent to the specified address. Addresses specified in <TT>.qmail</TT> files can't contain comment fields or extra spaces.</P>
<P>These are <B>wrong</B>:</P>
<PRE>
    &amp;&lt;user@example.com&gt;
    &amp; user@example.com
    &amp;Joe User &lt;user@example.com&gt;
</PRE>
<P>These are correct:</P>
<PRE>
    &amp;user@example.com
    user@example.com
    &amp;user
</PRE>
<P>The first two cause <TT>user@example.com</TT> to receive a copy of the message. The last sends a copy to the local user <TT>user</TT>.</P>
<H3><A NAME="extension-addresses">4.1.5. extension addresses</A></H3>
<P><I>qmail</I> supports user-controlled extension addresses. In addition to the base address, <TT><I>username</I>@<I>hostname</I>.<I>domain</I></TT>, users can receive mail at <TT><I>username</I>-<I>extension</I>@<I>hostname</I>.<I>domain</I></TT>. For the remainder of this section, I'll leave off the &quot;@<I>hostname</I>.<I>domain</I>&quot; part since we're considering actions that take place on the local system.</P>
<P>The delivery instructions for <TT><I>username</I></TT> are in <TT>~<I>username</I>/.qmail</TT> and the delivery instructions for <TT><I>username</I>-<I>extension</I></TT> are in <TT>~<I>username</I>/.qmail-<I>extension</I></TT>.</P>
<P>For example, <TT>dave-lwq@sparge.example.com</TT> is controlled by <TT>~dave/.qmail-lwq</TT> on host sparge.</P>
<P>Extensions can have multiple fields, e.g., <TT>dave-list-qmail</TT>, controlled by <TT>~dave/.qmail-list-qmail</TT>. In this example, <TT>dave-list-qmail</TT> is subscribed to the qmail mailing list, and <TT>~dave/.qmail-list-qmail</TT> files the list messages in a separate mailbox.</P>
<P><TT>.qmail</TT> files can be <I>wildcarded</I> using <TT>-default</TT>. So <TT>dave-list-qmail</TT> could also be handled by <TT>~dave/.qmail-list-default</TT>. This would allow one catch-all <TT>.qmail</TT> file to handle all <TT>dave-list-<I>whatever</I></TT> addresses. Note that <TT>dave-list</TT> wouldn't be handled by <TT>~dave/.qmail-list-default</TT> because it doesn't match the &quot;-&quot; after &quot;list&quot;.</P>
<P><I>qmail</I> uses the closest match it finds. E.g., when a message comes in addressed to <TT>dave-list-qmail</TT>, it'll use the first one of the following that it finds:</P>
<PRE>
    .qmail-list-qmail
    .qmail-list-default
    .qmail-default
</PRE>
<P>If no matching <TT>.qmail</TT> file is found, the delivery fails and the message bounces back to the sender.</P>
<H2><A NAME="sending-messages">4.2. Sending messages</A></H2>
<P>Mail users usually don't use the MTA directly to send messages. Typically, messages are composed and sent using a Mail User Agent (MUA) such as <I>pine</I> or <I>mutt</I>, which then calls the MTA to deliver the message. The process of handing a message to the MTA is called <I>injection</I>.</P>
<P>There are two ways to inject messages into most MTA's: via the Simple Mail Transfer Protocol, SMTP, or using a program provided by the MTA for that purpose.</P>
<H3><A NAME="smtp">4.2.1. SMTP</A></H3>
<P>MUA's can open a TCP connection to port 25, the standard SMTP port, on the local host or a designated mail server. The MUA and the MTA then engage in a dialogue that results in either:</P>
<UL>
<LI>the message being transfered to the MTA, or
<LI>a error status being returned to the MUA</UL>
<P>SMTP has no mechanism for authentication, so no username or password is required to send a message. However, many MTA's refuse to accept messages that don't appear to be either from or for a local user. If a properly formatted message is rejected, relaying restrictions are the most likely cause. See the <A HREF="#relaying">Relaying section</A> for more information about relay configuration.</P>
<H3><A NAME="/var/qmail/bin/sendmail">4.2.2. <TT>/var/qmail/bin/sendmail</TT></A></H3>
<P>For many years, <I>Sendmail</I> was <I>the</I> UNIX MTA. It was so ubiquitous, that many programmers just assumed that it was the MTA. As a result, <I>Sendmail</I>'s local injection mechanism became the standard Application Programmer's Interface (API) for local mail injection. <I>qmail</I> and other non-<I>Sendmail</I> MTA's provide a <TT>sendmail</TT> program that works the same way as the real <I>Sendmail</I>'s <TT>sendmail</TT> for local injection.</P>
<P>The <I>qmail</I> <TT>sendmail</TT>, which is normally in <TT>/var/qmail/bin/sendmail</TT>, usually replaces the <I>Sendmail</I> <TT>sendmail</TT> on <I>qmail</I> systems. Typical locations of the <TT>sendmail</TT> program include:</P>
<UL>
<LI><TT>/usr/lib/sendmail</TT>
<LI><TT>/usr/sbin/sendmail</TT></UL>
<P>On a <I>qmail</I> system, &quot;<TT>ls -l <I>path-to-sendmail</I></TT>&quot; should show that <TT>sendmail</TT> is a symbolic link to <TT>/var/qmail/bin/sendmail</TT>:</P>
<PRE>
  $ ls -l /usr/lib/sendmail
  lrwxrwxrwx   1 root     root           29 Feb 19 11:04 /usr/lib/sendmail -&gt; /var/qmail/bin/sendmail
</PRE>
<H3><A NAME="qmail-inject">4.2.3. <TT>qmail-inject</TT></A></H3>
<P>In addition to emulating the <TT>sendmail</TT> API, <I>qmail</I> has its own injection program: <TT>qmail-inject</TT>. In fact, <TT>sendmail</TT> is just a wrapper around <TT>qmail-inject</TT>.</P>
<P>As an API, <TT>sendmail</TT> is probably better because it's much more widely available. The <I>qmail</I> API provided by <TT>qmail-inject</TT> will only work on systems with <I>qmail</I>, but the <TT>sendmail</TT> interface is nearly universal.</P>
<P>For example, to send a blank message to <TT>joe@example.com</TT>:</P>
<PRE>
 echo To: joe@example.com | /var/qmail/bin/qmail-inject
</PRE>
<H2><A NAME="environment-variables">4.3. Environment Variables</A></H2>
<P>Some <I>qmail</I> programs set or use environment variables. The following table lists these variables and describes their use.</P>
<TABLE CLASS="columns" BORDER>
<TR CLASS="heading">
<TD>
<STRONG>Name</STRONG>
</TD>
<TD>
<STRONG>Man page</STRONG>
</TD>
<TD>
<STRONG>Set or used</STRONG>
</TD>
<TD>
<STRONG>Purpose</STRONG>
</TD>
</TR>
<TR>
<TD>
<A NAME="DATABYTES">DATABYTES</A>
</TD>
<TD>
<TT>qmail-smtpd</TT>
</TD>
<TD>
used
</TD>
<TD>
Overrides <TT>control/databytes</TT>
</TD>
</TR>
<TR>
<TD>
<A NAME="DEFAULT">DEFAULT</A>
</TD>
<TD>
<TT>qmail-command</TT>
</TD>
<TD>
set
</TD>
<TD>
Portion of address matching &quot;-default&quot; in a <TT>.qmail</TT> file name.
</TD>
</TR>
<TR>
<TD>
<A NAME="DTLINE">DTLINE</A>
</TD>
<TD>
<TT>qmail-command</TT>
</TD>
<TD>
set
</TD>
<TD>
Delivered-To header field
</TD>
</TR>
<TR>
<TD>
<A NAME="EXT">EXT</A>
</TD>
<TD>
<TT>qmail-command</TT>
</TD>
<TD>
set
</TD>
<TD>
The address extension
</TD>
</TR>
<TR>
<TD>
<A NAME="EXT2">EXT2</A>
</TD>
<TD>
<TT>qmail-command</TT>
</TD>
<TD>
set
</TD>
<TD>
Portion of <TT>EXT</TT> following first dash
</TD>
</TR>
<TR>
<TD>
<A NAME="EXT3">EXT3</A>
</TD>
<TD>
<TT>qmail-command</TT>
</TD>
<TD>
set
</TD>
<TD>
Portion of <TT>EXT</TT> following second dash
</TD>
</TR>
<TR>
<TD>
<A NAME="EXT4">EXT4</A>
</TD>
<TD>
<TT>qmail-command</TT>
</TD>
<TD>
set
</TD>
<TD>
Portion of <TT>EXT</TT> following third dash
</TD>
</TR>
<TR>
<TD>
<A NAME="HOME">HOME</A>
</TD>
<TD>
<TT>qmail-command</TT>
</TD>
<TD>
set
</TD>
<TD>
The user's home directory
</TD>
</TR>
<TR>
<TD>
<A NAME="HOST">HOST</A>
</TD>
<TD>
<TT>qmail-command</TT>
</TD>
<TD>
set
</TD>
<TD>
The <I>domain</I> part of the recipient address
</TD>
</TR>
<TR>
<TD>
<A NAME="HOST2">HOST2</A>
</TD>
<TD>
<TT>qmail-command</TT>
</TD>
<TD>
set
</TD>
<TD>
Portion of <TT>HOST</TT> preceding last dot.
</TD>
</TR>
<TR>
<TD>
<A NAME="HOST3">HOST3</A>
</TD>
<TD>
<TT>qmail-command</TT>
</TD>
<TD>
set
</TD>
<TD>
Portion of <TT>HOST</TT> preceding second-to-last dot
</TD>
</TR>
<TR>
<TD>
<A NAME="HOST4">HOST4</A>
</TD>
<TD>
<TT>qmail-command</TT>
</TD>
<TD>
set
</TD>
<TD>
Portion of <TT>HOST</TT> preceding third-to-last dot
</TD>
</TR>
<TR>
<TD>
<A NAME="LOCAL">LOCAL</A>
</TD>
<TD>
<TT>qmail-command</TT>
</TD>
<TD>
set
</TD>
<TD>
The <I>local</I> part of the recipient address
</TD>
</TR>
<TR>
<TD>
<A NAME="LOGNAME">LOGNAME</A>
</TD>
<TD>
<TT>qmail-inject</TT>
</TD>
<TD>
used
</TD>
<TD>
User name in From header field (4)
</TD>
</TR>
<TR>
<TD>
<A NAME="MAILHOST">MAILHOST</A>
</TD>
<TD>
<TT>qmail-inject</TT>
</TD>
<TD>
used
</TD>
<TD>
Host name in From header field (2)
</TD>
</TR>
<TR>
<TD>
<A NAME="MAILNAME">MAILNAME</A>
</TD>
<TD>
<TT>qmail-inject</TT>
</TD>
<TD>
used
</TD>
<TD>
Personal name in From header field (2)
</TD>
</TR>
<TR>
<TD>
<A NAME="MAILUSER">MAILUSER</A>
</TD>
<TD>
<TT>qmail-inject</TT>
</TD>
<TD>
used
</TD>
<TD>
User name in From header field (2)
</TD>
</TR>
<TR>
<TD>
<A NAME="NAME">NAME</A>
</TD>
<TD>
<TT>qmail-inject</TT>
</TD>
<TD>
used
</TD>
<TD>
Personal name in From header field (3)
</TD>
</TR>
<TR>
<TD>
<A NAME="NEWSENDER">NEWSENDER</A>
</TD>
<TD>
<TT>qmail-command</TT>
</TD>
<TD>
set
</TD>
<TD>
Forwarding sender address (see &quot;man dot-qmail&quot;)
</TD>
</TR>
<TR>
<TD>
<A NAME="QMAILDEFAULTDOMAIN">QMAILDEFAULTDOMAIN</A>
</TD>
<TD>
<TT>qmail-inject</TT>
</TD>
<TD>
used
</TD>
<TD>
Overrides <TT>control/defaultdomain</TT>
</TD>
</TR>
<TR>
<TD>
<A NAME="QMAILDEFAULTHOST">QMAILDEFAULTHOST</A>
</TD>
<TD>
<TT>qmail-inject</TT>
</TD>
<TD>
used
</TD>
<TD>
Overrides <TT>control/defaulthost</TT>
</TD>
</TR>
<TR>
<TD>
<A NAME="QMAILHOST">QMAILHOST</A>
</TD>
<TD>
<TT>qmail-inject</TT>
</TD>
<TD>
used
</TD>
<TD>
Host name in From header field (1)
</TD>
</TR>
<TR>
<TD>
<A NAME="QMAILIDHOST">QMAILIDHOST</A>
</TD>
<TD>
<TT>qmail-inject</TT>
</TD>
<TD>
used
</TD>
<TD>
Overrides <TT>control/idhost</TT>
</TD>
</TR>
<TR>
<TD>
<A NAME="QMAILINJECT">QMAILINJECT</A>
</TD>
<TD>
<TT>qmail-inject</TT>
</TD>
<TD>
used
</TD>
<TD>
Specify various options (see next table)
</TD>
</TR>
<TR>
<TD>
<A NAME="QMAILMFTFILE">QMAILMFTFILE</A>
</TD>
<TD>
<TT>qmail-inject</TT>
</TD>
<TD>
used
</TD>
<TD>
File containing list of mailing list addresses for Mail-Followup-To generation
</TD>
</TR>
<TR>
<TD>
<A NAME="QMAILNAME">QMAILNAME</A>
</TD>
<TD>
<TT>qmail-inject</TT>
</TD>
<TD>
used
</TD>
<TD>
Personal name in From header field (1)
</TD>
</TR>
<TR>
<TD>
<A NAME="QMAILPLUSDOMAIN">QMAILPLUSDOMAIN</A>
</TD>
<TD>
<TT>qmail-inject</TT>
</TD>
<TD>
used
</TD>
<TD>
Overrides <TT>control/plusdomain</TT>
</TD>
</TR>
<TR>
<TD>
<A NAME="QMAILSHOST">QMAILSHOST</A>
</TD>
<TD>
<TT>qmail-inject</TT>
</TD>
<TD>
used
</TD>
<TD>
Host name in envelope sender address
</TD>
</TR>
<TR>
<TD>
<A NAME="QMAILSUSER">QMAILSUSER</A>
</TD>
<TD>
<TT>qmail-inject</TT>
</TD>
<TD>
used
</TD>
<TD>
User name in envelope sender address
</TD>
</TR>
<TR>
<TD>
<A NAME="QMAILUSER">QMAILUSER</A>
</TD>
<TD>
<TT>qmail-inject</TT>
</TD>
<TD>
used
</TD>
<TD>
User name in From header field (1)
</TD>
</TR>
<TR>
<TD>
<A NAME="RECIPIENT">RECIPIENT</A>
</TD>
<TD>
<TT>qmail-command</TT>
</TD>
<TD>
set
</TD>
<TD>
Envelope recipient address
</TD>
</TR>
<TR>
<TD>
<A NAME="RELAYCLIENT">RELAYCLIENT</A>
</TD>
<TD>
<TT>qmail-smtpd</TT>
</TD>
<TD>
used
</TD>
<TD>
Ignore <TT>control/rcpthosts</TT> and append value to recipient address
</TD>
</TR>
<TR>
<TD>
<A NAME="RPLINE">RPLINE</A>
</TD>
<TD>
<TT>qmail-command</TT>
</TD>
<TD>
set
</TD>
<TD>
Return-Path header field
</TD>
</TR>
<TR>
<TD>
<A NAME="SENDER">SENDER</A>
</TD>
<TD>
<TT>qmail-command</TT>
</TD>
<TD>
set
</TD>
<TD>
Envelope sender address
</TD>
</TR>
<TR>
<TD>
<A NAME="UFLINE">UFLINE</A>
</TD>
<TD>
<TT>qmail-command</TT>
</TD>
<TD>
set
</TD>
<TD>
UUCP-style &quot;From &quot; line
</TD>
</TR>
<TR>
<TD>
<A NAME="USER">USER</A>
</TD>
<TD>
<TT>qmail-command</TT>
</TD>
<TD>
set
</TD>
<TD>
The current user
</TD>
</TR>
<TR>
<TD>
<A NAME="USER">USER</A>
</TD>
<TD>
<TT>qmail-inject</TT>
</TD>
<TD>
used
</TD>
<TD>
User name in From header field (3)
</TD>
</TR>
</TABLE>

<TABLE CLASS="columns" BORDER>
<CAPTION ALIGN=top>QMAILINJECT Flags</CAPTION>
<TR CLASS="heading">
<TD>
<STRONG>Letter</STRONG>
</TD>
<TD>
<STRONG>Purpose</STRONG>
</TD>
</TR>
<TR>
<TD>
c
</TD>
<TD>
Use address-comment style for the From field
</TD>
</TR>
<TR>
<TD>
s
</TD>
<TD>
Do not look at any incoming Return-Path field
</TD>
</TR>
<TR>
<TD>
f
</TD>
<TD>
Delete any incoming From field
</TD>
</TR>
<TR>
<TD>
i
</TD>
<TD>
Delete any incoming Message-ID field
</TD>
</TR>
<TR>
<TD>
r
</TD>
<TD>
Use a per-recipient VERP
</TD>
</TR>
<TR>
<TD>
m
</TD>
<TD>
Use a per-message VERP
</TD>
</TR>
</TABLE>

<HR>
<H1><A NAME="advanced-topics">5. Advanced Topics</A></H1>
<H2><A NAME="procmail">5.1. <I>procmail</I></A></H2>
<P><I>procmail</I> is a popular Message Delivery Agent (MDA). The function of an MDA is to accept a message from the MTA for a specific user or mailbox, and deliver the message according to the user's desires. <I>procmail</I> can be used to &quot;filter&quot; messages by the content of various header fields or the body of the message. For example, messages from a particular person can be directed to a mailbox for just that person.</P>
<P>There are a couple tricks to running <I>procmail</I> with <I>qmail</I>. First, procmail is usually built to deliver to an mbox mailbox in <TT>/var/spool/mail</TT>. You can rebuild <I>procmail</I> to default to <TT>$HOME</TT> or you can instruct users not to rely on <I>procmail</I> to default the location of the mbox. Unless you patch it for <TT>$HOME</TT> delivery, <TT>procmail</TT> will still use <TT>/var/spool/mail</TT> for temporary files.</P>
<P>Another problem is that <TT>qmail-command</TT> and <TT>procmail</TT> don't have a common understanding of which exit codes mean what. <TT>procmail</TT> uses the standard UNIX exit codes: zero means <I>success</I>, nonzero means <I>failure</I>, and the cause of the failure is indicated by <TT>/usr/include/sys/errno.h</TT>. <TT>qmail-command</TT> uses certain nonzero codes to indicate permanent errors and the rest are considered temporary. A small shell script wrapper can be used to translate the exit codes for <TT>qmail-command</TT>. Such a wrapper was posted to the <I>qmail</I> list and is available from the archives at <A HREF="http://www.ornl.gov/lists/mailing-lists/qmail/1998/04/msg00487.html">http://www.ornl.gov/lists/mailing-lists/qmail/1998/04/msg00487.html</A>.</P>
<P>Also, older versions of <I>procmail</I> (prior to 3.14) don't deliver directly to maildir-format mailboxes. Your best bet is to upgrade to the current version of <I>procmail</I>. Another approach is <I>safecat</I>, a program that writes a message on standard input to a specified maildir. Users can write <I>procmail</I> recipes (delivery instructions) that use <I><A HREF="#safecat">safecat</A></I> to file the message. You can also skip <I>procmail</I> altogether, and use <I><A HREF="#maildrop">maildrop</A></I>.</P>
<P>Finally, <TT>procmail</TT> expects the messages it receives to be in mbox format. Normal <I>qmail</I> program deliveries include only the actual mail message, not including a &quot;<TT>From </TT>&quot; line. The <TT>preline</TT> command can be used to format the message as <TT>procmail</TT> expects. The wrapper linked above includes <TT>preline</TT>.</P>
<P>For example, let's say user &quot;dave&quot; wants his mail to be processed by <TT>procmail</TT>. His system administrator has built <TT>procmail</TT> to deliver to <TT>$HOME</TT> by default, and has provided the exit code wrapper linked above, called <TT>/usr/local/bin/qmail-procmail</TT>. His <TT>.qmail</TT> file should look like:</P>
<PRE>
    |/usr/local/bin/qmail-procmail
</PRE>
<H2><A NAME="pop-imap-servers">5.2. POP and IMAP servers</A></H2>
<P><I>qmail</I> includes a POP server, <I>qmail-pop3d</I>, but it's not configured and installed as part of the <I>qmail</I> installation process. You can also use one of the other POP or IMAP servers available, although most of them were written for <I>Sendmail</I> and will require some work to use with <I>qmail</I>.</P>
<H3><A NAME="qmail-pop3d">5.2.1. <I>qmail-pop3d</I></A></H3>
<P><I>qmail-pop3d</I> is the POP server included with <I>qmail</I>. It's a fine POP server, and many <I>qmail</I> sites use it. It's modular, and supports multiple authentication schemes via alternative authentication modules.</P>
<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG><I>qmail-pop3d</I> supports <B>only</B> maildir-format mailboxes, so if you have users logging into the POP server and running MUA's locally, they all have to support maildir. If all of your users read mail via POP, the mailbox format on the server is not an issue.
<HR WIDTH="80%" ALIGN="Left"></P>
<H4><A NAME="pop3d-arch">5.2.1.1. Architecture of <I>qmail-pop3d</I></A></H4>
<P>A <I>qmail-pop3d</I> server consists of three modules:</P>
<UL>
<LI><TT>qmail-popup</TT>--gets username/password
<LI><TT>checkpassword</TT>--authenticates username/password
<LI><TT>qmail-pop3d</TT>--the POP daemon</UL>
<P>Typically, <TT>qmail-popup</TT> is run via <TT>inetd</TT> or <TT>tcpserver</TT>, listening to port 110, the POP3 port. When a connection is made, it prompts for the username and password. Then it invokes <TT>checkpassword</TT>, which verifies the username/password and invokes <TT>qmail-pop3d</TT> if they match.</P>
<H4><A NAME="pop3d-installation">5.2.1.2. Installation of <I>qmail-pop3d</I></A></H4>
<P>1. Completely install and test <I>qmail</I>. If you want all users to have POPable mailboxes, make sure <I>defaultdelivery</I> is set to <TT>./Maildir/</TT>. If you installed the <TT>/var/qmail/rc</TT> script from the Installation section, this is configured in <TT>control/defaultdelivery</TT>. If not, it's probably in <TT>/var/qmail/rc</TT> on the <TT>qmail-start</TT> command line.</P>
<P>2. Download a <TT>checkpassword</TT> program from <A HREF="http://www.qmail.org/top.html#checkpassword">http://www.qmail.org/top.html#checkpassword</A>. The standard <TT>checkpassword</TT>, <A HREF="http://cr.yp.to/checkpwd.html">http://cr.yp.to/checkpwd.html</A>, is a good choice if you don't need anything fancy.</P>
<P>3. Compile and install <TT>checkpassword</TT> according to the directions. Make sure you install it as <TT>/bin/checkpassword</TT>.</P>
<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG>If you install the standard <TT>checkpassword</TT>, don't forget to apply the <TT>errno</TT> patch after unpacking the source:</P>
<PRE>
patch &lt; /usr/local/src/netqmail-1.06/other-patches/checkpassword-0.90.errno.patch
</PRE>
<P><HR WIDTH="80%" ALIGN="Left"></P>
<P>4. <TT>mkdir /var/qmail/supervise/qmail-pop3d</TT></P>
<P>5. Create a <TT>/var/qmail/supervise/qmail-pop3d/run</TT> script containing:</P>
<PRE>
#!/bin/sh
exec /usr/local/bin/softlimit -m 2000000 \
    /usr/local/bin/tcpserver -v -R -H -l 0 0 110 /var/qmail/bin/qmail-popup \
        <I>FQDN</I> /bin/checkpassword /var/qmail/bin/qmail-pop3d Maildir 2&gt;&amp;1
</PRE>
<P>where <I>FQDN</I> is the fully qualified domain name of the POP server you're setting up, e.g., <TT>pop.example.net</TT>.</P>
<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG>The memory limit specified in the <TT>softlimit</TT> command may need to be raised depending upon your operating system and hardware platform. If attempts to connect to port 110 fail or POP3 connections fail mysteriously, or you see a message like:</P>
<PRE>
  /usr/local/bin/tcpserver: error while loading shared libraries:
  libc.so.6: failed to map segment from shared object: Cannot
  allocate memory
</PRE>
<P>try raising it to 3000000 or 5000000.</P>
<P><HR WIDTH="80%" ALIGN="Left"></P>
<P>6. <TT>mkdir /var/qmail/supervise/qmail-pop3d/log</TT></P>
<P>7. Create a <TT>/var/qmail/supervise/qmail-pop3d/log/run</TT> script containing:</P>
<PRE>
#!/bin/sh
exec /usr/local/bin/setuidgid qmaill /usr/local/bin/multilog t \
    /var/log/qmail/pop3d
</PRE>
<P>8. Set up the log directory and permissions on the <TT>run</TT> scripts, and link the service into <TT>/service</TT>:</P>
<PRE>
    chmod +t /var/qmail/supervise/qmail-pop3d   <I># if daemontools &lt; 0.75</I>
    mkdir /var/log/qmail/pop3d
    chown qmaill /var/log/qmail/pop3d
    chmod 755 /var/qmail/supervise/qmail-pop3d/run
    chmod 755 /var/qmail/supervise/qmail-pop3d/log/run
    ln -s /var/qmail/supervise/qmail-pop3d /service
</PRE>
<P>9. Add the following to <TT>qmailctl</TT>'s &quot;start&quot; section:</P>
<PRE>
    if svok /service/qmail-pop3d ; then
      svc -u /service/qmail-pop3d /service/qmail-pop3d/log
    else
      echo qmail-pop3d supervise not running
    fi
</PRE>
<P>10. Add the following to <TT>qmailctl</TT>'s &quot;stop&quot; section:</P>
<PRE>
    echo &quot;  qmail-pop3d&quot;
    svc -d /service/qmail-pop3d /service/qmail-pop3d/log
</PRE>
<P>11. Add the following to <TT>qmailctl</TT>'s &quot;stat&quot; section:</P>
<PRE>
    svstat /service/qmail-pop3d
    svstat /service/qmail-pop3d/log
</PRE>
<P>12. Add the following to <TT>qmailctl</TT>'s &quot;pause&quot; section:</P>
<PRE>
    echo &quot;Pausing qmail-pop3d&quot;
    svc -p /service/qmail-pop3d
</PRE>
<P>13. Add the following to <TT>qmailctl</TT>'s &quot;cont&quot; section:</P>
<PRE>
    echo &quot;Continuing qmail-pop3d&quot;
    svc -c /service/qmail-pop3d
</PRE>
<P>14. Add the following to <TT>qmailctl</TT>'s &quot;restart&quot; section:</P>
<PRE>
    echo &quot;* Restarting qmail-pop3d.&quot;
    svc -t /service/qmail-pop3d /service/qmail-pop3d/log
</PRE>
<H3><A NAME="qpopper">5.2.2. <I>Qpopper</I></A></H3>
<P>If you need a POP daemon that works with mbox-format mailboxes, you can use Qualcomm's <I>Qpopper</I>. <I>Qpopper</I> is available from <A HREF="http://www.eudora.com/products/unsupported/qpopper/">http://www.eudora.com/products/unsupported/qpopper/</A>.</P>
<H3><A NAME="bincimap">5.2.3. <I>Binc IMAP</I></A></H3>
<P>Andreas Hanssen has written the <I>Binc IMAP</I> server. Binc IMAP is designed to use the same authentication mechanism (<TT>checkpassword</TT>) that <TT>qmail-pop3d</TT> uses, so it's a good fit for <I>qmail</I> servers. Like <TT>qmail-pop3d</TT>, it supports only Maildir mailboxes. See: <A HREF="http://www.bincimap.org/">http://www.bincimap.org/</A>.</P>
<H3><A NAME="dovecot">5.2.4. <I>Dovecot</I></A></H3>
<P>Timo Sirainen has written <I>Dovecot</I>, a IMAP and POP server that supports both mbox and maildir mailboxes. It was designed to be secure. It's available from <A HREF="http://www.dovecot.org/">http://www.dovecot.org/</A>.</P>
<H3><A NAME="imap-maildir">5.2.5. <I>imap-maildir</I></A></H3>
<P>David R. Harris has cleaned up the patch that adds maildir support to the University of Washington IMAP server and documented the installation process. See <A HREF="http://www.davideous.com/imap-maildir/">http://www.davideous.com/imap-maildir/</A>.</P>
<H3><A NAME="courier-imap">5.2.6. <I>Courier-IMAP</I></A></H3>
<P>Sam Varshavchik has written an IMAP server that supports maildir mailboxes <B>only</B>. It's available from <A HREF="http://www.courier-mta.org/imap/">http://www.courier-mta.org/imap/</A>.</P>
<H3><A NAME="cyrus">5.2.7. <I>Cyrus</I></A></H3>
<P>Carnegie Mellon University's Project Cyrus includes an IMAP server. It's available from <A HREF="http://asg.web.cmu.edu/cyrus/imapd/">http://asg.web.cmu.edu/cyrus/imapd/</A>. Rick Updegrove has written a <TT>qmail2cyrus</TT> wrapper for delivering messages to a Cyrus mail store. This wrapper is available from <A HREF="http://msgs.securepoint.com/cgi-bin/get/qmail0308/41/1/1.html">http://msgs.securepoint.com/cgi-bin/get/qmail0308/41/1/1.html</A>.</P>
<H2><A NAME="pop-imap-clients">5.3. POP and IMAP clients</A></H2>
<H3><A NAME="fetchmail">5.3.1. <I>fetchmail</I></A></H3>
<P><I>fetchmail</I> is a program that retrieves mail from a POP or IMAP server and re-injects it locally. <I>fetchmail</I> has no trouble retrieving mail from <I>qmail</I> servers, but there are a couple tricks for making it work well on a <I>qmail</I> client.</P>
<P>Here's a sample <TT>.fetchmailrc</TT> for a user on a <I>qmail</I> system:</P>
<PRE>
poll mail.example.net proto pop3 nodns
    user dsill with password flubgart is dave here
    fetchall forcecr
</PRE>
<P>This instructs <I>fetchmail</I> to connect to mail.example.net via POP3, log in as user <TT>dsill</TT>, password <TT>flubgart</TT>, retrieve all messages, and deliver them to dave@localhost. The <TT>forcecr</TT> causes <I>fetchmail</I> to end each line with a carriage return when injecting the message on the local system via SMTP. <I>qmail</I> requires this.</P>
<H3><A NAME="getmail">5.3.2. <I>getmail</I></A></H3>
<P><I>getmail</I> is a program that retrieves mail from a POP server and delivers it to a maildir mailbox. It's actually a Python script, so you may need to install the Python interpreter before you can use <I>getmail</I></P>
<P><I>getmail</I> was written by Charles Cazabon, who maintains a web page for it at <A HREF="http://pyropus.ca/software/getmail/">http://pyropus.ca/software/getmail/</A>.</P>
<H2><A NAME="multi-rcpt">5.4. Multi-RCPT vs. Single RCPT delivery</A></H2>
<P>Say you're an MTA, and one of your users sends a message to three people on hostx.example.com. There are several ways you could do this.</P>
<OL>
<LI>You could open an SMTP connection to hostx, send a copy of the message to the first user, send a copy to the second user, send a copy to the third user, then close the connection.
<LI>You could start three processes, each of which opens an SMTP connection to hostx, sends a copy of the message to one of the users, then closes the connection.
<LI>You could open an SMTP connection to host, send a copy of the message addressed to <I>all three users</I>, then close the connection.</OL>
<P>The first method is clearly inferior to the third. Even if the message is tiny, it'll take at least as long. And if the message is large, it'll take a lot longer <I>and</I> use more network bandwidth.</P>
<P>So scratch that one.</P>
<P>The second and third methods are a little more interesting.</P>
<P>The third method only opens one connection to hostx, and only sends one copy of the message. That makes for efficient use of bandwidth.</P>
<P>The second method uses multiple connections and sends multiple copies of the message. That &quot;wastes&quot; bandwidth, but due to the nature of the SMTP protocol, requires fewer round-trip delays, and is faster than the third method. It's also simpler than the third method, so the MTA can be coded in a more straightforward manner. And finally, because each recipient gets their own copy of the message, it's possible for the MTA to implement VERPs (see next section).</P>
<P><I>qmail</I> <I>always</I> uses the second method (single RCPT). There are no patches to implement the third method (multiple RCPT)--it would require <B>major</B> work.</P>
<P>Although there are pathological cases where it can be slower than multiple RCPT, the simplicity and VERP advantages outweigh that overall.</P>
<P>Single RCPT delivery <I>does</I> use more bandwidth than multiple RCPT delivery, but the difference is often exaggerated. Most messages have, at most, a couple recipients, and they're usually on separate hosts, so multi-RCPT delivery buys them nothing. Even on a list server, where multi-RCPT delivery could help, the potential gains are small because SMTP uses only a fraction of the bandwidth over most links--HTTP usually gets the lion's share.</P>
<P>For example, if 10% of your uplink's bandwidth goes to SMTP, and your SMTP bandwidth could be reduced by, say, 25%, by using multi-RCPT delivery, that would only drop your SMTP bandwidth to 7.5%.</P>
<H2><A NAME="verp">5.5. VERP</A></H2>
<P>When a message is undeliverable, the MTA responsible is supposed to return a bounce message to the envelope return path (ERP). The bounce message should include the address of the recipient, the reason the message is undeliverable, and whether the problem is temporary or permanent. Some MTA's don't do the right thing, though. They might send the bounce to the address in the From header field, or the bounce might not identify the recipient.</P>
<P>For most user-to-user messages, these problems aren't too bad. One can usually figure things out based on the timing of the bounce or the contents. For mailing lists, the problem of bad bounces is more serious. Subscribers move, forwarding mail to their new address. If the new address starts having delivery problems, it can be impossible to tell which subscriber's mail is bouncing if the bounce message only includes the new address.</P>
<P>Dan Bernstein came up with a solution to this problem called VERP (Variable Envelope Return Path). Using VERPs, each message sent to each subscriber to a list has a unique return path. This allows a bounce handler to identify the problem subscriber.</P>
<P>For example, a typical non-VERP'ed mailing list has a return address of the form <TT><I>listname</I>-owner@<I>domain</I></TT>. For a VERP'ed list, the return address would look like <TT><I>listname</I>-owner-<U><I>subscriber</I>=<I>sdomain</I></U>@<I>ldomain</I></TT>, where the subscriber's address, <TT><I>subscriber</I>@<I>sdomain</I></TT>, is embedded between the &quot;owner&quot; and the &quot;@&quot;. (The &quot;@&quot; in the subscriber's address is replaced with an &quot;=&quot;.)</P>
<P>The <I><A HREF="#ezmlm">ezmlm</A></I> list manager uses VERPs to automatically handle bounces. It even provides subscribers with temporary delivery problems with a list of the messages they missed so they can retrieve them from the archive.</P>
<P>Russell Nelson wrote a bounce manager for <I>Majordomo</I> under <I>qmail</I>, but he no longer maintains it. It's available from <A HREF="http://www.qmail.org/bounceman-0.4.shar">http://www.qmail.org/bounceman-0.4.shar</A>.</P>
<H2><A NAME="troubleshooting">5.6. Troubleshooting</A></H2>
<H3><A NAME="processes">5.6.1. Processes</A></H3>
<P>A properly-running, complete, but minimal <I>qmail</I> installation should always have the following four processes:</P>
<UL>
<LI><TT>qmail-send</TT> running as user <TT>qmails</TT>
<LI><TT>qmail-clean</TT> running as user <TT>qmailq</TT>
<LI><TT>qmail-rspawn</TT> running as user <TT>qmailr</TT>
<LI><TT>qmail-lspawn</TT> running as user <TT>root</TT></UL>
<P>Depending upon your flavor of UNIX, one of the following two commands should list these processes, and possibly a few more:</P>
<PRE>
    ps -ef | grep qmail
    ps waux | grep qmail
</PRE>
<P>For example:</P>
<PRE>
[dave@sparge dave]$ <B>ps waux|grep qmail</B>
dave      2222  0.0  0.8   836   348  p4 S    10:25   0:00 grep qmail
qmaild     351  0.0  1.0   840   400  ?  S N  12:43   0:00 /usr/local/bin/tcpserver -v -x /etc/tcp.smtp.cdb -u 49491 -g 31314 0 smtp /var/qmail/bin/qmail-smtpd-
qmaild    2220  0.0  1.0   844   420  ?  S N  10:25   0:00 /usr/local/bin/tcpserver -v -x /etc/tcp.smtp.cdb -u 49491 -g 31314 0 smtp /var/qmail/bin/qmail-smtpd-
qmaill     365  0.0  0.8   748   344  ?  S N  12:43   0:00 splogger qmail
<B>qmailq     368  0.0  0.7   736   292  ?  S N  12:43   0:00 qmail-clean</B>
<B>qmailr     367  0.0  0.6   732   272  ?  S N  12:43   0:00 qmail-rspawn</B>
<B>qmails     350  0.0  0.8   776   336  ?  S N  12:43   0:00 qmail-send</B>
root       340  0.0  0.6   724   252  ?  S N  12:43   0:00 /usr/local/sbin/supervise /var/supervise/qmail-send /var/qmail/rc
root       341  0.0  0.6   724   252  ?  S N  12:43   0:00 /usr/local/sbin/supervise /var/supervise/tcpserver-qmail /usr/local/bin/tcpserver -v -x /etc/tcp.smtp
<B>root       366  0.0  0.7   736   276  ?  S N  12:43   0:00 qmail-lspawn ./Mailbox</B>
[dave@sparge dave]$
</PRE>
<P>If you run <I>qmail</I> or <TT>qmail-smtpd</TT> under <TT>supervise</TT>, as in the example above, you should see those processes as well. And if run <TT>qmail-smtpd</TT> under <TT>tcpserver</TT>, you should see a parent <TT>tcpserver</TT> process <I>plus</I> an additional <TT>tcpserver</TT> process for each active <I>incoming</I> SMTP connection.</P>
<P>If you use <TT>splogger</TT> (or <TT>multilog</TT> or <TT>cyclog</TT>) to handle logging, you'll have a <TT>splogger</TT> (or <TT>multilog</TT> or <TT>cyclog</TT>) process or two running as user <TT>qmaill</TT>.</P>
<P>Also, if <I>qmail</I> is busy delivering messages locally or remotely, you'll see up to <TT>concurrencylocal</TT> <TT>qmail-local</TT> processes and up to <TT>concurrencyremote</TT> <TT>qmail-remote</TT> processes.</P>
<H3><A NAME="logs">5.6.2. Logs</A></H3>
<H4><A NAME="multilog">5.6.2.1. <TT>multilog</TT></A></H4>
<P><TT>multilog</TT>, which is part of the <I><A HREF="#daemontools">daemontools</A></I> package, logs messages to a series of files in a specified directory.</P>
<P>The log directory is specified on the <TT>multilog</TT> command line, so you can find it by examining your <I>qmail</I> startup scripts.</P>
<P>The number of files in the log directory, and the maximum size of each file, are determined by <TT>multilog</TT> options. The log file names are the TAI (Temps Atomique International) timestamps of the time at which the file was started. The <TT>tai64nlocal</TT> command, also from <I>daemontools</I>, converts TAI timestamps into local, human-readable timestamps.</P>
<P>A typical <TT>multilog</TT> log entry looks like:</P>
<PRE>
@4000000038c3eeb104a6ecf4 delivery 153: success: did_1+0+0/
</PRE>
<P>&quot;@4000000038c3eeb104a6ecf4&quot; is the optional, but recommended, TAI timestamp. &quot;delivery 153: success: did_1+0+0/&quot; is the log message itself.</P>
<H4><A NAME="splogger">5.6.2.2. <TT>splogger</TT></A></H4>
<P><TT>splogger</TT> uses the <I>syslog</I> logging system to timestamp messages and send them to the <I>syslog</I> daemon. <I>Syslog</I> is configured in <TT>/etc/syslog.conf</TT>. Messages sent to <I>syslog</I> have a <I>facility</I> and <I>priority</I>. Entries in <TT>/etc/syslog.conf</TT> filter on the facility and priority to direct the messages to the desired log file, remote log host, or the console. <TT>splogger</TT> logs to the <TT>mail</TT> facility, by default, so <TT>grep</TT>'ing the <TT>syslog.conf</TT> file for &quot;mail&quot; should show the disposition of <I>qmail</I>'s log messages.</P>
<P>Typical locations include:</P>
<UL>
<LI><TT>/var/log/syslog</TT>
<LI><TT>/var/adm/SYSLOG</TT>
<LI><TT>/var/log/maillog</TT></UL>
<P>A typical <I>syslog</I> log entry looks like:</P>
<PRE>
Jun  3 11:35:23 sparge qmail: 928424123.963558 delivery 153: success: did_1+0+0/
</PRE>
<P>&quot;Jun  3 11:35:23&quot; is the <I>syslog</I> timestamp.</P>
<P>&quot;sparge&quot; is the name of the system that sent the message.</P>
<P>&quot;qmail:&quot; is the tag <TT>splogger</TT> places on all <I>qmail</I> log entries.</P>
<P>&quot;928424123.963558&quot; is an optional TAI timestamp (see next section).</P>
<P>&quot;delivery 153: success: did_1+0+0/&quot; is the log message itself.</P>
<H4><A NAME="log-messages">5.6.2.3. Log messages</A></H4>
<P>Here's a typical log sequence for a message sent to a remote system from the local system:</P>
<PRE>
<B>1</B> @4000000038c3eeb027f41c7c new msg 93869
<B>2</B> @4000000038c3eeb027f6b0a4 info msg 93869: bytes 2343 from &lt;dave@sill.org&gt; qp 18695 uid 49491
<B>3</B> @4000000038c3eeb02877ee94 starting delivery 2392: msg 93869 to remote lwq@w3.to
<B>4</B> @4000000038c3eeb0287b55ac status: local 0/10 remote 1/20
<B>5</B> @4000000038c3eeb104a13804 delivery 2392: success: 209.85.127.177_accepted_message.
   /Remote_host_said:_250_CAA01516_Message_accepted_for_delivery/
<B>6</B> @4000000038c3eeb104a4492c status: local 0/10 remote 0/20
<B>7</B> @4000000038c3eeb104a6ecf4 end msg 93869
</PRE>
<P>Line 1 indicates that <I>qmail</I> has received a new message, and its queue ID is 93869. The queue ID is the i-node number of the <TT>/var/qmail/queue/mess/<I>NN</I>/</TT> file--the queue file that contains the message. The queue ID is guaranteed to be unique as long as the message remains in the queue.</P>
<P>Line 2 says that the message is from <TT>dave@sill.org</TT> and is 2343 bytes.</P>
<P>Line 3 says <TT>qmail-remote</TT> is starting to deliver the message to <TT>lwq@w3.to</TT>, and it's assigning the ID 2392 to the delivery.</P>
<P>Line 4 says 0 local deliveries and 1 remote delivery are pending.</P>
<P>Line 5 says delivery 2392 is complete and successful, and it returns the remote server's response, which often contains information the remote mail administrator would find helpful in tracking a delivery. In this case, the &quot;CAA01516&quot; is the remote system's delivery ID.</P>
<P>Line 6 says 0 local deliveries and 0 remote deliveries are pending, i.e., the delivery is complete.</P>
<P>Line 7 says that the message has been delivered completely and removed from the queue. At this point, the queue ID, 93869, is reusable for another delivery.</P>
<H2><A NAME="big-servers">5.7. Big Servers</A></H2>
<P>See also <I><A HREF="#qmail-ldap">qmail-ldap</A></I>.</P>
<H3><A NAME="scalable-parallelism">5.7.1. Scalable parallelism</A></H3>
<P>Use a fast NFS network file server to store user directories. Set up multiple equal-preference SMTP servers delivering to maildir mailboxes on the file server.</P>
<H2><A NAME="migrating-to-qmail">5.8. Migrating from <I>Sendmail</I> to <I>qmail</I></A></H2>
<P>Check Dan Bernstein's <I>Sendmail</I>-&gt;<I>qmail</I> page at <A HREF="http://cr.yp.to/qmail/sendmail.html">http://cr.yp.to/qmail/sendmail.html</A>.</P>
<H2><A NAME="mailing-list-managers">5.9. Mailing List Managers</A></H2>
<P>Mailing list managers (MLM's) are systems that help list owners run mailing lists. Their duties fall into two main divisions: managing the lists of subscribers, and controlling the resending of messages to the subscribers.</P>
<P>Most (all?) UNIX mailing list managers can be made to work with <I>qmail</I>.</P>
<H3><A NAME="mlm-ezmlm">5.9.1. <I>ezmlm</I></A></H3>
<P><I>ezmlm</I> was written by Dan Bernstein, the author of <I>qmail</I>. It was written for use with <I>qmail</I>, and relies on several features of <I>qmail</I>. Most notably, it uses <A HREF="#verp">VERPs</A> to reliably process bounce messages. <I>ezmlm</I> is somewhat unique among MLM's in that it doesn't process commands sent to a central MLM address: it appends the command to the name of the list. E.g., to subscribe to the &quot;foo@list.example.net&quot; list, one sends a message to &quot;foo-subscribe@list.example.net&quot;.</P>
<P>For more information about <I>ezmlm</I>, see <A HREF="http://www.ezmlm.org/">http://www.ezmlm.org/</A>, the unofficial <I>ezmlm</I> web site, and the official home of <I>ezmlm-idx</I>, a very nice add-on that includes many useful features.</P>
<H3><A NAME="mlm-majordomo">5.9.2. <I>Majordomo</I></A></H3>
<P><I>Majordomo</I> is one of the most popular UNIX MLMs. It works fine with <I>qmail</I> provided a few simple changes are made. Russ Allbery has written a FAQ about <I>qmail</I>/<I>Majordomo</I> available from <A HREF="http://web.archive.org/web/20050308091420/http://www.eyrie.org/~eagle/faqs/mjqmail.html">http://web.archive.org/web/20050308091420/http://www.eyrie.org/~eagle/faqs/mjqmail.html</A>.</P>
<H2><A NAME="patches">5.10. Patches</A></H2>
<P>Various source code patches are available for <I>qmail</I>. To install a patch, download it, cd to the <I>qmail</I> source tree, and apply it using the <TT>patch</TT> command.</P>
<PRE>
    cd /usr/local/src/qmail/qmail-1.03
    patch -p0 &lt;/tmp/patchfile
</PRE>
<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG>See the <TT>patch</TT> <TT>man</TT> page for more information. This is just an example. Also, you might need to use a current version of GNU patch to successfully apply some patches. See <A HREF="http://www.gnu.org/software/patch/patch.html">http://www.gnu.org/software/patch/patch.html</A>.</P>
<P><HR WIDTH="80%" ALIGN="Left"></P>
<P>Stop <I>qmail</I> by killing <TT>qmail-send</TT> or, if you installed the <TT>qmailctl</TT> script in the Installation section, do:</P>
<PRE>
    qmailctl stop
</PRE>
<P>Then rebuild and install the new binaries:</P>
<PRE>
    make setup check
</PRE>
<P>And restart <I>qmail</I>:</P>
<PRE>
    qmailctl start
</PRE>
<P>Finally, test <I>qmail</I>--especially the part you patched.</P>
<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG>Although <A HREF="http://www.qmail.org/">http://www.qmail.org/</A> lists many patches for <I>qmail</I>, <B>none</B> of the them have been approved by the author of qmail. They may introduce security, reliability, efficiency, or functionality problems not present in <I>qmail</I>. Most <I>qmail</I> installations only require the some of the Recommended patches. <B>You</B> <B>should not install any patches that you don't clearly require.</B></P>
<P><HR WIDTH="80%" ALIGN="Left"></P>
<H3><A NAME="recommended-patches">5.10.1. Recommended Patches</A></H3>
<P>qmail.org has a &quot;Recommended Patches&quot; section: <A HREF="http://qmail.org/top.html#patches">http://qmail.org/top.html#patches</A>. These patches address the few known bugs in qmail.</P>
<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG>all of the Recommended Patches have been included in the <I>netqmail</I> distribution. See <A HREF="http://www.qmail.org/netqmail/">http://www.qmail.org/netqmail/</A>.
<HR WIDTH="80%" ALIGN="Left"></P>
<H4><A NAME="errno-patch">5.10.1.1. <TT>errno.h</TT> patches</A></H4>
<P>This patch fixes a problem with missing <TT>errno.h</TT> inclusions. See <A HREF="http://article.gmane.org/gmane.mail.qmail.general/13960">http://article.gmane.org/gmane.mail.qmail.general/13960</A> for a detailed explanation and the patch itself.</P>
<P>Mate Wierdl has <TT>errno.h</TT> patches for all of Dan Bernstein's software including <I>qmail</I>, <I>daemontools</I>, and <I>ucspi-tcp</I>. These patches are available from <A HREF="http://www.thedjbway.org/patches/djb_errno_patches.tgz">http://www.thedjbway.org/patches/djb_errno_patches.tgz</A>.</P>
<H4><A NAME="qmail-local-tab-patch">5.10.1.2. qmail-local TAB patch</A></H4>
<P>This patch fixes a minor bug in the parsing of <TT>.qmail</TT> files that start with TAB characters. <A HREF="http://www.ornl.gov/lists/mailing-lists/qmail/2000/10/msg00696.html">http://www.ornl.gov/lists/mailing-lists/qmail/2000/10/msg00696.html</A></P>
<H4><A NAME="0.0.0.0-patch">5.10.1.3. IP 0.0.0.0 patch</A></H4>
<P>This patch causes the IP address 0.0.0.0 to be recognized as local. <A HREF="http://www.suspectclass.com/~sgifford/qmail/qmail-0.0.0.0.patch">http://www.suspectclass.com/~sgifford/qmail/qmail-0.0.0.0.patch</A></P>
<H3><A NAME="dns-patches">5.10.2. DNS</A></H3>
<P>Historically, DNS responses have been limited to 512 bytes. Some large sites have started returning MX responses longer than that. <I>qmail</I> and many other programs have a problem with Domain Name Server (DNS) queries that return very large results. There are two ways to fix this in <I>qmail</I> and one workaround that might be sufficient for some applications.</P>
<H4><A NAME="dns-davis"> </A>5.10.2.1. Christopher K. Davis' patch, <A HREF="http://www.ckdhr.com/ckd/qmail-103.patch">http://www.ckdhr.com/ckd/qmail-103.patch</A></H4>
<P>This is an adaptation of a patch by Chuck Foster that should work with any resolver library, no matter how old, and uses a guard byte to avoid the &quot;number of bytes placed in the buffer&quot; library bug. It reallocates only once, to 65536, rather than just to the size needed, so it can be less memory-efficient than Chuck's patch (though, like his patch, it only reallocates if the response is larger than PACKETSZ, which defaults to 512 bytes). After reallocating, it forces a TCP query, rather than requiring the resolver library to do so (avoiding an extra round-trip between qmail and the name server, though if they're on the same machine or local network this is not a big worry).</P>
<H4><A NAME="dns-bump">5.10.2.2. Bump the packet buffer size up to 65536</A></H4>
<P>Works with recent BIND resolver libraries, which will automatically do a TCP query within the library code if the reply comes back with the truncation bit set. This is the simplest fix, though it's also <I>potentially</I> the most wasteful of memory, depending on how your system handles paging. To do this, just replace <TT>PACKETSZ</TT> with <TT>65536</TT> in <TT>dns.c</TT> and rebuild <I>qmail</I>.</P>
<H4><A NAME="dnscache">5.10.2.3. Run <TT>dnscache</TT> from <I>djbdns</I></A></H4>
<P><TT>dnscache</TT> is, as the name implies, a caching DNS server. It knows how to handle large DNS responses and removes unnecessary information from them, so the response it returns is usually much smaller than the direct response. It also generally improves DNS lookup performance for all services that use DNS. Because it doesn't require patching <I>qmail</I>, this might be an acceptable workaround. Unfortunately, it's not a complete fix because responses can still be too large for <I>qmail</I>. See the <A HREF="#djbdns">djbdns</A> section under <A HREF="#related-packages">Related Packages</A> for more information.</P>
<H3><A NAME="qmail-ldap">5.10.3. <I>qmail-ldap</I></A></H3>
<P>This patch, by Andre Oppermann, et al, implements Lightweight Directory Access Protocol (LDAP) support in qmail. LDAP is like a network phone book. Using <I>qmail-ldap</I>, it should be possible for a POP server to serve many thousands of users. See <A HREF="http://www.nrg4u.com/">http://www.nrg4u.com/</A>.</P>
<H2><A NAME="qmtp">5.11. QMTP</A></H2>
<P>QMTP is the Quick Mail Transfer Protocol, an SMTP replacement protocol designed by Dan Bernstein. The protocol is defined at <A HREF="http://cr.yp.to/proto/qmtp.txt">http://cr.yp.to/proto/qmtp.txt</A>. QMTP is similar to SMTP, but is simpler, faster, and incompatible with SMTP. <I>qmail</I> includes a QMTP server, <TT>qmail-qmtpd</TT>, which is run very much like <TT>qmail-smtpd</TT>. QMTP usually uses port 209.</P>
<P><I>qmail</I> doesn't include a QMTP <I>client</I>, but the <I>serialmail</I> package does. <TT>maildirqmtp</TT> takes a maildir mailbox and delivers the messages it contains to designated QMTP server via QMTP.</P>
<P>QMTP is not a drop-in replacement for SMTP, and is not yet in widespread use across the Internet.</P>
<P>Russ Nelson has a patch for <TT>qmail-remote</TT> that supports QMTP. It's available from <A HREF="http://www.qmail.org/qmail-1.03-qmtpc.patch">http://www.qmail.org/qmail-1.03-qmtpc.patch</A>. He also has a tarball that can be extracted in <TT>/service</TT> to enable a QMTP service. It's available from <A HREF="http://www.qmail.org/qmtpd-service.tar.gz">http://www.qmail.org/qmtpd-service.tar.gz</A>.</P>
<H2><A NAME="smtp-reject">5.12. Rejecting Invalid Recipients During SMTP Dialogue</A></H2>
<P>When a remote server connects to <TT>qmail-smtpd</TT> and offers it a message, <TT>qmail-smtpd</TT> checks the recipient addresses against the contents of <TT>control/rcpthosts</TT>. If the host or domain after the <TT>@</TT> symbol is listed in <TT>control/rcpthosts</TT>, <TT>qmail-smtpd</TT> accepts the message, it's placed in the queue, and <TT>qmail-send</TT> attempts delivery. If the local recipient is invalid--there's no user or alias by that name--<TT>qmail-send</TT> generates a bounce message and sends it to the return address specified during the SMTP dialogue.</P>
<P>In a well-behaved world, either strategy would be fine. Unfortunately, there are a lot of poorly-behaved spammers out there. Some will attempt to deliver messages to recipients that &quot;might&quot; exist on your server--using a database of common names, a dictionary, or even a generated list of all possible alphanumeric strings.</P>
<P>On a qmail system, such spam attacks can inflict a substantial load on the system, fill the queue with junk, and delay the delivery of valid messages.</P>
<P>Some MTAs validate the local recipient during the SMTP dialogue and refuse to accept the message if the recipient is invalid. This saves the server from a lot of unnecessary work, but has a negative side effect, too. Using this validation, spammers can quickly determine which addresses are valid.</P>
<P>There are several ways to implement recipient validation during the SMTP dialogue with <I>qmail</I>. Eben Pratt has assembled a list of them at <A HREF="http://netdevice.com/qmail/rcptck/">http://netdevice.com/qmail/rcptck/</A>. Most of these solutions require maintaining a database of valid or invalid recipients or patterns. One that doesn't is Paul Jarc's qmail-realrcptto, available from <A HREF="http://code.dogmap.org./qmail/">http://code.dogmap.org./qmail/</A>.</P>
<H2><A NAME="TLS">5.13. TLS and STARTTLS</A></H2>
<P>Scott Gifford has written a very thorough and detailed step-by-step guide to using transport layer security (TLS) with <I>qmail</I>. The guide covers STARTTLS for SMTP and STLS for POP3D specifically for <I>netqmail</I>. It's available at <A HREF="http://www.suspectclass.com/~sgifford/ucspi-tls/ucspi-tls-qmail-howto.html">http://www.suspectclass.com/~sgifford/ucspi-tls/ucspi-tls-qmail-howto.html</A>.</P>
<HR>
<H1><A NAME="acknowledgments">A. Acknowledgments</A></H1>
<P>First, thanks to Dan Bernstein for designing and writing such a powerful and elegant system. After nearly ten years of use, <I>qmail</I> still impresses me.</P>
<P>I'd also like to thank the members of the <I>qmail</I> mailing list. Two members deserve special mention. The first is Russ Nelson, one of the most helpful, patient, knowledgeable, and <I>funny</I> contributors. His contributions to the <I>qmail</I> community are second only to DJB's. The second is Charles Cazabon, who's close on Russ' heels. Charles is currently the major contributor to the mailing list, answering more questions correctly than anyone else. Charles has also written a couple of very useful utilities, getmail and pymsgauth, and was technical editor for <U>The qmail Handbook</U> where his contributions were <I>critical</I> to the success of the book, and for which he has received too little reward and recognition.</P>
<P>Thanks also to everyone who reviewed or contributed to this document, including:</P>
<UL>
<LI>Vince Vielhaber
<LI>Chris Green
<LI>Christopher K. Davis
<LI>Scott Schwartz
<LI>Fred Lindberg
<LI>Russell P. Sutherland
<LI>Alex Miller
<LI>Tim Hunter
<LI>Frank D. Cringle
<LI>Mahlon Smith
<LI>Rogerio Brito
<LI>Tony Hansmann
<LI>Matthias Andree
<LI>Tillman Hodgson
<LI>Stefan Witzel
<LI>Scott Gifford
<LI>too many others to mention...</UL>
<P>Special thanks to Henning Brauer for donating the lifewithqmail.org domain <I>and</I> hosting it!</P>
<P>Special thanks also to Michael M. Kadrie of ATLAS Design Group, <A HREF="http://www.atlasdesigngroup.com">http://www.atlasdesigngroup.com</A>, for the nifty new <I>qmail</I> logo!</P>
<P><U>Life with qmail</U> was written using Simple Document Format (SDF), a very cool Perl-based markup language that generates HTML, plain text, PostScript, POD, and other formats. It made the job <I>much</I> easier. See <A HREF="http://search.cpan.org/author/IANC/sdf-2.001/">http://search.cpan.org/author/IANC/sdf-2.001/</A> for more information.</P>
<HR>
<H1><A NAME="related-packages">B. Related Packages</A></H1>
<H2><A NAME="dot-forward">B.1. <I>dot-forward</I></A></H2>
<P><I>Sendmail</I> uses <TT>.forward</TT> files, pronounced <I>dot forward</I>, to allow users to control the delivery of messages they receive. <I>qmail</I> uses a similar mechanism: <TT>.qmail</TT> files. The <I>dot-forward</I> package gives <I>qmail</I> the ability to use <TT>.forward</TT> files. Systems running <I>Sendmail</I> or any other MTA that uses <TT>.forward</TT> files might want to consider using <I>dot-forward</I> to avoid having to convert existing <TT>.forward</TT> files to their <TT>.qmail</TT> equivalents--or simply to make the transition to <I>qmail</I> less visible to their users.</P>
<P><I>dot-forward</I> is a small package: easy to install and configure. The source is available from <A HREF="http://cr.yp.to/software/dot-forward-0.71.tar.gz">http://cr.yp.to/software/dot-forward-0.71.tar.gz</A>.</P>
<P><I>dot-forward</I> was written by Dan Bernstein, who maintains a web page for it at <A HREF="http://cr.yp.to/dot-forward.html">http://cr.yp.to/dot-forward.html</A>.</P>
<H2><A NAME="fastforward">B.2. <I>fastforward</I></A></H2>
<P><I>fastforward</I> is another <I>Sendmail</I> compatibility add-on. <I>Sendmail</I> uses a central alias database kept in a single file, usually <TT>/etc/aliases</TT>. <I>qmail</I> uses a series of <TT>dot-qmail</TT> files in <TT>/var/qmail/alias</TT>, one file per alias. If you're migrating to <I>qmail</I>, and you've got a <I>Sendmail</I>-format aliases file you don't want to convert, <I>fastforward</I> gives <I>qmail</I> the ability to use the aliases file as-is.</P>
<P>The source is available from <A HREF="http://cr.yp.to/software/fastforward-0.51.tar.gz">http://cr.yp.to/software/fastforward-0.51.tar.gz</A>.</P>
<P><I>fastforward</I> was written by Dan Bernstein, who maintains a web page for it at <A HREF="http://cr.yp.to/fastforward.html">http://cr.yp.to/fastforward.html</A>.</P>
<H2><A NAME="ucspi-tcp">B.3. <I>ucspi-tcp</I></A></H2>
<P><I>qmail</I>'s SMTP server doesn't run as a stand alone daemon. A helper program such as <I>inetd</I>, <I>xinetd</I>, or <TT>tcpserver</TT> runs as a daemon. When it receives a TCP connection to port 25, the SMTP port, it executes a copy of <TT>qmail-smtpd</TT>.</P>
<P><I>Inetd</I> is the standard network server &quot;super-server&quot;. It can be configured through <TT>/etc/inetd.conf</TT> to run <TT>qmail-smtpd</TT>, but the recommended tool is <TT>tcpserver</TT>, which is part of the <I>ucspi-tcp</I> package. <I>ucspi-tcp</I> is an acronym for UNIX Client-Server Program Interface for TCP, and it's pronounced <I>ooks-pie tee see pee</I>.</P>
<P><TT>tcpserver</TT> is preferred over <I>inetd</I> because:</P>
<UL>
<LI><TT>tcpserver</TT> allows one to limit the number of simultaneous connections to a service. <I>Inetd</I> has a connection-rate limiting mechanism that temporarily disables services that are &quot;too&quot; busy.
<LI><TT>tcpserver</TT> can be configured to deny access to certain hosts or to recognize local hosts and flag them so <TT>qmail-smtpd</TT> can treat them differently.
<LI><TT>tcpserver</TT> is the only server supported by the author of <I>qmail</I>.</UL>
<P>The source is available from <A HREF="http://cr.yp.to/ucspi-tcp/ucspi-tcp-0.88.tar.gz">http://cr.yp.to/ucspi-tcp/ucspi-tcp-0.88.tar.gz</A>.</P>
<P>Gerrit Pape distributes the documentation for <I>ucspi-tcp</I> as <TT>man</TT> pages from <A HREF="http://smarden.org/pape/djb/">http://smarden.org/pape/djb/</A>.</P>
<P><I>ucspi-tcp</I> was written by Dan Bernstein, who maintains a web page for it at <A HREF="http://cr.yp.to/ucspi-tcp.html">http://cr.yp.to/ucspi-tcp.html</A>.</P>
<H2><A NAME="daemontools">B.4. <I>daemontools</I></A></H2>
<P>The <I>daemontools</I> package contains a set of utilities for controlling and monitoring services. It's not mandatory, but it's highly recommended, especially for busy systems. It includes:</P>
<UL>
<LI><TT>supervise</TT>, which monitors a service and restarts it if it dies.
<LI><TT>svc</TT>, which talks to <TT>supervise</TT> and allows one to stop, pause, or restart the service.
<LI><TT>multilog</TT>, which maintains a log for a service, automatically rotating it to keep it under the configured size.
<LI><TT>setuidgid</TT>, which runs programs for the superuser with a normal user's UID and GID.</UL>
<P>The source for <I>daemontools</I> is available from: <A HREF="http://cr.yp.to/daemontools/daemontools-0.76.tar.gz">http://cr.yp.to/daemontools/daemontools-0.76.tar.gz</A>.</P>
<P>Gerrit Pape distributes the documentation for <I>daemontools</I> as <TT>man</TT> pages from <A HREF="http://smarden.org/pape/djb/">http://smarden.org/pape/djb/</A>.</P>
<P><I>daemontools</I> was written by Dan Bernstein, who maintains a web page for it at <A HREF="http://cr.yp.to/daemontools.html">http://cr.yp.to/daemontools.html</A>.</P>
<H2><A NAME="qmailanalog">B.5. <I>qmailanalog</I></A></H2>
<P><I>qmailanalog</I> processes <I>qmail</I>'s log file and produces a series of reports that tell one how much and what kind of work the system is doing. If you need statistics about how many messages are being sent or received, how big they are, and how quickly they're being processed, <I>qmailanalog</I> is what you need.</P>
<P>As a bonus, the <TT>matchup</TT> program combines <I>qmail</I>'s multiple log lines per delivery into one--not unlike the familiar <I>Sendmail</I> logs.</P>
<P>The source for <I>qmailanalog</I> is available from <A HREF="http://cr.yp.to/software/qmailanalog-0.70.tar.gz">http://cr.yp.to/software/qmailanalog-0.70.tar.gz</A>.</P>
<P><I>qmailanalog</I> was written by Dan Bernstein, who maintains a web page for it at <A HREF="http://cr.yp.to/qmailanalog.html">http://cr.yp.to/qmailanalog.html</A>.</P>
<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG><I>qmailanalog</I> relies on log entry timestamps in the fractional second format used by <TT>accustamp</TT>. In order to use it with logs generated by <TT>multilog</TT>, which are in TAI64N format, you'll need to translate them into the old format. One program to do that is available from <A HREF="http://www.qmail.org/tai64nfrac">http://www.qmail.org/tai64nfrac</A>.
<HR WIDTH="80%" ALIGN="Left"></P>
<H2><A NAME="rblsmtpd">B.6. <I>rblsmtpd</I></A></H2>
<P>If you've never been spammed, consider yourself <I>very</I> lucky. Most e-mail users are all too familiar with Unsolicited Bulk E-mail (UBE), aka &quot;spam&quot;. Most of it is advertisements for sex sites, chain letters, and other scams. Back in the days of old, up until around 1998 or so, most MTA's on the Internet were <I>open relays</I>, i.e., they would accept mail from anyone <I>for</I> anyone, even if neither sender nor recipient was local. Spammers use open relays, if they can find any, to deliver their spam. It covers their tracks, redirects the backlash toward the &quot;innocent&quot; relay site, and saves them lots of CPU time and network bandwidth.</P>
<P>Such open relays are considered <B>very</B> bad form these days, and several anti-spam vigilante groups have created a mechanism for identifying open relays and other common sources of spam so they can avoid accepting SMTP connections from them.</P>
<P><I>rblsmtpd</I> is an RBL SMTP Daemon. It sits between <TT>tcpserver</TT> and <TT>qmail-smtpd</TT> and rejects connections from systems identified on one of these lists.</P>
<P>For example, to run <TT>rblsmtpd</TT> under <TT>tcpserver</TT>, try something like:</P>
<PRE>
#!/bin/sh
QMAILDUID=`id -u qmaild`
NOFILESGID=`id -g qmaild`
MAXSMTPD=`cat /var/qmail/control/concurrencyincoming`
exec /usr/local/bin/softlimit -m 2000000 \
  /usr/local/bin/tcpserver -v -R -H -l 0 -x /etc/tcp.smtp.cdb -c &quot;$MAXSMTPD&quot; \
    -u &quot;$QMAILDUID&quot; -g &quot;$NOFILESGID&quot; 0 smtp /usr/local/bin/rblsmtpd\
    -r relays.ordb.org /var/qmail/bin/qmail-smtpd 2&gt;&amp;1
</PRE>
<P><I>rblsmtpd</I> was previously available as a separate utility, but is now bundled with <A HREF="#ucspi-tcp">ucspi-tcp</A>.</P>
<P><I>rblsmtpd</I> was written by Dan Bernstein, who maintains a web page for it at <A HREF="http://cr.yp.to/ucspi-tcp/rblsmtpd.html">http://cr.yp.to/ucspi-tcp/rblsmtpd.html</A>.</P>
<P>Charles Cazabon has a patch that removes the default RBL hardcoded into <TT>rblsmtpd</TT> since it's no longer free. The patch is available from <A HREF="http://pyropus.ca/software/misc/rblsmtpd-nodefaultrbl.patch">http://pyropus.ca/software/misc/rblsmtpd-nodefaultrbl.patch</A>.</P>
<H2><A NAME="serialmail">B.7. <I>serialmail</I></A></H2>
<P><I>qmail</I> was designed for systems with full time, high speed connectivity. <I>serialmail</I> is a set of tools that make <I>qmail</I> better suited to intermittent, low speed connectivity. With <I>serialmail</I> on such a system, <I>qmail</I> is configured to deliver all remote mail to a single maildir. The <I>serialmail</I> <TT>maildirsmtp</TT> command is used to upload the maildir to the ISP's mail hub when the connection is brought up. If the ISP supports QMTP (see <A HREF="#qmtp">QMTP</A> under <A HREF="#advanced-topics">Advanced Topics</A>), <TT>maildirqmtp</TT> can also be used.</P>
<P><I>serialmail</I> can be used on the ISP side of the connection to implement <I>AutoTURN</I>: an SMTP connection by a client causes the server to initiate a connection back to the client for sending messages queued on the server for the client. This is similar to the ETRN SMTP function.</P>
<P>The source for <I>serialmail</I> is available from <A HREF="http://cr.yp.to/software/serialmail-0.75.tar.gz">http://cr.yp.to/software/serialmail-0.75.tar.gz</A>.</P>
<P><I>serialmail</I> was written by Dan Bernstein, who maintains a web page for it at <A HREF="http://cr.yp.to/serialmail.html">http://cr.yp.to/serialmail.html</A>.</P>
<H2><A NAME="mess822">B.8. <I>mess822</I></A></H2>
<P><I>mess822</I> is a library and set of applications for parsing RFC 822 compliant mail messages. The applications include:</P>
<UL>
<LI><TT>ofmipd</TT>: a daemon that accepts messages from clients and rewrites From fields based on a database.
<LI><TT>new-inject</TT>: a <TT>qmail-inject</TT> replacement that supports user-controlled hostname rewriting.
<LI><TT>iftocc</TT>: a <TT>.qmail</TT> utility for checking whether a message was sent to a specific address.
<LI><TT>822header</TT>, <TT>822field</TT>, <TT>822date</TT>, and <TT>822received</TT>: extract information from a message.
<LI><TT>822print</TT>: pretty-prints a message.</UL>
<P>The source for <I>mess822</I> is available from <A HREF="http://cr.yp.to/software/mess822-0.58.tar.gz">http://cr.yp.to/software/mess822-0.58.tar.gz</A>.</P>
<P><I>mess822</I> was written by Dan Bernstein, who maintains a web page for it at <A HREF="http://cr.yp.to/mess822.html">http://cr.yp.to/mess822.html</A>.</P>
<H2><A NAME="ezmlm">B.9. <I>ezmlm</I></A></H2>
<P><I>ezmlm</I> is a high performance, easy-to-use mailing list manager (MLM) for qmail. If you're familiar with <I>LISTSERV</I> or <I>Majordomo</I>, you know what a mailing list manager does. For more information about mailing lists under <I>qmail</I> see <A HREF="#mailing-list-managers">Mailing List Managers</A> under <A HREF="#advanced-topics">Advanced Topics</A>.</P>
<P>The source for <I>ezmlm</I> is available from <A HREF="http://cr.yp.to/software/ezmlm-0.53.tar.gz">http://cr.yp.to/software/ezmlm-0.53.tar.gz</A>.</P>
<P><I>ezmlm</I> was written by Dan Bernstein, who maintains a web page for it at <A HREF="http://cr.yp.to/ezmlm.html">http://cr.yp.to/ezmlm.html</A>.</P>
<P>Fred Lindberg and Fred B. Ringel have developed an extension to <I>ezmlm</I> called <I>ezmlm-idx</I>. It adds lots of useful features and is highly recommended. It's now being maintained by Bruce Guenter available from <A HREF="http://www.ezmlm.org/">http://www.ezmlm.org/</A>.</P>
<H2><A NAME="safecat">B.10. <I>safecat</I></A></H2>
<P><I>safecat</I> reliably writes a file into a maildir mailbox. It is particularly useful for filing messages in <I>procmail</I> recipes. For example, the following recipe files all messages in <TT>Maildir</TT>:</P>
<PRE>
:0w
|safecat Maildir/tmp Maildir/new
</PRE>
<P><I>safecat</I> was written by Len Budney, who maintains a web page for it at <A HREF="http://jeenyus.net/~budney/linux/software/safecat.html">http://jeenyus.net/~budney/linux/software/safecat.html</A>.</P>
<H2><A NAME="djbdns">B.11. <I>djbdns</I></A></H2>
<P><I>djbdns</I> is a DNS server written by the author of <I>qmail</I>. It includes <TT>tinydns</TT>, a DNS content server, and <TT>dnscache</TT>, a caching DNS server.</P>
<P>The official web page for <I>djbdns</I> is <A HREF="http://cr.yp.to/djbdns.html">http://cr.yp.to/djbdns.html</A>.</P>
<H2><A NAME="maildrop">B.12. <I>maildrop</I></A></H2>
<P><I>maildrop</I> is a mail filter similar to <I>procmail</I>.</P>
<P><I>maildrop</I> was written by Sam Varshavchik, who maintains a web page for it at <A HREF="http://www.courier-mta.org/maildrop/">http://www.courier-mta.org/maildrop/</A>.</P>
<H2><A NAME="syncdir">B.13. <I>syncdir</I></A></H2>
<P><I>syncdir</I> is small library that makes the <TT>link()</TT> system call synchronous. This is necessary when using <I>qmail</I> with the queue on a filesystem that doesn't perform <TT>link()</TT> synchronously, such as Linux's ext2fs, Reiserfs, SGI's XFS, and BSD FFS with softupdates.</P>
<P><I>syncdir</I> was written br Bruce Guenter and is available from <A HREF="http://untroubled.org/syncdir/">http://untroubled.org/syncdir/</A>. Installation instructions are available from <A HREF="http://www.ornl.gov/lists/mailing-lists/qmail/2001/12/msg00949.html">http://www.ornl.gov/lists/mailing-lists/qmail/2001/12/msg00949.html</A>.</P>
<HR>
<H1><A NAME="how-mail-works">C. How Internet Mail Works</A></H1>
<H2><A NAME="from-a-to-b">C.1. How a message gets from point A to point B</A></H2>
<P>When a user on one host sends a message to a user on a another host, many things happen behind the scenes that you may not be aware of.</P>
<P>Let's say Alice, <TT>alice@alpha.example.com</TT>, wants to send a message to Bob, <TT>bob@beta.example.com</TT>. Here's what happens:</P>
<P>1. Alice composes the message with her mail user agent (MUA), something like <I>mutt</I> or <I>pine</I>. She specifies the recipient in a <I>To</I> field, the subject of the message in a <I>Subject</I> field, and the text of the message itself. It looks something like:</P>
<PRE>
    To: bob@beta
    Subject: lunch

    How about pizza?
</PRE>
<P>2. When she's satisfied with the message, she tells the MUA to send it.</P>
<P>3. At this point, the MUA can add additional header fields like <I>Date</I> and <I>Message-Id</I> and modify the values Alice entered (e.g., replace <TT>bob@beta</TT> with &quot;<TT>Bob &lt;bob@beta.example.com</TT>&gt;&quot;. Next, the MUA <I>injects</I> the message into the mail system. There are two ways to this: it can run a program provided by the mail system for the purpose of injecting messages, or it can open a connection to the Simple Mail Transfer Protocol (SMTP) port on either the local system or a remote mail server. For this example, we'll assume the MUA uses a local injection program to pass messages to the MTA. The details of the injection process vary by MTA, but on UNIX systems the <I>sendmail</I> method is a de facto standard. With this method, the MUA can put the header and body in a file, separated by a blank line, and pass the file to the <TT>sendmail</TT> program.</P>
<P>4. If the injection succeeds--the message was syntactically correct and <TT>sendmail</TT> was invoked properly--the message is now the MTA's responsibility. Details vary greatly by MTA, but generally the MTA on alpha examines the header to determine where to send the message, opens an SMTP connection to beta, and forwards the message to the MTA on the beta system. The SMTP dialogue requires messages to be sent in two parts: the <I>envelope</I>, which specifies the recipient's address (<TT>bob@beta.example.com</TT>) and the return address (<TT>alice@alpha.example.com</TT>), and the message itself, which consists of the header and body.</P>
<P>5. If the beta MTA rejects the message, perhaps because there's no user <I>bob</I> on the system, the MTA on alpha sends a <I>bounce</I> message to the return address, <TT>alice@alpha</TT>, to notify her of the problem.</P>
<P>6. If the beta MTA accepts the message, it looks at the recipient's address, determines whether it's local to beta or on a remote system. In this case, it's local, so the MTA either delivers the message itself or passes it to a <I>mail delivery agent</I> (MDA) like <TT>/bin/mail</TT> or <TT>procmail</TT>.</P>
<P>7. If the delivery fails, perhaps because Bob has exceeded his mail quota, the beta MTA sends a bounce message to the envelope return address, <TT>alice@alpha</TT>.</P>
<P>8. If the delivery succeeds, the message waits in Bob's mailbox until his MUA reads it and displays it.</P>
<H2><A NAME="more-information">C.2. More information</A></H2>
<P>For information about how Internet mail works, see one or more of the following:</P>
<UL>
<LI>Internet mail, by the author of <I>qmail</I>. <A HREF="http://cr.yp.to/im.html">http://cr.yp.to/im.html</A>
<LI>SMTP, by the author of <I>qmail</I>. <A HREF="http://cr.yp.to/smtp.html">http://cr.yp.to/smtp.html</A>
<LI>Internet mail message header format, by the author of <I>qmail</I>. <A HREF="http://cr.yp.to/immhf.html">http://cr.yp.to/immhf.html</A></UL>
<H3><A NAME="rfcs">C.2.1. Internet RFC's</A></H3>
<P>Internet Requests for Comment (RFC's) are the official documentation of the Internet. Most of these are well beyond the commentary stage, and define Internet protocols such as TCP, FTP, Telnet, and the various mail standards and protocols.</P>
<UL>
<LI>RFC 821, Simple Mail Transfer Protocol (obsoleted by  RFC 2821) <A HREF="http://www.ietf.org/rfc/rfc0821.txt">http://www.ietf.org/rfc/rfc0821.txt</A>
<LI>RFC 822, Standard for the Format of ARPA Internet Text Messages (obsoleted by RFC 2822) <A HREF="http://www.ietf.org/rfc/rfc0822.txt">http://www.ietf.org/rfc/rfc0822.txt</A>
<LI>RFC 931, Authentication Server. <A HREF="http://www.ietf.org/rfc/rfc0931.txt">http://www.ietf.org/rfc/rfc0931.txt</A>
<LI>RFC 974, Mail Routing and the Domain System. <A HREF="http://www.ietf.org/rfc/rfc0974.txt">http://www.ietf.org/rfc/rfc0974.txt</A>
<LI>RFC 1123, Requirements for Internet Hosts -- Application and Support. <A HREF="http://www.ietf.org/rfc/rfc1123.txt">http://www.ietf.org/rfc/rfc1123.txt</A>
<LI>RFC 1413, Identification Protocol. <A HREF="http://www.ietf.org/rfc/rfc1413.txt">http://www.ietf.org/rfc/rfc1413.txt</A>
<LI>RFC 1423, Privacy Enhancement for Internet Electronic Mail: Part III: Algorithms, Modes, and Identifiers. <A HREF="http://www.ietf.org/rfc/rfc1423.txt">http://www.ietf.org/rfc/rfc1423.txt</A>
<LI>RFC 1651, SMTP Service Extensions. <A HREF="http://www.ietf.org/rfc/rfc1651.txt">http://www.ietf.org/rfc/rfc1651.txt</A>
<LI>RFC 1652, SMTP Service Extension for 8bit-MIMEtransport. <A HREF="http://www.ietf.org/rfc/rfc1652.txt">http://www.ietf.org/rfc/rfc1652.txt</A>
<LI>RFC 1806, Content disposition.  header. <A HREF="http://www.ietf.org/rfc/rfc1806.txt">http://www.ietf.org/rfc/rfc1806.txt</A>
<LI>RFC 1854, SMTP Service Extension for Command Pipelining. <A HREF="http://www.ietf.org/rfc/rfc1854.txt">http://www.ietf.org/rfc/rfc1854.txt</A>
<LI>RFC 1891, SMTP Service Extension for Delivery Status Notifications. <A HREF="http://www.ietf.org/rfc/rfc1891.txt">http://www.ietf.org/rfc/rfc1891.txt</A>
<LI>RFC 1892, The Multipart/Report Content Type for the Reporting of Mail System Administrative Messages. <A HREF="http://www.ietf.org/rfc/rfc1892.txt">http://www.ietf.org/rfc/rfc1892.txt</A>
<LI>RFC 1893, Enhanced mail system status codes. <A HREF="http://www.ietf.org/rfc/rfc1893.txt">http://www.ietf.org/rfc/rfc1893.txt</A>
<LI>RFC 1894, An Extensible Message Format for Delivery Status Notifications. <A HREF="http://www.ietf.org/rfc/rfc1894.txt">http://www.ietf.org/rfc/rfc1894.txt</A>
<LI>RFC 1939, Post Office Protocol - Version 3. <A HREF="http://www.ietf.org/rfc/rfc1939.txt">http://www.ietf.org/rfc/rfc1939.txt</A>
<LI>RFC 1985, SMTP Service Extension for Remote Message Queue Starting (ETRN). <A HREF="http://www.ietf.org/rfc/rfc1985.txt">http://www.ietf.org/rfc/rfc1985.txt</A>
<LI>RFC 1991, PGP Message Exchange Formats. <A HREF="http://www.ietf.org/rfc/rfc1991.txt">http://www.ietf.org/rfc/rfc1991.txt</A>
<LI>RFC 2015, MIME Security with Pretty Good Privacy.  (PGP). <A HREF="http://www.ietf.org/rfc/rfc2015.txt">http://www.ietf.org/rfc/rfc2015.txt</A>
<LI>RFC 2045, MIME Internet message bodies. <A HREF="http://www.ietf.org/rfc/rfc2045.txt">http://www.ietf.org/rfc/rfc2045.txt</A>
<LI>RFC 2046, MIME Media Types. <A HREF="http://www.ietf.org/rfc/rfc2046.txt">http://www.ietf.org/rfc/rfc2046.txt</A>
<LI>RFC 2047, MIME Headers. <A HREF="http://www.ietf.org/rfc/rfc2047.txt">http://www.ietf.org/rfc/rfc2047.txt</A>
<LI>RFC 2048, MIME Registration Procedures. <A HREF="http://www.ietf.org/rfc/rfc2048.txt">http://www.ietf.org/rfc/rfc2048.txt</A>
<LI>RFC 2049, MIME Conformance Criteria. <A HREF="http://www.ietf.org/rfc/rfc2049.txt">http://www.ietf.org/rfc/rfc2049.txt</A>
<LI>RFC 2142, Mailbox names for common services. <A HREF="http://www.ietf.org/rfc/rfc2142.txt">http://www.ietf.org/rfc/rfc2142.txt</A>
<LI>RFC 2183, Content Disposition header. <A HREF="http://www.ietf.org/rfc/rfc2183.txt">http://www.ietf.org/rfc/rfc2183.txt</A>
<LI>RFC 2821, Simple Mail Transfer Protocol. <A HREF="http://www.ietf.org/rfc/rfc2821.txt">http://www.ietf.org/rfc/rfc2821.txt</A>
<LI>RFC 2822, Internet Message Format <A HREF="http://www.ietf.org/rfc/rfc2822.txt">http://www.ietf.org/rfc/rfc2822.txt</A></UL>
<P>A comprehensive list of mail-related RFC's is available from the Internet Mail Consortium at <A HREF="http://www.imc.org/mail-standards.html">http://www.imc.org/mail-standards.html</A>.</P>
<HR>
<H1><A NAME="architecture-apdx">D. Architecture</A></H1>
<H2><A NAME="modular">D.1. Modular system architecture</A></H2>
<P>Internet MTA's perform a variety of tasks. Earlier designs like <I>Sendmail</I> and <I>smail</I> are <I>monolithic</I>. In other words, they have one large, complex program that &quot;switches hats&quot;: it puts on one hat to be an SMTP server, another to be an SMTP client, another to inject messages locally, another to manage the queue, etc.</P>
<P><I>qmail</I> is <I>modular</I>. Each of these functions is performed by a separate program. As a result, the programs are much smaller, simpler, and less likely to contain functional or security bugs. To further enhance security, <I>qmail</I>'s modules run with different privileges, and they don't &quot;trust&quot; each other: they don't assume the other modules always do only what they're supposed to do.</P>
<P>The core modules are:</P>
<TABLE CLASS="columns" BORDER>
<TR CLASS="heading">
<TD>
<STRONG>Modules</STRONG>
</TD>
<TD>
<STRONG>Function</STRONG>
</TD>
</TR>
<TR>
<TD>
<TT>qmail-smtpd</TT>
</TD>
<TD>
accepts/rejects messages via SMTP
</TD>
</TR>
<TR>
<TD>
<TT>qmail-inject</TT>
</TD>
<TD>
injects messages locally
</TD>
</TR>
<TR>
<TD>
<TT>qmail-rspawn</TT>/<TT>qmail-remote</TT>
</TD>
<TD>
handles remote deliveries
</TD>
</TR>
<TR>
<TD>
<TT>qmail-lspawn</TT>/<TT>qmail-local</TT>
</TD>
<TD>
handles local deliveries
</TD>
</TR>
<TR>
<TD>
<TT>qmail-send</TT>
</TD>
<TD>
processes the queue
</TD>
</TR>
<TR>
<TD>
<TT>qmail-clean</TT>
</TD>
<TD>
cleans the queue
</TD>
</TR>
</TABLE>

<P>There's also a down side to the modular approach. Unlike a monolithic MTA, the interactions between modules are well-defined, and modules only exchange the minimum necessary information with each other. This is generally A Good Thing, but sometimes it makes it hard to do things. For example, the <TT>sendmail</TT> &quot;-v&quot; flag causes <I>Sendmail</I> to print a trace of its actions to standard output for debugging purposes. Since the one <TT>sendmail</TT> binary handles injection, queueing, alias processing, <TT>.forward</TT> file processing, and remote forwarding via SMTP, it is able to easily trace the entire delivery until the message is delivered. The equivalent capability in <I>qmail</I> doesn't exist, and would require substantial code changes and additional complexity to implement the passing of the &quot;debug&quot; flag from module to module.</P>
<H2><A NAME="file-structure">D.2. File structure</A></H2>
<P><TT>/var/qmail</TT> is the root of the <I>qmail</I> file structure. This can be changed when <I>qmail</I> is being built, but it's a good idea to leave it unchanged so other administrators know where to find things. If you really want to relocate some or all of the <I>qmail</I> tree, it's better to do that using symbolic links. See the <A HREF="#create-dirs">Create directories</A> subsection of the Installation section for details.</P>
<P>The top-level subdirectories are:</P>
<TABLE CLASS="columns" BORDER>
<TR CLASS="heading">
<TD>
<STRONG>Directory</STRONG>
</TD>
<TD>
<STRONG>Contents</STRONG>
</TD>
</TR>
<TR>
<TD>
<TT>alias</TT>
</TD>
<TD>
<TT>.qmail</TT> files for system-wide aliases
</TD>
</TR>
<TR>
<TD>
<TT>bin</TT>
</TD>
<TD>
program binaries and scripts
</TD>
</TR>
<TR>
<TD>
<TT>boot</TT>
</TD>
<TD>
startup scripts
</TD>
</TR>
<TR>
<TD>
<TT>control</TT>
</TD>
<TD>
configuration files
</TD>
</TR>
<TR>
<TD>
<TT>doc</TT>
</TD>
<TD>
documentation (except man pages)
</TD>
</TR>
<TR>
<TD>
<TT>man</TT>
</TD>
<TD>
man pages
</TD>
</TR>
<TR>
<TD>
<TT>queue</TT>
</TD>
<TD>
the queue of unsent messages
</TD>
</TR>
<TR>
<TD>
<TT>users</TT>
</TD>
<TD>
the <TT>qmail-users</TT> database files
</TD>
</TR>
</TABLE>

<H2><A NAME="queue-structure">D.3. Queue structure</A></H2>
<P>The file <TT>INTERNALS</TT> in the build directory discusses the details of queueing more thoroughly. This is a broader overview of structure of the queue.</P>
<TABLE CLASS="columns" BORDER>
<TR CLASS="heading">
<TD>
<STRONG>Subdirectory</STRONG>
</TD>
<TD>
<STRONG>Contents</STRONG>
</TD>
</TR>
<TR>
<TD>
bounce
</TD>
<TD>
permanent delivery errors
</TD>
</TR>
<TR>
<TD>
info*
</TD>
<TD>
envelope sender addresses
</TD>
</TR>
<TR>
<TD>
intd
</TD>
<TD>
envelopes under construction by <TT>qmail-queue</TT>
</TD>
</TR>
<TR>
<TD>
local*
</TD>
<TD>
local envelope recipient addresses
</TD>
</TR>
<TR>
<TD>
lock
</TD>
<TD>
lock files
</TD>
</TR>
<TR>
<TD>
mess*
</TD>
<TD>
message files
</TD>
</TR>
<TR>
<TD>
pid
</TD>
<TD>
used by <TT>qmail-queue</TT> to acquire an i-node number
</TD>
</TR>
<TR>
<TD>
remote*
</TD>
<TD>
remote envelope recipient addresses
</TD>
</TR>
<TR>
<TD>
todo
</TD>
<TD>
complete envelopes
</TD>
</TR>
</TABLE>

<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG>Directories marked with an &quot;*&quot; contain a series of <I>split</I> subdirectories named &quot;0&quot;, &quot;1&quot;, ..., up to (<I>conf-split</I>-1), where <I>conf-split</I> is a compile-time configuration setting contained in the file <TT>conf-split</TT> in the build directory. It defaults to 23. The purpose of splitting these directories is to reduce the number of files in a single directory on very busy servers. <I>conf-split</I> must be a prime number.
<HR WIDTH="80%" ALIGN="Left"></P>
<P>Files under the <TT>mess</TT> subdirectory are named after their i-node number. What this means is that you can't manually move them using standard UNIX utilities like <TT>mv</TT>, <TT>dump</TT>/<TT>restore</TT>, and <TT>tar</TT>. There are a couple user-contributed utilities on <A HREF="http://www.qmail.org/">http://www.qmail.org/</A> that will rename queue files correctly.</P>
<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG><B>It is not safe to modify queue files while <I>qmail</I> is running</B>. If you want to modify the queue, stop <I>qmail</I> first, play with the queue <I>carefully</I>, then restart <I>qmail</I>.
<HR WIDTH="80%" ALIGN="Left"></P>
<H2><A NAME="pictures">D.4. Pictures</A></H2>
<P>There is a series of files in <TT>/var/qmail/doc</TT> with names starting with <TT>PIC</TT>. These are textual &quot;pictures&quot; of various situations that <I>qmail</I> handles. They show the flow of control through the various modules, and are very helpful for debugging and creating complex configurations.</P>
<TABLE CLASS="columns" BORDER>
<TR CLASS="heading">
<TD>
<STRONG>Filename</STRONG>
</TD>
<TD>
<STRONG>Scenario</STRONG>
</TD>
</TR>
<TR>
<TD>
PIC.local2alias
</TD>
<TD>
locally-injected message delivered to a local alias
</TD>
</TR>
<TR>
<TD>
PIC.local2ext
</TD>
<TD>
locally-injected message delivered to an extension address
</TD>
</TR>
<TR>
<TD>
PIC.local2local
</TD>
<TD>
locally-injected message delivered to a local user
</TD>
</TR>
<TR>
<TD>
PIC.local2rem
</TD>
<TD>
locally-injected message delivered to a remote address
</TD>
</TR>
<TR>
<TD>
PIC.local2virt
</TD>
<TD>
locally-injected message delivered to an address on a local virtual domain
</TD>
</TR>
<TR>
<TD>
PIC.nullclient
</TD>
<TD>
a message injected on a null client
</TD>
</TR>
<TR>
<TD>
PIC.relaybad
</TD>
<TD>
a failed attempt to use the local host as a relay
</TD>
</TR>
<TR>
<TD>
PIC.relaygood
</TD>
<TD>
a successful attempt to use the local host as a relay
</TD>
</TR>
<TR>
<TD>
PIC.rem2local
</TD>
<TD>
a message received via SMTP for a local user
</TD>
</TR>
</TABLE>

<P>These files are also available on-line from:</P>
<UL>
<LI><A HREF="http://www.qmail.org/man/index.html">http://www.qmail.org/man/index.html</A></UL>
<P>If you want <I>real</I> pictures of <I>qmail</I>, check out Andre Opperman's &quot;big qmail picture&quot; at <A HREF="http://www.nrg4u.com/">http://www.nrg4u.com/</A>.</P>
<HR>
<H1><A NAME="IAQ">E. Infrequently Asked Questions</A></H1>
<P>These are questions that don't qualify as <I>frequently</I> asked, but which are important and not easy to answer.</P>
<H2><A NAME="retry-schedule">E.1. How frequently does qmail try to send deferred messages?</A></H2>
<P>Each message has its own retry schedule. The longer a message remains undeliverable, the less frequently <I>qmail</I> tries to send it. The retry schedule is not configurable. The following table shows the retry schedule for a message that's undeliverable to a remote recipient until it bounces. Local messages use a similar, but more frequent, schedule.</P>
<TABLE CLASS="columns" BORDER>
<TR CLASS="heading">
<TD ALIGN='Center'>
<STRONG>Delivery Attempt</STRONG>
</TD>
<TD ALIGN='Right'>
<STRONG>Seconds</STRONG>
</TD>
<TD ALIGN='Right'>
<STRONG>D-HH:MM:SS</STRONG>
</TD>
</TR>
<TR>
<TD ALIGN='Center'>
1
</TD>
<TD ALIGN='Right'>
0
</TD>
<TD ALIGN='Right'>
0-00:00:00
</TD>
</TR>
<TR>
<TD ALIGN='Center'>
2
</TD>
<TD ALIGN='Right'>
400
</TD>
<TD ALIGN='Right'>
0-00:06:40
</TD>
</TR>
<TR>
<TD ALIGN='Center'>
3
</TD>
<TD ALIGN='Right'>
1600
</TD>
<TD ALIGN='Right'>
0-00:26:40
</TD>
</TR>
<TR>
<TD ALIGN='Center'>
4
</TD>
<TD ALIGN='Right'>
3600
</TD>
<TD ALIGN='Right'>
0-01:00:00
</TD>
</TR>
<TR>
<TD ALIGN='Center'>
5
</TD>
<TD ALIGN='Right'>
6400
</TD>
<TD ALIGN='Right'>
0-01:46:40
</TD>
</TR>
<TR>
<TD ALIGN='Center'>
6
</TD>
<TD ALIGN='Right'>
10000
</TD>
<TD ALIGN='Right'>
0-02:46:40
</TD>
</TR>
<TR>
<TD ALIGN='Center'>
7
</TD>
<TD ALIGN='Right'>
14400
</TD>
<TD ALIGN='Right'>
0-04:00:00
</TD>
</TR>
<TR>
<TD ALIGN='Center'>
8
</TD>
<TD ALIGN='Right'>
19600
</TD>
<TD ALIGN='Right'>
0-05:26:40
</TD>
</TR>
<TR>
<TD ALIGN='Center'>
9
</TD>
<TD ALIGN='Right'>
25600
</TD>
<TD ALIGN='Right'>
0-07:06:40
</TD>
</TR>
<TR>
<TD ALIGN='Center'>
10
</TD>
<TD ALIGN='Right'>
32400
</TD>
<TD ALIGN='Right'>
0-09:00:00
</TD>
</TR>
<TR>
<TD ALIGN='Center'>
11
</TD>
<TD ALIGN='Right'>
40000
</TD>
<TD ALIGN='Right'>
0-11:06:40
</TD>
</TR>
<TR>
<TD ALIGN='Center'>
12
</TD>
<TD ALIGN='Right'>
48400
</TD>
<TD ALIGN='Right'>
0-13:26:40
</TD>
</TR>
<TR>
<TD ALIGN='Center'>
13
</TD>
<TD ALIGN='Right'>
57600
</TD>
<TD ALIGN='Right'>
0-16:00:00
</TD>
</TR>
<TR>
<TD ALIGN='Center'>
14
</TD>
<TD ALIGN='Right'>
67600
</TD>
<TD ALIGN='Right'>
0-18:46:40
</TD>
</TR>
<TR>
<TD ALIGN='Center'>
15
</TD>
<TD ALIGN='Right'>
78400
</TD>
<TD ALIGN='Right'>
0-21:46:40
</TD>
</TR>
<TR>
<TD ALIGN='Center'>
16
</TD>
<TD ALIGN='Right'>
90000
</TD>
<TD ALIGN='Right'>
1-01:00:00
</TD>
</TR>
<TR>
<TD ALIGN='Center'>
17
</TD>
<TD ALIGN='Right'>
102400
</TD>
<TD ALIGN='Right'>
1-04:26:40
</TD>
</TR>
<TR>
<TD ALIGN='Center'>
18
</TD>
<TD ALIGN='Right'>
115600
</TD>
<TD ALIGN='Right'>
1-08:06:40
</TD>
</TR>
<TR>
<TD ALIGN='Center'>
19
</TD>
<TD ALIGN='Right'>
129600
</TD>
<TD ALIGN='Right'>
1-12:00:00
</TD>
</TR>
<TR>
<TD ALIGN='Center'>
20
</TD>
<TD ALIGN='Right'>
144400
</TD>
<TD ALIGN='Right'>
1-16:06:40
</TD>
</TR>
<TR>
<TD ALIGN='Center'>
21
</TD>
<TD ALIGN='Right'>
160000
</TD>
<TD ALIGN='Right'>
1-20:26:40
</TD>
</TR>
<TR>
<TD ALIGN='Center'>
22
</TD>
<TD ALIGN='Right'>
176400
</TD>
<TD ALIGN='Right'>
2-01:00:00
</TD>
</TR>
<TR>
<TD ALIGN='Center'>
23
</TD>
<TD ALIGN='Right'>
193600
</TD>
<TD ALIGN='Right'>
2-05:46:40
</TD>
</TR>
<TR>
<TD ALIGN='Center'>
24
</TD>
<TD ALIGN='Right'>
211600
</TD>
<TD ALIGN='Right'>
2-10:46:40
</TD>
</TR>
<TR>
<TD ALIGN='Center'>
25
</TD>
<TD ALIGN='Right'>
230400
</TD>
<TD ALIGN='Right'>
2-16:00:00
</TD>
</TR>
<TR>
<TD ALIGN='Center'>
26
</TD>
<TD ALIGN='Right'>
250000
</TD>
<TD ALIGN='Right'>
2-21:26:40
</TD>
</TR>
<TR>
<TD ALIGN='Center'>
27
</TD>
<TD ALIGN='Right'>
270400
</TD>
<TD ALIGN='Right'>
3-03:06:40
</TD>
</TR>
<TR>
<TD ALIGN='Center'>
28
</TD>
<TD ALIGN='Right'>
291600
</TD>
<TD ALIGN='Right'>
3-09:00:00
</TD>
</TR>
<TR>
<TD ALIGN='Center'>
29
</TD>
<TD ALIGN='Right'>
313600
</TD>
<TD ALIGN='Right'>
3-15:06:40
</TD>
</TR>
<TR>
<TD ALIGN='Center'>
30
</TD>
<TD ALIGN='Right'>
336400
</TD>
<TD ALIGN='Right'>
3-21:26:40
</TD>
</TR>
<TR>
<TD ALIGN='Center'>
31
</TD>
<TD ALIGN='Right'>
360000
</TD>
<TD ALIGN='Right'>
4-04:00:00
</TD>
</TR>
<TR>
<TD ALIGN='Center'>
32
</TD>
<TD ALIGN='Right'>
384400
</TD>
<TD ALIGN='Right'>
4-10:46:40
</TD>
</TR>
<TR>
<TD ALIGN='Center'>
33
</TD>
<TD ALIGN='Right'>
409600
</TD>
<TD ALIGN='Right'>
4-17:46:40
</TD>
</TR>
<TR>
<TD ALIGN='Center'>
34
</TD>
<TD ALIGN='Right'>
435600
</TD>
<TD ALIGN='Right'>
5-01:00:00
</TD>
</TR>
<TR>
<TD ALIGN='Center'>
35
</TD>
<TD ALIGN='Right'>
462400
</TD>
<TD ALIGN='Right'>
5-08:26:40
</TD>
</TR>
<TR>
<TD ALIGN='Center'>
36
</TD>
<TD ALIGN='Right'>
490000
</TD>
<TD ALIGN='Right'>
5-16:06:40
</TD>
</TR>
<TR>
<TD ALIGN='Center'>
37
</TD>
<TD ALIGN='Right'>
518400
</TD>
<TD ALIGN='Right'>
6-00:00:00
</TD>
</TR>
<TR>
<TD ALIGN='Center'>
38
</TD>
<TD ALIGN='Right'>
547600
</TD>
<TD ALIGN='Right'>
6-08:06:40
</TD>
</TR>
<TR>
<TD ALIGN='Center'>
39
</TD>
<TD ALIGN='Right'>
577600
</TD>
<TD ALIGN='Right'>
6-16:26:40
</TD>
</TR>
<TR>
<TD ALIGN='Center'>
40
</TD>
<TD ALIGN='Right'>
608400
</TD>
<TD ALIGN='Right'>
7-01:00:00
</TD>
</TR>
</TABLE>

<H2><A NAME="dns-problem">E.2. Why can't I send mail to a large site with lots of MX's?</A></H2>
<P>If you're getting:</P>
<PRE>
deferral: CNAME_lookup_failed_temporarily._(#4.4.3)/
</PRE>
<P>The problem might be that <I>qmail</I> can't handle large name server query responses. The fix is to install a patch or workaround. See <A HREF="#dns-patches">Patches</A> under Advanced Topics.</P>
<P>There's also a question as to why some people <I>don't</I> have trouble reaching such systems. Basically, depending on the timing and ordering of queries made to your local nameserver, the size of the response to an <TT>ANY</TT> query for &quot;aol.com&quot; may be larger than the 512 byte limit of a UDP packet, or it may not.</P>
<P>&quot;May not&quot; is likely to happen if the A and MX records time out, but the NS records don't. Since the .COM servers set a 2 day TTL on those, but AOL sets a 1 hour TTL on their records, this will often happen on less busy nameservers. Busier nameservers are more likely to have those records in their cache at any given time, frustrating an unpatched <I>qmail</I>'s attempts to check for CNAMEs.</P>
<P>A better test is to send mail to <TT>nosuchuser@large-mx.ckdhr.com</TT>; if it clears your queue and winds up bouncing from ckdhr.com, your MTA can send mail to hosts with MX lists that exceed 512 bytes. (By using a single RRset, with a single TTL, that exceeds 512 bytes, the problem can be seen without depending on the timing and ordering of other queries.)</P>
<H2><A NAME="queue_extra">E.3. What is <TT>QUEUE_EXTRA</TT>?</A></H2>
<P><TT>QUEUE_EXTRA</TT> is a compile-time configuration variable that specifies an additional recipient that will be added to every delivery. This is used primarily for logging. E.g., the FAQ describes how to use <TT>QUEUE_EXTRA</TT> to keep copies of all incoming and outgoing messages.</P>
<P>To use <TT>QUEUE_EXTRA</TT>, edit <TT>extra.h</TT> specifying the additional recipient in the format <TT>&quot;T<I>recipient</I>\0&quot;</TT>, and the length of the <TT>QUEUE_EXTRA</TT> string in <TT>QUEUE_EXTRALEN</TT> (the &quot;\0&quot; counts as one character). For example:</P>
<PRE>
    #define QUEUE_EXTRA &quot;Tlog\0&quot;
    #define QUEUE_EXTRALEN 5
</PRE>
<P>Shut down <I>qmail</I> if it's running. If you installed the <TT>qmailctl</TT> script from the Installation section, that can be done by:</P>
<PRE>
    qmailctl stop
</PRE>
<P>If you don't have the <TT>qmailctl</TT> script, you should use your startup/shutdown script or send <TT>qmail-send</TT> a <TT>TERM</TT> signal.</P>
<P>Then rebuild <I>qmail</I> using:</P>
<PRE>
    make setup check
</PRE>
<P>Populate <TT>~alias/.qmail-log</TT> with whatever logging you want. E.g., to log Message-ID's:</P>
<PRE>
    | awk '/^$/ { exit } /^[mM][eE][sS][sS][aA][gG][eE]-/ { print }'
</PRE>
<P>Finally, restart <I>qmail</I>.</P>
<HR>
<H1><A NAME="error-messages">F. Error Messages</A></H1>
<P><I>qmail</I> error messages and what they mean.</P>
<P>See <A HREF="#rfcs">RFC 1893</A> for an explanation of the error codes in parentheses.</P>
<P><I>This appendix is incomplete.</I></P>
<HR>
<H1><A NAME="gotchas">G. Gotchas</A></H1>
<P>These &quot;gotchas&quot; frequently cause problems for <I>qmail</I> newbies.</P>
<H2><A NAME="root-delivery">G.1. <I>qmail</I> doesn't deliver mail to superusers.</A></H2>
<P>To prevent the possibility of <TT>qmail-local</TT> running commands as a privileged user, <I>qmail</I> ignores all users whose UID is 0. This is documented in the <TT>qmail-getpw</TT> man page.</P>
<P>That doesn't mean <I>qmail</I> won't deliver to <TT>root</TT>, it just means that such a delivery will have to be handled by a non-privileged user. Typically, one creates an alias for root by populating <TT>~alias/.qmail-root</TT>.</P>
<H2><A NAME="home-dir-ownership">G.2. <I>qmail</I> doesn't deliver mail to users who don't own their home directory.</A></H2>
<P>Another security feature, and just good general practice. This is documented in the <TT>qmail-getpw</TT> man page.</P>
<H2><A NAME="uppercase-usernames">G.3. <I>qmail</I> doesn't deliver mail to users whose usernames contain uppercase letters.</A></H2>
<P><I>qmail</I> converts the entire &quot;local part&quot;--everything left of the &quot;@&quot; in an address, to lowercase. The man page doesn't come out and say that, but the code does. The fact that it ignores users with uppercase characters is documented in the <TT>qmail-getpw</TT> man page.</P>
<H2><A NAME="dots-in-extensions">G.4. <I>qmail</I> replaces dots (.) in extension addresses with colons (:).</A></H2>
<P>Another security feature. The purpose is prevent extension addresses from backing up the file tree using &quot;..&quot;. By replacing them with colons, <I>qmail</I> ensures that all <TT>.qmail</TT> files for a user are under their home directory. Documented in the <TT>dot-qmail</TT> man page.</P>
<H2><A NAME="uppercase-in-extensions">G.5. <I>qmail</I> converts uppercase characters in extension addresses to lowercase.</A></H2>
<P>This is another result of the fact that <I>qmail</I> lowercases the entire local part of addresses. Documented in the <TT>dot-qmail</TT> man page.</P>
<H2><A NAME="etc-hosts">G.6. <I>qmail</I> doesn't use <TT>/etc/hosts</TT>.</A></H2>
<P><I>qmail</I> <B>never</B> uses <TT>/etc/hosts</TT> to determine the IP address associated with a host name. If you use names in control files, <I>qmail</I> must have access to a name server.</P>
<P>It <I>is</I> possible to run <I>qmail</I> on systems without access to a name server, though. Hosts in control files can be specified by IP address by enclosing them in square brackets ([]), e.g.:</P>
<PRE>
    [10.1.2.219]
</PRE>
<P>Actually, the square brackets aren't <I>always</I> necessary--but it's a good idea to use them anyway.</P>
<H2><A NAME="no-smtp-logging">G.7. <I>qmail</I> doesn't log SMTP activity.</A></H2>
<P>For a number of reasons, <I>qmail</I> doesn't log SMTP connections, rejections, invalid commands, or valid commands. <TT>tcpserver</TT> can be used to log connections, and <TT>recordio</TT> can be used to log the entire SMTP dialogue. <TT>recordio</TT> is part of the <I><A HREF="#ucspi-tcp">ucspi-tcp</A></I> package. The procedure is documented in the FAQ at <A HREF="http://cr.yp.to/qmail/faq/servers.html#recordio">http://cr.yp.to/qmail/faq/servers.html#recordio</A>.</P>
<H2><A NAME="deferral-notices">G.8. <I>qmail</I> doesn't generate deferral notices.</A></H2>
<P>If <I>Sendmail</I> is unable to deliver a message within a few hours, typically four, it sends a deferral notice to the originator. These notices look like bounce messages, but don't indicate that the delivery has failed permanently, yet.</P>
<P><I>qmail</I> doesn't send such warnings. An undeliverable message will only be returned to the originator after it spends <A HREF="#queuelifetime"></A><TT>queuelifetime</TT> in the queue.</P>
<H2><A NAME="trigger">G.9. <I>qmail</I> is slow if <TT>/var/qmail/queue/lock/trigger</TT> is gone/has the wrong permissions/is a regular file.</A></H2>
<P><TT>qmail-queue</TT> and <TT>qmail-send</TT> communicate via a named pipe called <TT>/var/qmail/queue/lock/trigger</TT>. If this pipe gets messed up, <TT>qmail-send</TT> doesn't notice new messages for a half hour or so.</P>
<P>The best way to ensure that it's set up right is to run &quot;make check&quot; from the source directory. If that's not possible, make sure it looks like:</P>
<PRE>
# ls -l /var/qmail/queue/lock/trigger
prw--w--w-   1 qmails   qmail           0 Jul  5 21:25 /var/qmail/queue/lock/trigger
</PRE>
<P>Pay particular attention to the &quot;p&quot; at the beginning of the line (says it's a named pipe), the mode (especially world writable), and the owner/group.</P>
<H2><A NAME="smtp-slow">G.10. DNS or IDENT lookups can make SMTP slow.</A></H2>
<P>If <TT>qmail-smtpd</TT> is slow to respond to connections, the problem is probably due to DNS reverse lookups or IDENT lookups. If you're starting <TT>qmail-smtpd</TT> with <TT>tcpserver</TT>, remove the &quot;-h&quot;, &quot;-p&quot;, and &quot;-r&quot; options and add &quot;-H&quot;, &quot;-P&quot;, &quot;-R&quot;, and &quot;-l <I>hostname</I>&quot;.</P>
<P>See the <TT>tcpserver</TT> documentation at <A HREF="http://cr.yp.to/ucspi-tcp/tcpserver.html">http://cr.yp.to/ucspi-tcp/tcpserver.html</A> for an explanation of these options.</P>
<H2><A NAME="cr">G.11. Carriage Return/Linefeed (CRLF) line breaks don't work.</A></H2>
<P><TT>qmail-inject</TT> and other local injection mechanisms like <TT>sendmail</TT> don't work right when messages are injected with DOS-style carriage return/linefeed (CRLF) line breaks. Unlike <I>Sendmail</I>, <I>qmail</I> requires locally-injected messages to use Unix newlines (LF only). This is a common problem with PHP scripts.</P>
<H2><A NAME="log-block">G.12. <TT>qmail-send</TT> or <TT>tcpserver</TT> stop working if logs back up.</A></H2>
<P>If you're logging to a supervised log service, as described in section 2, and the log service fails for any reason: disk full, typo in the <TT>run</TT> script, log directory configuration error, etc., the pipeline will eventually fill up, causing the service to block, or hang. Fix the problem (see <A HREF="#troubleshooting">Troubleshooting</A>) and everything will return to normal.</P>
<H2><A NAME="smtp-rejection">G.13. <TT>qmail-smtpd</TT> doesn't validate the local part of an address.</A></H2>
<P>If <TT>example.com</TT> is listed in <TT>control/rcpthosts</TT>, mail to <TT><I>anything</I>@example.com</TT> will be accepted during the SMTP session. If <TT><I>anything</I></TT> isn't a valid user or alias, <I>qmail</I> will send a bounce message to the envelope sender address.</P>
<P>Some simpleminded relaying tests assume that if a message is accepted, it will be delivered. That's wrong. If someone claims that your system is an open relay, demand to see a copy of message relayed through it--including the complete header, especially the Received fields--then compare them with your logs.</P>
<P>See the <A HREF="#smtp-reject">Rejecting Invalid Recipients During SMTP Dialogue</A> section for information about ways to add recipient validation to <I>qmail</I>.</P>
<H2><A NAME="firewalls">G.14. Firewalls can block remote access to your SMTP/POP3/IMAP server.</A></H2>
<P>If you've installed an SMTP, POP3, or IMAP server, and you can connect to it from the local host or a host on the local network, but not from a remote host, a firewall might be the problem.</P>
<P>The first place to look is on the server itself. Red Hat Linux, for example, blocks SMTP in the default configuration using <TT>iptables</TT>. Other packet filtering mechanisms such as <TT>ipchains</TT> may also be responsible.</P>
<P>It's also possible that your Internet Service Provider (ISP) blocks certain ports to prevent spamming or enforce their Terms of Service (TOS). Contact your ISP's tech support <I>after</I> ensuring that packet filtering isn't responsible and that running a server doesn't violate your TOS.</P>
<H2><A NAME="anonymous">G.15. <TT>qmail-inject</TT> sets <TT>From</TT> field to <TT>anonymous</TT> if <TT>USER</TT> and <TT>LOGNAME</TT> aren't set.</A></H2>
<P>If a message sent via <TT>qmail-inject</TT> doesn't contain a <TT>From</TT> field, <TT>qmail-inject</TT> looks for environment variables to tell it which user is sending the message. The variables it looks for, in order, are: <TT>QMAILUSER</TT>, <TT>MAILUSER</TT>, <TT>USER</TT>,  and  <TT>LOGNAME</TT>,</P>
<P>Normal user login sessions usually set one or both of <TT>USER</TT> and <TT>LOGNAME</TT>, but some batch jobs, such as those started by <TT>cron</TT> might not have either of these set.</P>
<P>To cause your <TT>cron</TT> jobs to have a valid <TT>From</TT> field, set one these environment variables before sending any mail messages.</P>
<H2><A NAME="killing-qmail-send">G.16. <TT>qmail-send</TT> doesn't always exit immediately when killed.</A></H2>
<P>Sending <TT>qmail-send</TT> a <TT>TERM</TT> signal doesn't cause it to exit immediately if there are deliveries in progress. <TT>qmail-send</TT> will wait for all <TT>qmail-local</TT> and <TT>qmail-remote</TT> processes to finish before it exits so it can record the results of these deliveries. Because of this, &quot;<TT>qmailctl restart</TT>&quot; or &quot;<TT>qmailctl stop</TT>&quot; might report that <TT>qmail-send</TT> has been stopped, even though it's still running. Always run &quot;<TT>qmailctl stat</TT>&quot; to verify that the stop or restart has actually completed.</P>
<P>Also note that <TT>qmail-send</TT> makes a pass through the queue before exiting, so with very large queues this can cause a noticeable delay.</P>
<H2><A NAME="throwing-messages-away">G.17. Delivering to <TT>/dev/null</TT> doesn't throw messages away.</A></H2>
<P>A delivery instruction like:</P>
<PRE>
  /dev/null
</PRE>
<P>Causes <I>qmail</I> to think that <TT>/dev/null</TT> is an mbox mailbox, but since <TT>/dev/null</TT> is a special file, <I>qmail</I> can't deliver to it successfully.</P>
<P>The best was to throw messages away is to create a <TT>.qmail</TT> file that contains no valid delivery instructions <I>but</I> isn't empty. (Empty <TT>.qmail</TT> files are treated as if they contain the default delivery instructions specified in <TT>defaultdelivery</TT> or on the <TT>qmail-start</TT> command line.) This is accomplished by populating the file with nothing but comments.</P>
<P>For example, a <TT>.qmail</TT> file containing only:</P>
<PRE>
  #
</PRE>
<P>or:</P>
<PRE>
  # throw messages away undelivered
</PRE>
<P>will efficiently throw messages away without delivering them.</P>
<H2><A NAME="modifying-queue">G.18. Modifying the queue while <TT>qmail-send</TT> is running is <I>dangerous</I>.</A></H2>
<P>Modifying any of the files or directories under <TT>/var/qmail/queue</TT> while <TT>qmail-send</TT> is running without knowing <B>exactly</B> what you're doing is likely to result in a corrupt queue--e.g., messages in an undefined state, bizarre error messages in the logs, duplicate deliveries, bogus bounces, etc. Once this happens, you'll have to find and run a queue checking utility (there are a couple listed on qmail.org) or create a new, empty queue.</P>
<P>If you want to modify the queue, stop <I>qmail</I> first, play with the queue carefully, then restart <I>qmail</I>. Note that corruption is still possible with <TT>qmail-send</TT> stopped, so you still have to know what you're doing.</P>
<HR>
<H1><A NAME="lwq-faq">H. Frequently Asked Questions about <U>Life with qmail</U></A></H1>
<H2><A NAME="lwq-version">H.1. What version is <U>Life with qmail</U>?</A></H2>
<P>This is LWQ version 2007-11-30.</P>
<H2><A NAME="lwq-copyright">H.2. Who owns <U>Life with qmail</U>?</A></H2>
<P><U>Life with qmail</U> is Copyright 1999-2007 David E. Sill</P>
<P><A HREF="http://Web.InfoAve.Net/~dsill/dave/">http://Web.InfoAve.Net/~dsill/dave/</A></P>
<H2><A NAME="lwq-license">H.3. How is <U>Life with qmail</U> licensed?</A></H2>
<P><U>Life with qmail</U> is covered by the OpenContent License, version 1.0. See <A HREF="http://www.opencontent.org/opl.shtml">http://www.opencontent.org/opl.shtml</A> for the full license. Basically, you can copy, redistribute, or modify <U>Life with qmail</U> provided that modified versions, if redistributed, are also covered by the OpenContent License.</P>
<H2><A NAME="lwq-announce-list">H.4. How can I be notified when new releases of LWQ are made available?</A></H2>
<P>Join the <TT>lwq-announce</TT> mailing list by sending a message to <A HREF="mailto:lwq-announce-subscribe@sws1.ctd.ornl.gov">lwq-announce-subscribe@sws1.ctd.ornl.gov</A>.</P>
<H2><A NAME="lwq-list">H.5. Where can LWQ contributors and fans talk about it?</A></H2>
<P>Join the <TT>lwq</TT> mailing list by sending a message to <A HREF="mailto:lwq-subscribe@sws1.ctd.ornl.gov">lwq-subscribe@sws1.ctd.ornl.gov</A>.</P>
<H2><A NAME="lwq-translations">H.6. Has <U>Life with qmail</U> been translated to <I>language</I>?</A></H2>
<P>Maybe. LWQ has been translated into a few languages. See <A HREF="http://lifewithqmail.org/trans.html">http://lifewithqmail.org/trans.html</A> for more information about LWQ translations.</P>
<H2><A NAME="lwq-formats">H.7. Is <U>Life with qmail</U> available in PostScript, PDF, plain text, or any other format beside HTML?</A></H2>
<P>Yes, alternative formats can be found at <A HREF="http://lifewithqmail.org/">http://lifewithqmail.org/</A>.</P>
<H2><A NAME="lwq-warranty">H.8. I used <U>Life with qmail</U> and it crashed my system/erased my hard disk/ruined my love life/killed my dog/etc.</A></H2>
<P>I'm sorry. Really sorry. But <U>Life with qmail</U> comes with no warranty. See the OpenContent License mentioned above. I didn't get paid to write it, I just wanted to contribute something useful to the <I>qmail</I> community.</P>
<P>Actually, this isn't a FAQ. In fact, I hope it's a NAQ (Never Asked Question).</P>
<H2><A NAME="contributions">H.9. How can I contribute to LWQ?</A></H2>
<P>Please send corrections, suggestions, complaints, etc. to <A HREF="mailto:lwq@sill.org">lwq@sill.org</A>.</P>
<P>If you'd like to make a larger contribution, such as a new subsection or appendix, that's great! You might want to check with me first to make sure the topic is something I want to cover in LWQ and that nobody else is already working on it.</P>
<P>Another way to support LWQ is to shop at my bookstore, in association with Amazon.com, using this link: <A HREF="http://www.amazon.com/exec/obidos/redirect-home/davesill">http://www.amazon.com/exec/obidos/redirect-home/davesill</A>.</P>
<P>Thanks for your support!</P>
<H2><A NAME="changes">H.10. What's changed in this version of LWQ?</A></H2>
<UL>
<LI>Updated for netqmail 1.06.
<LI>Added info for Wheeler book.
<LI>Fixed various typos.
<LI>Fixed some dead links.</UL>
<H3><A NAME="2006-01-02">H.10.1. What changed in the 2006-01-02 version of LWQ?</A></H3>
<UL>
<LI>Lots of minor tweaks, fixed dead links, etc.
<LI>/dev/null gotcha added. Thanks to Payal Rathod.
<LI>Expanded <TT>nosuid</TT> warning. Thanks to Tony Hansmann.
<LI>Added link to Cazabon's nodefaultrbl patch. Thanks to Jeremy Kister.
<LI>Added mkdirs to qmail-pop3d instructions. Thanks to Larry Weldon.
<LI>Added note about errno patch for checkpasswd. Thanks to tlad.
<LI>Added smarthost relay subsection. Thanks to the Silver Dirk.
<LI>Improved Qmail-Scanner wording. Thanks to Jason Haar.
<LI>Added a section for Yenigul's book. Thanks to Ismail Yenigul.
<LI>Added abuse@ alias. Thanks to Charles Cazabon.
<LI>Added ucspi-tls section. Thanks to Scott Gifford.
<LI>Added queue modification gotcha.</UL>
<H3><A NAME="2004-06-30">H.10.2. What changed in the 2004-06-30 version of LWQ?</A></H3>
<UL>
<LI>Incorporated new <I>qmail</I> logo. Thanks to Michael Kadrie.
<LI>Fixed various typos.
<LI>Updated Macintosh OS X note.
<LI>Updated ClamAV link.
<LI>Added recipient validation section to Advanced Topics.
<LI>Fixed &quot;setuid/exe required for queue filesystem&quot; wording.</UL>
<H3><A NAME="2004-03-28">H.10.3. What changed in the 2004-03-28 version of LWQ?</A></H3>
<UL>
<LI>Updated info for Levine book.
<LI>Fixed typo in &quot;What changed in the 2004-03-01 version of LWQ?&quot;.
<LI>Added comment in G.16 about <TT>qmail-send</TT> scanning the queue before exiting.</UL>
<H3><A NAME="2004-03-01">H.10.4. What changed in the 2004-03-01 version of LWQ?</A></H3>
<UL>
<LI>G.16 said &quot;KILL&quot;, should have been &quot;TERM&quot;.
<LI>Added softlimit-too-low example error message.
<LI>Fixed E.2, CNAME lookup problem.</UL>
<H3><A NAME="2004-01-26">H.10.5. What changed in the 2004-01-26 version of LWQ?</A></H3>
<UL>
<LI>Updated for netqmail 1.05.
<LI>Fixed minor typos.</UL>
<H3><A NAME="2003-11-10">H.10.6. What changed in the 2003-11-10 version of LWQ?</A></H3>
<UL>
<LI>Fixed minor typos.</UL>
<H3><A NAME="2003-10-30">H.10.7. What changed in the 2003-10-30 version of LWQ?</A></H3>
<UL>
<LI>Adjusted installation for <I>netqmail</I> distribution.
<LI>Updated Binc IMAP entry.</UL>
<H3><A NAME="2003-08-16">H.10.8. What changed in the 2003-08-16 version of LWQ?</A></H3>
<UL>
<LI>Added this change log section. Thanks to Jerry Asher for requesting it.
<LI>Added note about noexec and nosuid to system requirements section.
<LI>Added link to inst_check and examples to the testing section.
<LI>Added link to Mate Wierdl's errno patches to the patch section.
<LI>Added OS X note to system requirements section.
<LI>Added Cyrus entry to IMAP server section. Thanks to Rick Updegrove.
<LI>Added Dovecot entry to IMAP server section.
<LI>Reworded part of the entension section. Thanks to Adrian Ho.
<LI>Reformatted the POP run scripts for easier copying and pasting. Thanks to Woody Preston.
<LI>Fixed a typo in the section on Chuck Foster's DNS patch. Thanks to Josh Parreco.
<LI>Fixed a couple typos in the QMTP section. Thanks to Marek Gutkowski.</UL>
<a href="http://www.opencontent.org/"> <img
src="http://www.opencontent.org/takeone.gif" border=0 alt="Take One!"></a>
</DIV>
<DIV CLASS="footer">
<DIV CLASS="navigate">
</DIV>
</DIV>

</BODY>
</HTML>
